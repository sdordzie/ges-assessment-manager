<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>GES Assessment Manager â€“ NaCCA Â· Firebase Edition</title>
<meta name="theme-color" content="#006B3F"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="GES Assess"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, sendPasswordResetEmail }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc,
  collection, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ”¥ FIREBASE CONFIG â€” Replace with YOUR project credentials
//  Setup guide is inside the app under âš™ï¸ Firebase Setup
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCCdqvewNQUpjjrl6vmvgYy1QH0LdQ78KA",
  authDomain: "ges-assessment-gh.firebaseapp.com",
  projectId: "ges-assessment-gh",
  storageBucket: "ges-assessment-gh.firebasestorage.app",
  messagingSenderId: "122255207351",
  appId: "1:122255207351:web:72fc3a66166e4380951632"
};

// Check if configured
const IS_CONFIGURED = !FIREBASE_CONFIG.apiKey.includes("YOUR_");

let app, auth, db;
if (IS_CONFIGURED) {
  app = initializeApp(FIREBASE_CONFIG);
  auth = getAuth(app);
  db = getFirestore(app);
}

// â”€â”€ Expose to global scope â”€â”€
window.FB = { auth, db, IS_CONFIGURED,
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, sendPasswordResetEmail,
  doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc,
  collection, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch
};

// Boot app after Firebase loads
window.addEventListener('DOMContentLoaded', () => { window.initApp && window.initApp(); });
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GES NaCCA Assessment Manager â€” Mobile-First Design v4
   Ghana national colours Â· Refined dark UI Â· Touch-ready
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ FONTS â”€â”€ */
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap');

/* â”€â”€ DESIGN TOKENS â”€â”€ */
:root {
  --gh-green:  #006B3F;
  --gh-gold:   #FCD116;
  --gh-red:    #CE1126;
  --accent:    #00A86B;
  --accent2:   #00D084;

  --dark:      #070E17;
  --dark2:     #0C1822;
  --dark3:     #11202E;
  --card:      #0E1C2A;
  --card2:     #132433;
  --border:    #1A3045;
  --border2:   #254260;

  --text:      #EAF4FF;
  --text2:     #9ABCD8;
  --muted:     #4E7A9C;

  --danger:    #EF4444;
  --warning:   #F59E0B;
  --info:      #3B82F6;

  --radius:    14px;
  --radius-sm: 10px;
  --radius-xs: 7px;

  --shadow:    0 8px 40px rgba(0,0,0,.55);
  --shadow-sm: 0 2px 12px rgba(0,0,0,.35);

  --font:      'DM Sans', system-ui, sans-serif;
  --mono:      'DM Mono', 'JetBrains Mono', monospace;

  /* Mobile nav height â€” used for safe-area spacing */
  --bottom-nav-h: 64px;
  --bnav-h:       64px;   /* alias used in calc() throughout */
  --topbar-h:     56px;
}

/* â”€â”€ LIGHT MODE â”€â”€ */
body.light-mode {
  --dark:   #F2F7FC; --dark2: #E6EFF8; --dark3: #D9E8F5;
  --card:   #FFFFFF; --card2: #F5F9FF;
  --border: #C0D8EE; --border2: #9CC0E0;
  --text:   #091825; --text2:  #2C4D68; --muted: #5A7A98;
  --shadow: 0 4px 20px rgba(0,107,63,.1);
  --shadow-sm: 0 2px 8px rgba(0,0,0,.08);
}

/* â”€â”€ RESET â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; overscroll-behavior: none; }
body {
  font-family: var(--font);
  background: var(--dark);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  transition: background .3s, color .3s;
  -webkit-font-smoothing: antialiased;
  overscroll-behavior-x: none;
}
img { display: block; max-width: 100%; }
button { cursor: pointer; }

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#setup-screen {
  height: 100dvh; overflow-y: auto; overscroll-behavior: contain;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  background:
    radial-gradient(ellipse at 25% 20%, rgba(0,107,63,.18) 0%, transparent 55%),
    radial-gradient(ellipse at 75% 80%, rgba(252,209,22,.07) 0%, transparent 55%),
    var(--dark);
}
.setup-box {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 20px; padding: clamp(24px,5vw,44px);
  width: 100%; max-width: 680px; box-shadow: var(--shadow);
}
.setup-header { text-align: center; margin-bottom: 28px; }
.flag-banner { font-size: 2.8rem; margin-bottom: 10px; }
.setup-header h1 { font-size: clamp(1.3rem,4vw,1.7rem); font-weight: 800; color: var(--accent2); margin-bottom: 5px; }
.setup-header p { color: var(--muted); font-size: .87rem; }
.step-grid { display: grid; gap: 12px; }
.step-card {
  background: var(--dark2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px;
  display: flex; gap: 12px; align-items: flex-start;
}
.step-num {
  background: var(--accent); color: #fff; border-radius: 50%;
  width: 28px; height: 28px; min-width: 28px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: .82rem;
}
.step-content h3 { font-size: .92rem; margin-bottom: 4px; font-weight: 700; }
.step-content p { font-size: .8rem; color: var(--muted); line-height: 1.6; }
.step-content code {
  background: var(--dark3); padding: 2px 7px; border-radius: 4px;
  font-family: var(--mono); font-size: .78rem; color: var(--gh-gold);
}
.config-area {
  background: var(--dark2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 18px; margin-top: 18px;
}
.config-area label {
  display: block; font-size: .75rem; color: var(--muted);
  margin-bottom: 5px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .05em;
}
.config-input {
  width: 100%; padding: 11px 13px;
  background: var(--dark3); border: 1px solid var(--border2);
  border-radius: var(--radius-xs); color: var(--text);
  font-family: var(--mono); font-size: .84rem; margin-bottom: 10px;
  transition: border .2s;
}
.config-input:focus { outline: none; border-color: var(--accent); }
.config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media(max-width:480px) { .config-row { grid-template-columns: 1fr; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  padding: 11px 20px; border: none; border-radius: var(--radius-sm);
  font-family: var(--font); font-weight: 700; font-size: .88rem;
  cursor: pointer; transition: all .2s;
  display: inline-flex; align-items: center; justify-content: center; gap: 7px;
  touch-action: manipulation; /* prevent 300ms tap delay */
  min-height: 44px; /* WCAG touch target */
  white-space: nowrap;
}
.btn-primary {
  background: linear-gradient(135deg, var(--gh-green), var(--accent));
  color: #fff; box-shadow: 0 4px 14px rgba(0,107,63,.3);
}
.btn-primary:active { transform: scale(.97); }
.btn-primary:hover { box-shadow: 0 6px 22px rgba(0,107,63,.45); }
.btn-gold  { background: var(--gh-gold); color: #000; font-weight: 800; }
.btn-gold:hover { background: #FFD740; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-outline {
  background: transparent; border: 1.5px solid var(--border2);
  color: var(--text2);
}
.btn-outline:hover { border-color: var(--accent); color: var(--accent2); background: rgba(0,168,107,.05); }
.btn-sm { padding: 7px 14px; font-size: .8rem; min-height: 36px; }
.btn-full { width: 100%; }
.btn-icon {
  background: none; border: none; padding: 6px 9px;
  border-radius: var(--radius-xs); color: var(--muted);
  font-size: .95rem; transition: all .2s; min-height: 36px;
}
.btn-icon:hover { background: var(--dark3); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen {
  display: none; height: 100dvh; overflow-y: auto; overscroll-behavior: contain;
  align-items: center; justify-content: center;
  padding: 16px;
  background:
    radial-gradient(ellipse at 20% 30%, rgba(0,107,63,.12) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(252,209,22,.06) 0%, transparent 50%),
    var(--dark);
}
#auth-screen.visible { display: flex; }
.auth-container { width: 100%; max-width: 440px; }
.auth-logo { text-align: center; margin-bottom: 28px; }
.auth-logo .logo-icon { font-size: 3rem; margin-bottom: 7px; display: block; }
.auth-logo h1 {
  font-size: 1.45rem; font-weight: 800;
  background: linear-gradient(135deg, var(--accent2), var(--gh-gold));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.auth-logo p { color: var(--muted); font-size: .83rem; margin-top: 4px; }
.auth-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 20px; padding: clamp(20px,5vw,34px);
  box-shadow: var(--shadow);
}
.auth-tabs {
  display: flex; background: var(--dark2); border-radius: var(--radius-sm);
  margin-bottom: 24px; padding: 4px; gap: 4px;
}
.auth-tab {
  flex: 1; padding: 9px 6px; text-align: center;
  background: none; border: none; color: var(--muted);
  font-family: var(--font); font-size: .85rem; font-weight: 600;
  border-radius: var(--radius-xs); transition: all .2s; min-height: 40px;
}
.auth-tab.active { background: var(--accent); color: #fff; }

/* â”€â”€ FORMS â”€â”€ */
.form-group { margin-bottom: 14px; }
.form-label {
  display: block; font-size: .75rem; color: var(--muted);
  margin-bottom: 6px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .05em;
}
.form-control {
  width: 100%; padding: 12px 14px;
  background: var(--dark2); border: 1.5px solid var(--border);
  border-radius: var(--radius-xs); color: var(--text);
  font-family: var(--font); font-size: 16px; /* 16px prevents iOS zoom */
  transition: border .2s; -webkit-appearance: none;
}
.form-control:focus { outline: none; border-color: var(--accent); background: var(--dark3); }
select.form-control { cursor: pointer; }
.form-row   { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
@media(max-width:600px) {
  .form-row, .form-row-3 { grid-template-columns: 1fr; gap: 0; }
}
.firebase-note {
  background: var(--dark2); border: 1px solid var(--border);
  border-radius: var(--radius-xs); padding: 12px;
  margin-top: 14px; font-size: .78rem; color: var(--muted); text-align: center;
}
.firebase-note strong { color: var(--accent2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app { display: none; flex-direction: column; height: 100dvh; }
#app.visible { display: flex; }

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  height: var(--topbar-h); background: var(--card);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 16px; gap: 10px;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,.25);
}
.topbar-brand { display: flex; align-items: center; gap: 9px; flex-shrink: 0; }
.brand-flag { font-size: 1.5rem; }
.brand-text h2 { font-size: .88rem; font-weight: 800; color: var(--accent2); line-height: 1.1; }
.brand-text p  { font-size: .67rem; color: var(--muted); }
.topbar-school { flex: 1; text-align: center; padding: 0 8px; min-width: 0; }
.topbar-school .school-name {
  font-size: .82rem; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.topbar-school .school-meta { font-size: .67rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.topbar-right { display: flex; align-items: center; gap: 7px; margin-left: auto; flex-shrink: 0; }
@media(max-width:768px) {
  .menu-btn { display: block !important; }
  .topbar-school { display: none; }
  .topbar { padding: 0 12px; }
}
@media(max-width:480px) {
  /* Hide non-essential topbar items on very small screens */
  #langToggle { display: none; }
}
.sync-badge {
  display: flex; align-items: center; gap: 5px;
  font-size: .72rem; padding: 4px 9px; border-radius: 20px; white-space: nowrap;
}
.sync-badge.online  { background: rgba(0,168,107,.12); color: var(--accent2); border: 1px solid rgba(0,168,107,.25); }
.sync-badge.offline { background: rgba(239,68,68,.12); color: #FCA5A5; border: 1px solid rgba(239,68,68,.25); }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }
.role-chip { padding: 3px 10px; border-radius: 20px; font-size: .72rem; font-weight: 700; }
.role-admin       { background: rgba(252,209,22,.12); color: var(--gh-gold); border: 1px solid rgba(252,209,22,.25); }
.role-coadmin     { background: rgba(168,85,247,.12); color: #C084FC;        border: 1px solid rgba(168,85,247,.25); }
.role-teacher     { background: rgba(0,168,107,.12);  color: var(--accent2); border: 1px solid rgba(0,168,107,.25); }
.role-headteacher { background: rgba(59,130,246,.12); color: #93C5FD;        border: 1px solid rgba(59,130,246,.25); }
.avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gh-green), var(--accent));
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: .82rem; color: #fff; cursor: pointer; flex-shrink: 0;
}
.menu-btn {
  background: none; border: none; color: var(--text);
  font-size: 1.35rem; cursor: pointer; display: none;
  padding: 6px; border-radius: 8px; min-height: 40px; min-width: 40px;
  display: flex; align-items: center; justify-content: center;
}
@media(min-width:769px) { .menu-btn { display: none !important; } }
.dark-toggle {
  background: var(--dark3); border: 1px solid var(--border);
  border-radius: 20px; padding: 5px 11px;
  color: var(--text2); font-size: .75rem; cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  font-family: var(--font); font-weight: 600; white-space: nowrap; min-height: 32px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP BODY LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-body { display: flex; flex: 1; min-height: 0; overflow: hidden; }

/* â”€â”€ SIDEBAR â€” desktop â”€â”€ */
.sidebar {
  width: 230px; min-width: 230px;
  background: var(--card); border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow-y: auto; transition: transform .28s cubic-bezier(.4,0,.2,1);
}
@media(max-width:768px) {
  .sidebar {
    position: fixed; top: var(--topbar-h); left: 0; bottom: 0;
    z-index: 90; transform: translateX(-100%);
    width: 260px; box-shadow: 6px 0 30px rgba(0,0,0,.5);
  }
  .sidebar.open { transform: translateX(0); }
}
.sidebar-user { padding: 14px; border-bottom: 1px solid var(--border); }
.user-card { display: flex; align-items: center; gap: 10px; }
.user-info .user-name   { font-weight: 700; font-size: .88rem; }
.user-info .user-school { font-size: .72rem; color: var(--muted); margin-top: 1px; }
.sidebar-nav { padding: 8px 6px; flex: 1; overflow-y: auto; overscroll-behavior-y: contain; }
.nav-group { margin-bottom: 2px; }
.nav-label {
  font-size: .65rem; color: var(--muted); padding: 10px 10px 4px;
  font-weight: 700; text-transform: uppercase; letter-spacing: .1em;
}
.nav-item {
  display: flex; align-items: center; gap: 9px;
  padding: 10px 10px; border-radius: var(--radius-xs);
  cursor: pointer; color: var(--text2); font-size: .85rem; font-weight: 500;
  transition: all .18s; border: none; background: none;
  width: 100%; text-align: left; min-height: 42px;
}
.nav-item:hover  { background: var(--dark3); color: var(--text); }
.nav-item.active {
  background: linear-gradient(135deg, rgba(0,107,63,.25), rgba(0,168,107,.12));
  color: var(--accent2); font-weight: 700;
  border: 1px solid rgba(0,168,107,.2);
}
.nav-item .nav-icon { width: 20px; text-align: center; flex-shrink: 0; font-size: .95rem; }
.nav-badge {
  margin-left: auto; background: var(--accent); color: #fff;
  border-radius: 10px; padding: 2px 7px; font-size: .68rem; font-weight: 700;
}
.sidebar-footer { padding: 10px; border-top: 1px solid var(--border); }
.dev-credit { text-align: center; font-size: .67rem; color: var(--muted); line-height: 1.9; }
.dev-credit strong { color: var(--accent2); }
.dev-credit a { color: var(--gh-gold); text-decoration: none; }

/* â”€â”€ OVERLAY (closes sidebar on mobile tap-outside) â”€â”€ */
.overlay-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 85; }
.overlay-bg.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  min-height: 0;
  padding: clamp(14px, 4vw, 28px);
  /* Always leave room below last element â€” extra on mobile for bottom nav */
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 32px);
}
/* Mobile bottom padding handled in .content rule above */
.page { display: none; }
.page.active { display: block; animation: fadeIn .22s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.page-header { margin-bottom: clamp(16px,4vw,26px); }
.page-title { font-size: clamp(1.3rem,5vw,1.65rem); font-weight: 800; margin-bottom: 4px; }
.page-sub { color: var(--muted); font-size: .85rem; line-height: 1.5; }
.page-actions { display: flex; gap: 9px; margin-top: 12px; flex-wrap: wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: clamp(14px,3vw,22px);
  margin-bottom: 16px;
}
.card-sm { padding: 14px; }
.card-title {
  font-size: .95rem; font-weight: 700; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
}
.card-title .ct-icon { color: var(--gh-gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px; margin-bottom: 18px;
}
@media(max-width:400px) {
  .stat-grid { grid-template-columns: 1fr 1fr; }
}
.stat-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px;
  position: relative; overflow: hidden;
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
}
.stat-card.green::before { background: linear-gradient(90deg, var(--gh-green), var(--accent2)); }
.stat-card.gold::before  { background: linear-gradient(90deg, var(--warning), var(--gh-gold)); }
.stat-card.blue::before  { background: linear-gradient(90deg, var(--info), #60A5FA); }
.stat-card.red::before   { background: linear-gradient(90deg, var(--danger), #F87171); }
.stat-value { font-size: clamp(1.6rem,5vw,2rem); font-weight: 800; line-height: 1; margin-bottom: 4px; }
.stat-label { font-size: .75rem; color: var(--muted); font-weight: 500; }
.stat-sub   { font-size: .7rem; color: var(--accent2); margin-top: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLES â€” mobile scrollable
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius-xs); overscroll-behavior-x: contain; }
table { width: 100%; border-collapse: collapse; font-size: .84rem; }
th {
  padding: 10px 12px; text-align: left;
  font-size: .68rem; font-weight: 700; color: var(--muted);
  text-transform: uppercase; letter-spacing: .06em;
  background: var(--dark3); white-space: nowrap; position: sticky; top: 0;
}
td { padding: 11px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(0,168,107,.04); }

/* â”€â”€ GRADE PILLS â”€â”€ */
.grade-pill { padding: 3px 10px; border-radius: 20px; font-weight: 700;
  font-size: .76rem; display: inline-block; font-family: var(--mono); }
.gA { background: rgba(74,222,128,.12); color: #4ADE80; border: 1px solid rgba(74,222,128,.25); }
.gB { background: rgba(96,165,250,.12); color: #60A5FA; border: 1px solid rgba(96,165,250,.25); }
.gC { background: rgba(251,191,36,.12); color: #FBBF24; border: 1px solid rgba(251,191,36,.25); }
.gD { background: rgba(167,139,250,.12); color: #A78BFA; border: 1px solid rgba(167,139,250,.25); }
.gE { background: rgba(251,146,60,.12); color: #FB923C; border: 1px solid rgba(251,146,60,.25); }
.gF { background: rgba(248,113,113,.12); color: #F87171; border: 1px solid rgba(248,113,113,.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badge { padding: 3px 9px; border-radius: 20px; font-size: .72rem; font-weight: 600; }
.badge-green    { background: rgba(0,168,107,.12); color: var(--accent2); border: 1px solid rgba(0,168,107,.2); }
.badge-gold     { background: rgba(252,209,22,.12); color: var(--gh-gold); border: 1px solid rgba(252,209,22,.2); }
.badge-blue     { background: rgba(59,130,246,.12); color: #93C5FD; border: 1px solid rgba(59,130,246,.2); }
.badge-red      { background: rgba(239,68,68,.12); color: #FCA5A5; border: 1px solid rgba(239,68,68,.2); }
.badge-gray     { background: var(--dark3); color: var(--muted); border: 1px solid var(--border); }
.badge-purple   { background: rgba(168,85,247,.12); color: #C084FC; border: 1px solid rgba(168,85,247,.25); }
.badge-approved { background: rgba(0,168,107,.12); color: var(--accent2); }
.badge-pending  { background: rgba(245,158,11,.12); color: #FCD34D; }
.badge-locked   { background: rgba(239,68,68,.12); color: #FCA5A5; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tab-bar {
  display: flex; gap: 4px; background: var(--dark2); padding: 4px;
  border-radius: var(--radius-sm); margin-bottom: 20px; flex-wrap: wrap;
  overflow-x: auto; -webkit-overflow-scrolling: touch;
}
.tab-btn {
  padding: 8px 16px; border: none; border-radius: var(--radius-xs);
  background: none; color: var(--muted);
  font-family: var(--font); font-size: .83rem; font-weight: 600;
  cursor: pointer; transition: all .18s; white-space: nowrap; min-height: 38px;
}
.tab-btn.active { background: var(--accent); color: #fff; }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.75); z-index: 200;
  align-items: flex-end; /* sheet from bottom on mobile */
  justify-content: center; backdrop-filter: blur(6px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 22px 22px 0 0; /* bottom sheet style */
  padding: clamp(20px,5vw,30px);
  width: 100%; max-width: 100%;
  max-height: 92dvh; overflow-y: auto;
  position: relative; box-shadow: var(--shadow);
  animation: sheetUp .25s cubic-bezier(.4,0,.2,1);
}
@keyframes sheetUp { from{transform:translateY(60px);opacity:0} to{transform:translateY(0);opacity:1} }
/* Desktop: centred dialog */
@media(min-width:600px) {
  .modal-overlay { align-items: center; padding: 20px; }
  .modal {
    border-radius: 20px; max-width: 520px;
    max-height: 88dvh; animation: fadeIn .2s ease;
  }
  .modal-xl { max-width: 800px; }
}
.modal-title { font-size: 1.05rem; font-weight: 800; margin-bottom: 18px; }
.modal-close {
  position: absolute; top: 16px; right: 16px;
  background: var(--dark3); border: none; color: var(--muted);
  font-size: .95rem; cursor: pointer; width: 30px; height: 30px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
}
.modal-close:hover { color: var(--text); background: var(--border); }
.modal-actions { display: flex; gap: 9px; margin-top: 20px; justify-content: flex-end; flex-wrap: wrap; }
@media(max-width:480px) {
  .modal-actions { flex-direction: column-reverse; }
  .modal-actions .btn { width: 100%; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOASTS â€” bottom on mobile
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast-wrap {
  position: fixed; z-index: 500;
  display: flex; flex-direction: column; gap: 8px;
  right: 16px; bottom: 24px;
  max-width: calc(100vw - 32px);
}
@media(max-width:600px) {
  .toast-wrap {
    left: 12px; right: 12px; bottom: calc(var(--bottom-nav-h) + 10px);
  }
}
.toast {
  padding: 12px 16px; border-radius: 12px; font-size: .85rem; font-weight: 600;
  animation: toastIn .28s ease; box-shadow: 0 8px 28px rgba(0,0,0,.45);
  display: flex; align-items: center; gap: 9px;
}
.toast.success { background: #042B14; color: #4ADE80; border: 1px solid #14532D; }
.toast.error   { background: #1A0707; color: #FCA5A5; border: 1px solid #7F1D1D; }
.toast.info    { background: #0A1838; color: #93C5FD; border: 1px solid #1E3A8A; }
.toast.warning { background: #1A0E00; color: #FCD34D; border: 1px solid #78350F; }
@keyframes toastIn { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORE INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.score-input {
  width: 68px; padding: 7px 6px;
  border: 1.5px solid var(--border2); border-radius: 7px;
  background: var(--dark2); color: var(--text);
  text-align: center; font-family: var(--mono); font-size: .88rem;
  transition: border .2s;
}
@media(max-width:600px) { .score-input { width: 60px; font-size: .82rem; } }
.score-input:focus { outline: none; border-color: var(--accent); background: var(--dark3); }
.score-input.over-max { border-color: var(--danger); background: rgba(239,68,68,.08); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.progress-bar { height: 6px; background: var(--dark3); border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; transition: width .4s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state { text-align: center; padding: 50px 20px; }
.empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: .55; }
.empty-state h3 { font-size: 1rem; margin-bottom: 5px; }
.empty-state p { color: var(--muted); font-size: .85rem; margin-bottom: 18px; line-height: 1.6; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap { position: relative; min-height: 200px; }
canvas.chart-canvas { width: 100% !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APPROVAL LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.approval-item {
  background: var(--dark2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 13px; margin-bottom: 9px;
  display: flex; align-items: center; gap: 11px; flex-wrap: wrap;
}
.approval-info  { flex: 1; min-width: 140px; }
.approval-name  { font-weight: 700; font-size: .88rem; }
.approval-meta  { font-size: .76rem; color: var(--muted); margin-top: 2px; }
.approval-actions { display: flex; gap: 7px; flex-wrap: wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ONLINE USERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.online-user {
  display: flex; align-items: center; gap: 8px; padding: 8px 11px;
  border-radius: 8px; background: var(--dark2); margin-bottom: 6px;
}
.online-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPINNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.spinner {
  display: inline-block; width: 17px; height: 17px;
  border: 2px solid rgba(255,255,255,.25);
  border-top-color: #fff; border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-bar { margin-bottom: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE BOTTOM NAV
   Visible only on small screens
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mobileBottomNav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--bottom-nav-h);
  background: var(--card);
  border-top: 1px solid var(--border);
  z-index: 80;
  padding: 0 4px;
  padding-bottom: env(safe-area-inset-bottom);
  box-shadow: 0 -4px 20px rgba(0,0,0,.3);
  transition: transform .25s ease;
}
#mobileBottomNav.hidden {
  transform: translateY(100%);
}
@media(max-width:768px) { #mobileBottomNav { display: flex; } }
.mob-nav-item {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 3px; padding: 6px 4px;
  background: none; border: none; color: var(--muted);
  font-family: var(--font); font-size: .58rem; font-weight: 600;
  cursor: pointer; transition: color .18s; min-height: 44px;
  position: relative; text-transform: uppercase; letter-spacing: .03em;
}
.mob-nav-item .mob-icon { font-size: 1.2rem; line-height: 1; }
.mob-nav-item.active { color: var(--accent2); }
.mob-nav-item .mob-badge {
  position: absolute; top: 4px; right: calc(50% - 18px);
  background: var(--danger); color: #fff;
  font-size: .55rem; font-weight: 800;
  border-radius: 8px; padding: 1px 5px; min-width: 16px; text-align: center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.divider  { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
.text-muted  { color: var(--muted); }
.text-accent { color: var(--accent2); }
.text-gold   { color: var(--gh-gold); }
.text-danger { color: var(--danger); }
.fw-700 { font-weight: 700; }
.mono { font-family: var(--mono); }
.photo-card:hover { border-color: var(--accent) !important; }
.photo-card { transition: border-color .2s; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  .sidebar, .topbar, #mobileBottomNav, .no-print, .modal-overlay { display: none !important; }
  .content { padding: 0; }
  body { background: #fff; color: #000; }
  .card { border: 1px solid #ccc; page-break-inside: avoid; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE OVERHAUL â€” No bleeds on any screen size
   Targets: mobile phones, tablets, desktops
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ SAFE AREA / VIEWPORT â”€â”€ */
/* body scroll locked globally above */

/* â”€â”€ TOPBAR â€” tighter on very small phones â”€â”€ */
@media(max-width:390px) {
  .topbar { padding: 0 8px; gap: 5px; }
  .brand-flag { display: none; }
  .brand-text h2 { font-size: .82rem; }
  .brand-text p  { display: none; }
  .avatar { width: 30px; height: 30px; font-size: .72rem; }
  .btn-icon { padding: 4px 6px; }
}

/* â”€â”€ SIDEBAR â€” full-height, no bleed â”€â”€ */
.sidebar { max-height: calc(100dvh - var(--topbar-h)); }

/* â”€â”€ CONTENT â€” proper insets on all sides â”€â”€ */
/* .content padding set in main rule above */

/* â”€â”€ FORM ROWS â€” proper gap when stacked â”€â”€ */
@media(max-width:600px) {
  .form-row, .form-row-3 {
    grid-template-columns: 1fr;
    gap: 0; /* form-groups already have margin-bottom */
  }
  /* Give select elements room to breathe */
  select.form-control { font-size: 16px; }
}

/* â”€â”€ STAT GRID â€” 2 columns minimum, never 1 â”€â”€ */
.stat-grid {
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
}
@media(max-width:360px) {
  .stat-grid { grid-template-columns: 1fr 1fr; gap: 9px; }
  .stat-value { font-size: 1.45rem; }
}

/* â”€â”€ ANALYSIS PAGE â€” 2 charts stack on mobile â”€â”€ */
.chart-2col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
@media(max-width:700px) {
  .chart-2col { grid-template-columns: 1fr; }
}

/* â”€â”€ ANALYSIS SUMMARY â€” stack on mobile â”€â”€ */
.analysis-summary-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
@media(max-width:600px) {
  .analysis-summary-grid { grid-template-columns: 1fr; gap: 14px; }
}

/* â”€â”€ DASHBOARD GRID â€” responsive â”€â”€ */
#dash-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)) !important;
  gap: 14px !important;
}

/* â”€â”€ TABLES â€” horizontal scroll with shadow cue â”€â”€ */
.table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  /* Scroll shadow: tells users there's more to scroll */
  background:
    linear-gradient(to right, var(--card) 20px, transparent) left,
    linear-gradient(to left,  var(--card) 20px, transparent) right,
    radial-gradient(farthest-side at 0   50%, rgba(0,0,0,.2), transparent) left,
    radial-gradient(farthest-side at 100% 50%, rgba(0,0,0,.2), transparent) right;
  background-repeat: no-repeat;
  background-size: 40px 100%, 40px 100%, 12px 100%, 12px 100%;
  background-attachment: local, local, scroll, scroll;
}
/* Compact table columns on mobile */
@media(max-width:600px) {
  td, th { padding: 9px 8px; font-size: .8rem; }
  .grade-pill { padding: 2px 7px; font-size: .7rem; }
  /* Score sheet: smaller inputs */
  .score-input { width: 52px !important; font-size: .8rem; padding: 5px 4px; }
}

/* â”€â”€ CARDS â€” no horizontal overflow â”€â”€ */
.card { overflow-x: hidden; word-break: break-word; }

/* â”€â”€ PAGE ACTIONS â€” wrap properly â”€â”€ */
.page-actions { flex-wrap: wrap; gap: 8px; }
@media(max-width:480px) {
  .page-actions .btn { flex: 1 1 auto; min-width: 120px; }
}

/* â”€â”€ SEARCH BAR â€” full width on mobile â”€â”€ */
.search-bar {
  flex-wrap: wrap;
  gap: 8px;
}
.search-bar .form-control { min-width: 0; flex: 1 1 150px; }
.search-bar select { flex: 0 1 auto; min-width: 100px; max-width: 160px; }

/* â”€â”€ APPROVAL ITEMS â€” wrap on mobile â”€â”€ */
@media(max-width:500px) {
  .approval-item { flex-wrap: wrap; }
  .approval-actions { width: 100%; justify-content: flex-end; margin-top: 6px; }
}

/* â”€â”€ MODAL â€” full-width on small phones â”€â”€ */
@media(max-width:380px) {
  .modal { padding: 16px 14px; }
  .modal-title { font-size: .95rem; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MESSAGING â€” no fixed heights, no overflow
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#msgLayout {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  /* Let it fill available vertical space */
  height: calc(100dvh - var(--topbar-h) - 160px);
  min-height: 400px;
  max-height: 720px;
}
#msgLayout > div { /* inner row/col wrapper */
  display: flex;
  flex: 1;
  min-height: 0; /* crucial â€” allows flex children to shrink */
  overflow: hidden;
}
#msgContactsPanel {
  width: 220px;
  min-width: 180px;
  max-width: 240px;
  flex-shrink: 0;
  background: var(--card);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
#msgChatPanel {
  flex: 1;
  min-width: 0; /* prevents overflow */
  display: flex;
  flex-direction: column;
  background: var(--dark2);
  overflow: hidden;
}
#msgChatBody {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 7px;
  overscroll-behavior-y: contain;
}
#msgContactList {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 6px;
  min-height: 0;
  overscroll-behavior-y: contain;
}
#msgChatHeader {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
  font-weight: 700;
  font-size: .88rem;
  min-height: 48px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  overflow: hidden;
}
.msg-input-bar {
  padding: 10px 12px;
  border-top: 1px solid var(--border);
  background: var(--card);
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}
/* Mobile: stack contacts above chat */
@media(max-width:640px) {
  #msgLayout {
    height: calc(100dvh - var(--topbar-h) - var(--bnav-h) - 130px);
    min-height: 480px;
  }
  #msgLayout > div { flex-direction: column !important; overflow: visible; }
  #msgContactsPanel {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    max-height: 190px !important;
    border-right: none !important;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  #msgChatPanel { flex: 1; min-height: 0; }
  /* Message bubbles full width */
  #msgChatBody > div { max-width: 100% !important; }
}
/* Message bubble max-width */
#msgChatBody .msg-bubble { max-width: 75%; }
@media(max-width:480px) { #msgChatBody .msg-bubble { max-width: 88%; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHOTO GRID â€” responsive columns
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#photoGrid {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)) !important;
  gap: 12px !important;
}
@media(max-width:400px) {
  #photoGrid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV â€” safe area + no bleed
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mobileBottomNav {
  /* Ensure it never clips content or appears over modals */
  z-index: 80;
  padding-left:  env(safe-area-inset-left, 0px);
  padding-right: env(safe-area-inset-right, 0px);
}
/* Enough room so content doesn't hide behind bottom nav */
@media(max-width:768px) {
  .content { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 40px) !important; }
  .toast-wrap { bottom: calc(var(--bnav-h) + 8px + env(safe-area-inset-bottom, 0px)); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLET â€” 769px to 1024px
   Sidebar shows, content fills well
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:769px) and (max-width:1024px) {
  .sidebar { width: 200px; min-width: 200px; }
  .content { padding-top: 18px; padding-left: 20px; padding-right: 20px; padding-bottom: 60px; }
  .stat-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
  .card { padding: 16px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP â€” 1025px+
   Comfortable reading widths
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:1025px) {
  .sidebar { width: 240px; min-width: 240px; }
  .content { padding-top: 28px; padding-left: 32px; padding-right: 32px; padding-bottom: 60px; }
  .page-title { font-size: 1.7rem; }
}
@media(min-width:1400px) {
  .content { padding-top: 32px; padding-left: 40px; padding-right: 40px; padding-bottom: 60px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC FIXES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Prevent any element from causing horizontal scroll */
* { max-width: 100%; }
img, canvas, video { max-width: 100%; height: auto; }
canvas.chart-canvas { max-width: 100% !important; height: auto !important; }

/* Inline grids that bleed â€” override to be responsive */
[style*="grid-template-columns:1fr 1fr"] {
  /* Can't easily override inline, handled per-element below */
}

/* Tab bar on very small screens */
@media(max-width:360px) {
  .tab-btn { padding: 7px 11px; font-size: .78rem; }
}

/* Buttons don't overflow on small screens */
@media(max-width:480px) {
  .btn { font-size: .82rem; padding: 10px 14px; }
  .btn-sm { padding: 6px 10px; font-size: .76rem; }
}

/* Hide logout in topbar (it's in sidebar) */
#logoutBtnTop { display: none !important; }

/* â”€â”€ END RESPONSIVE OVERHAUL â”€â”€ */
/* â”€â”€ END STYLES â”€â”€ */
</style>
</head>
<body>

<div class="toast-wrap" id="toastWrap"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP SCREEN â€” shown when Firebase not yet configured
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen">
  <div class="setup-box">
    <div class="setup-header">
      <div class="flag-banner">ğŸ‡¬ğŸ‡­ğŸ”¥</div>
      <h1>Connect Firebase Database</h1>
      <p>One-time setup Â· Takes about 5 minutes Â· Completely free</p>
    </div>
    <div class="step-grid">
      <div class="step-card">
        <div class="step-num">1</div>
        <div class="step-content">
          <h3>Create a Firebase Project</h3>
          <p>Go to <strong>console.firebase.google.com</strong> â†’ Click <strong>"Add project"</strong> â†’ Name it (e.g. <code>ges-assessment</code>) â†’ Continue through the steps.</p>
        </div>
      </div>
      <div class="step-card">
        <div class="step-num">2</div>
        <div class="step-content">
          <h3>Enable Authentication</h3>
          <p>In your project â†’ <strong>Build â†’ Authentication â†’ Get started</strong> â†’ Enable <strong>Email/Password</strong> sign-in provider.</p>
        </div>
      </div>
      <div class="step-card">
        <div class="step-num">3</div>
        <div class="step-content">
          <h3>Create Firestore Database</h3>
          <p>Go to <strong>Build â†’ Firestore Database â†’ Create database</strong> â†’ Choose <strong>Start in test mode</strong> â†’ Select a region close to Ghana.</p>
        </div>
      </div>
      <div class="step-card">
        <div class="step-num">4</div>
        <div class="step-content">
          <h3>Get Your Config Keys</h3>
          <p>Go to <strong>Project Settings (âš™ï¸) â†’ Your apps â†’ Add app â†’ Web (&lt;/&gt;)</strong> â†’ Register app â†’ Copy the <code>firebaseConfig</code> object values below.</p>
        </div>
      </div>
    </div>
    <div class="config-area">
      <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px;">Paste your Firebase config values here to connect the database:</p>
      <div class="config-row">
        <div><label>API Key *</label><input type="text" class="config-input" id="cfg-apiKey" placeholder="AIzaSy..."/></div>
        <div><label>Auth Domain *</label><input type="text" class="config-input" id="cfg-authDomain" placeholder="your-project.firebaseapp.com"/></div>
      </div>
      <div class="config-row">
        <div><label>Project ID *</label><input type="text" class="config-input" id="cfg-projectId" placeholder="your-project-id"/></div>
        <div><label>Storage Bucket</label><input type="text" class="config-input" id="cfg-storageBucket" placeholder="your-project.appspot.com"/></div>
      </div>
      <div class="config-row">
        <div><label>Messaging Sender ID</label><input type="text" class="config-input" id="cfg-messagingSenderId" placeholder="123456789"/></div>
        <div><label>App ID *</label><input type="text" class="config-input" id="cfg-appId" placeholder="1:123...:web:abc..."/></div>
      </div>
      <button class="btn btn-primary btn-full" style="margin-top:8px;" onclick="saveFirebaseConfig()">
        ğŸ”¥ Connect Firebase &amp; Continue
      </button>
    </div>
    <div style="text-align:center;margin-top:16px;font-size:.8rem;color:var(--muted);">
      Your config is stored only in this browser. Never share your HTML file with config embedded publicly.
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-container">
    <div class="auth-logo">
      <span class="logo-icon">ğŸ‡¬ğŸ‡­</span>
      <h1>GES Assessment Manager</h1>
      <p>NaCCA Framework Â· Firebase Edition Â· District-Wide</p>
    </div>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
        <button class="auth-tab" onclick="showAuthTab('reset')">Reset</button>
      </div>

      <!-- LOGIN -->
      <div id="atab-login">
        <div class="form-group">
          <label for="loginEmail" class="form-label">Email Address</label>
          <input type="email" id="loginEmail" class="form-control" placeholder="your@email.com"/>
        </div>
        <div class="form-group">
          <label for="loginPass" class="form-label">Password</label>
          <input type="password" id="loginPass" class="form-control" placeholder="Your password"/>
        </div>
        <button class="btn btn-primary btn-full" onclick="doLogin()" id="loginBtn">
          Sign In â†’
        </button>
        <div class="firebase-note" style="margin-top:12px;">
          ğŸ”¥ Powered by <strong>Firebase</strong> Â· Data syncs across all your devices
        </div>
      </div>

      <!-- REGISTER -->
      <div id="atab-register" style="display:none;">
        <div class="form-row">
          <div class="form-group">
            <label for="regName" class="form-label">Full Name *</label>
            <input type="text" id="regName" class="form-control" placeholder="Your full name"/>
          </div>
          <div class="form-group">
            <label for="regRole" class="form-label">Role *</label>
            <select id="regRole" class="form-control">
              <option value="teacher">Class / Subject Teacher</option>
              <option value="headteacher">Head Teacher</option>
              <option value="coadmin">Co-Admin</option>
              <option value="admin">Admin / ICT Coordinator</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="regSchool" class="form-label">School Name *</label>
          <input type="text" id="regSchool" class="form-control" placeholder="e.g. Achimota School"/>
        </div>
        <div class="form-group">
          <label for="regDistrict" class="form-label">GES District</label>
          <input type="text" id="regDistrict" class="form-control" placeholder="e.g. Accra Metro"/>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="regEmail" class="form-label">Email *</label>
            <input type="email" id="regEmail" class="form-control" placeholder="your@email.com"/>
          </div>
          <div class="form-group">
            <label for="regPass" class="form-label">Password *</label>
            <input type="password" id="regPass" class="form-control" placeholder="Min. 6 chars"/>
          </div>
        </div>
        <div class="firebase-note" style="margin:0 0 14px;">
          âš ï¸ New accounts need <strong>Admin approval</strong> before they can log in. Contact your ICT Coordinator after registering.
        </div>
        <button class="btn btn-primary btn-full" onclick="doRegister()" id="regBtn">
          Create Account â†’
        </button>
      </div>

      <!-- RESET -->
      <div id="atab-reset" style="display:none;">
        <div class="form-group">
          <label for="resetEmail" class="form-label">Email Address</label>
          <input type="email" id="resetEmail" class="form-control" placeholder="your@email.com"/>
        </div>
        <button class="btn btn-primary btn-full" onclick="doReset()">Send Reset Link</button>
        <p style="text-align:center;margin-top:12px;font-size:.82rem;color:var(--muted);">
          Firebase will send a password reset email to your inbox.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <div class="topbar">
    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="topbar-brand">
      <span class="brand-flag">ğŸ‡¬ğŸ‡­</span>
      <div class="brand-text">
        <h2>GES Assessment</h2>
        <p>NaCCA Â· Firebase</p>
      </div>
    </div>
    <div class="topbar-school">
      <div class="school-name" id="tb-school">â€”</div>
      <div class="school-meta" id="tb-meta">â€”</div>
    </div>
    <div class="topbar-right">
      <div class="sync-badge online" id="syncBadge"><div class="sync-dot"></div> Live</div>
      <button class="btn btn-sm btn-outline no-print" id="installBtn" onclick="installPWA()" style="display:none;background:rgba(0,168,107,.15);border-color:var(--accent);color:var(--accent2);">ğŸ“± Install</button>
      <button class="btn-icon no-print" onclick="showPage('notifications')" id="notifBell" title="Notifications" style="position:relative;font-size:1.2rem;">
        ğŸ””<span id="notifDot" style="display:none;position:absolute;top:2px;right:2px;width:8px;height:8px;background:var(--danger);border-radius:50%;border:2px solid var(--card);"></span>
      </button>
      <span class="role-chip no-print" id="roleChip" style="display:none;">â€”</span>
      <button class="dark-toggle no-print" id="langToggle" onclick="toggleLanguage()" title="Switch Language">ğŸŒ EN</button>
      <button class="dark-toggle" onclick="toggleDark()"><span id="darkIcon">â˜€ï¸</span></button>
      <div class="avatar" id="topAvatar" title="Account">T</div>
      <button class="btn btn-sm btn-outline no-print" onclick="doLogout()" style="display:none;" id="logoutBtnTop">Logout</button>
    </div>
  </div>

  <div class="app-body">
    <div class="overlay-bg" id="overlayBg" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-user">
        <div class="user-card">
          <div class="avatar" id="sideAvatar">T</div>
          <div class="user-info">
            <div class="user-name" id="sideUserName">Teacher</div>
            <div class="user-school" id="sideUserSchool">â€”</div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav" id="sidebarNav"></nav>
      <div class="sidebar-footer">
        <button class="btn btn-outline btn-full no-print" onclick="doLogout()" style="margin-bottom:10px;font-size:.82rem;min-height:40px;">ğŸšª Logout</button>
        <div class="dev-credit">
          GES NaCCA Assessment Manager<br/>
          v3.0 Â· Firebase Edition<br/>
          <div style="border-top:1px solid var(--border);margin:6px 0;padding-top:6px;">
            Developed by<br/>
            <strong>Samuel Kwame Dordzie</strong><br/>
            <a href="mailto:bigsammy86g@gmail.com">bigsammy86g@gmail.com</a>
          </div>
        </div>
      </div>
    </div>

    <div class="content" id="mainContent">

      <!-- â•â•â•â•â• DASHBOARD â•â•â•â•â• -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <div class="page-title">Dashboard</div>
          <div class="page-sub" id="dash-greeting">Welcome back!</div>
        </div>
        <div class="stat-grid" id="dashStats"></div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;" id="dash-grid">
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ«</span> School Info</div>
            <div id="dashSchoolBlock" style="font-size:.88rem;color:var(--muted);">Configure your profile to see details.</div>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-icon">âš¡</span> Quick Actions</div>
            <div id="dashQuickActions" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>
        <div class="card" style="margin-top:18px;">
          <div class="card-title"><span class="ct-icon">ğŸ“Š</span> Grade Distribution</div>
          <div class="chart-wrap"><canvas id="dashChart" class="chart-canvas" height="200"></canvas></div>
        </div>
        <div class="card" id="adminDashPanel" style="display:none;">
          <div class="card-title"><span class="ct-icon">ğŸ›ï¸</span> School-Wide Overview</div>
          <div id="schoolOverview"></div>
        </div>
      </div>

      <!-- â•â•â•â•â• SCHOOL PROFILE â•â•â•â•â• -->
      <div class="page" id="page-profile">
        <div class="page-header">
          <div class="page-title">School Profile</div>
          <div class="page-sub">Saved to Firebase Â· Appears on all reports</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ«</span> Profile Settings</div>
          <div class="form-row">
            <div class="form-group"><label for="pSchool" class="form-label">School Name *</label>
              <input type="text" id="pSchool" class="form-control"/></div>
            <div class="form-group"><label for="pRegion" class="form-label">GES Region</label>
              <select id="pRegion" class="form-control">
                <option>Greater Accra</option><option>Ashanti</option><option>Western</option>
                <option>Eastern</option><option>Central</option><option>Northern</option>
                <option>Upper East</option><option>Upper West</option><option>Volta</option>
                <option>Bono East</option><option>Ahafo</option><option>Western North</option>
                <option>Oti</option><option>Savannah</option><option>North East</option>
              </select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="pDistrict" class="form-label">GES District</label>
              <input type="text" id="pDistrict" class="form-control" placeholder="e.g. Accra Metro"/></div>
            <div class="form-group"><label for="pCircuit" class="form-label">Circuit</label>
              <input type="text" id="pCircuit" class="form-control" placeholder="e.g. Labone Circuit"/></div>
          </div>
          <div class="form-row form-row-3">
            <div class="form-group"><label for="pYear" class="form-label">Academic Year *</label>
              <input type="text" id="pYear" class="form-control" placeholder="2024/2025"/></div>
            <div class="form-group">
              <label for="pTerm" class="form-label" id="pTermLabel">Term *</label>
              <select id="pTerm" class="form-control">
                <option>Term 1</option><option>Term 2</option><option>Term 3</option>
              </select></div>
            <div class="form-group"><label for="pLevel" class="form-label">Level *</label>
              <select id="pLevel" class="form-control" onchange="updateClassOptions(); updateTermOptions();">
                <option value="Basic">Basic (KGâ€“JHS)</option>
                <option value="SHS">SHS (Form 1â€“3)</option>
              </select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="pClass" class="form-label">Class *</label>
              <select id="pClass" class="form-control" onchange="handleClassSelect()"></select>
              <div id="customClassWrap" style="display:none;margin-top:8px;">
                <input type="text" id="pClassCustom" class="form-control"
                  placeholder="Type your class e.g. Form 2 Science C"
                  oninput="syncCustomClass()"/>
                <div style="font-size:.75rem;color:var(--muted);margin-top:4px;">
                  ğŸ’¡ Type exactly as it appears on your time table
                </div>
              </div>
            </div>
            <div class="form-group"><label for="pSubject" class="form-label">Subject *</label>
              <input type="text" id="pSubject" class="form-control" placeholder="e.g. Mathematics"/></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="pStrand" class="form-label">NaCCA Strand</label>
              <input type="text" id="pStrand" class="form-control" placeholder="e.g. Number &amp; Operations"/></div>
            <div class="form-group"><label for="pSubStrand" class="form-label">Sub-Strand</label>
              <input type="text" id="pSubStrand" class="form-control" placeholder="e.g. Fractions"/></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="pCAW" class="form-label">CA Weight (%) â€” e.g. 30</label>
              <input type="number" id="pCAW" class="form-control" value="30" min="0" max="100"/></div>
            <div class="form-group"><label for="pExamW" class="form-label">Exam Weight (%) â€” e.g. 70</label>
              <input type="number" id="pExamW" class="form-control" value="70" min="0" max="100"/></div>
          </div>
          <div style="display:flex;gap:10px;margin-top:6px;">
            <button class="btn btn-primary" onclick="saveProfile()">â˜ï¸ Save to Firebase</button>
            <button class="btn btn-outline" onclick="loadProfileUI()">â†º Reload</button>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• STUDENTS â•â•â•â•â• -->
      <div class="page" id="page-students">
        <div class="page-header">
          <div class="page-title">Students</div>
          <div class="page-sub">Synced to Firebase Â· Accessible from any device</div>
        </div>
        <div class="card">
          <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('students','add')">â• Add Student</button>
            <button class="tab-btn" onclick="switchTab('students','bulk')">ğŸ“‹ Bulk Upload</button>
          </div>
          <div class="tab-pane active" id="students-tab-add">
            <div class="form-row form-row-3">
              <div class="form-group"><label for="sName" class="form-label">Full Name *</label>
                <input type="text" id="sName" class="form-control" placeholder="Student full name"/></div>
              <div class="form-group"><label for="sGender" class="form-label">Gender *</label>
                <select id="sGender" class="form-control">
                  <option value="Male">Male</option><option value="Female">Female</option>
                </select></div>
              <div class="form-group">
                <label for="sIndexAuto" class="form-label" style="display:flex;align-items:center;gap:8px;">
                  Index Number
                  <span style="display:flex;align-items:center;gap:5px;margin-left:auto;font-weight:400;font-size:.75rem;color:var(--muted);">
                    <span>Auto</span>
                    <label style="position:relative;display:inline-block;width:36px;height:20px;cursor:pointer;">
                      <input type="checkbox" id="sIndexAuto" checked onchange="toggleIndexMode()"
                        style="opacity:0;width:0;height:0;position:absolute;"/>
                      <span id="sIndexToggleTrack" style="position:absolute;inset:0;background:var(--accent);border-radius:20px;transition:.25s;"></span>
                      <span id="sIndexToggleThumb" style="position:absolute;left:2px;top:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.25s;transform:translateX(16px);"></span>
                    </label>
                    <span>Manual</span>
                  </span>
                </label>
                <div id="sIndexAutoWrap" style="background:var(--dark3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:.83rem;color:var(--accent2);">
                  Auto-generated on save &nbsp;<span id="sIndexPreview" style="font-family:var(--mono);font-weight:700;"></span>
                </div>
                <input type="text" id="sIndex" class="form-control" placeholder="e.g. GES/2024/001" style="display:none;"/>
              </div>
            </div>
            <!-- Auto-index format config -->
            <div id="sIndexFormatWrap" style="margin-bottom:14px;background:var(--dark2);border:1px solid var(--border);border-radius:10px;padding:12px;">
              <div style="font-size:.8rem;font-weight:700;margin-bottom:10px;color:var(--text2);">&#9881;&#65039; Auto-Index Format</div>
              <div class="form-row" style="margin-bottom:6px;">
                <div class="form-group" style="margin-bottom:0;"><label for="idxPrefix" class="form-label" style="font-size:.75rem;">Prefix</label>
                  <input type="text" id="idxPrefix" class="form-control" placeholder="GES" value="GES" oninput="updateIndexPreview()" style="font-size:.82rem;"/></div>
                <div class="form-group" style="margin-bottom:0;"><label for="idxYear" class="form-label" style="font-size:.75rem;">Year (optional)</label>
                  <input type="text" id="idxYear" class="form-control" placeholder="2024" oninput="updateIndexPreview()" style="font-size:.82rem;"/></div>
                <div class="form-group" style="margin-bottom:0;"><label for="idxDigits" class="form-label" style="font-size:.75rem;">Number Padding</label>
                  <select id="idxDigits" class="form-control" onchange="updateIndexPreview()" style="font-size:.82rem;">
                    <option value="2">2 digits (01, 02â€¦)</option>
                    <option value="3" selected>3 digits (001, 002â€¦)</option>
                    <option value="4">4 digits (0001â€¦)</option>
                  </select></div>
                <div class="form-group" style="margin-bottom:0;"><label for="idxStart" class="form-label" style="font-size:.75rem;">Start Number</label>
                  <input type="number" id="idxStart" class="form-control" value="1" min="1" oninput="updateIndexPreview()" style="font-size:.82rem;"/></div>
              </div>
              <div style="font-size:.78rem;color:var(--muted);">
                Next index: <strong id="idxFormatPreview" style="color:var(--accent2);font-family:var(--mono);font-size:.88rem;"></strong>
              </div>
            </div>
            <button class="btn btn-primary" onclick="addStudent()">Add Student</button>
          </div>
          <div class="tab-pane" id="students-tab-bulk">
            <p style="font-size:.83rem;color:var(--muted);margin-bottom:10px;">
              One student per line: <code style="background:var(--dark3);padding:2px 6px;border-radius:4px;font-family:var(--mono);">Name, Gender, IndexNo</code>
            </p>
            <textarea id="bulkText" class="form-control" rows="8" placeholder="John Kwame Mensah, Male, 001&#10;Abena Asante, Female&#10;Kwesi Boateng, Male, 003"></textarea>
            <button class="btn btn-primary" style="margin-top:12px;" onclick="bulkAddStudents()">ğŸ“¥ Import Students</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">
            <span class="ct-icon">ğŸ‘©ğŸ¾â€ğŸ“</span> Class List
            <span class="badge badge-blue" style="margin-left:auto;" id="studentCountBadge">0</span>
          </div>
          <div class="search-bar">
            <input type="text" class="form-control" id="stuSearch" placeholder="ğŸ” Searchâ€¦" oninput="renderStudentTable()"/>
            <select class="form-control" style="max-width:130px;" id="stuGenderFilter" onchange="renderStudentTable()">
              <option value="">All</option><option value="Male">Male</option><option value="Female">Female</option>
            </select>
            <button class="btn btn-sm btn-outline" onclick="sortStudentsAlpha()">â‡… Aâ€“Z</button>
          </div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>#</th><th>Name</th><th>Gender</th><th>Index No.</th><th class="no-print">Actions</th>
            </tr></thead>
            <tbody id="studentTable"></tbody></table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• ASSESSMENTS â•â•â•â•â• -->
      <div class="page" id="page-assessments">
        <div class="page-header">
          <div class="page-title">Assessments</div>
          <div class="page-sub">Create assessment categories Â· Sync to Firebase</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“</span> New Assessment</div>
          <div class="form-row">
            <div class="form-group"><label for="aName" class="form-label">Name *</label>
              <input type="text" id="aName" class="form-control" placeholder="e.g. Class Exercise 1"/></div>
            <div class="form-group"><label for="aCategory" class="form-label">Category *</label>
              <select id="aCategory" class="form-control">
                <option>Class Exercise</option><option>Quiz</option><option>Project Work</option>
                <option>Midterm</option><option>Group Work</option><option>End of Term Exam</option>
                <option>Homework</option><option>Custom</option>
              </select></div>
          </div>
          <div class="form-row form-row-3">
            <div class="form-group"><label for="aTotal" class="form-label">Total Marks *</label>
              <input type="number" id="aTotal" class="form-control" placeholder="100" min="1"/></div>
            <div class="form-group"><label for="aType" class="form-label">Type</label>
              <select id="aType" class="form-control">
                <option value="CA">Continuous Assessment</option>
                <option value="Exam">End of Term Exam</option>
              </select></div>
            <div class="form-group"><label for="aDate" class="form-label">Date</label>
              <input type="date" id="aDate" class="form-control"/></div>
          </div>
          <button class="btn btn-primary" onclick="addAssessment()">Create Assessment</button>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“‹</span> Assessment List</div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>#</th><th>Name</th><th>Category</th><th>Type</th><th>Marks</th><th>Date</th><th>Status</th><th class="no-print">Actions</th>
            </tr></thead>
            <tbody id="assessmentTable"></tbody></table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• SCORES â•â•â•â•â• -->
      <div class="page" id="page-scores">
        <div class="page-header">
          <div class="page-title">Enter Scores</div>
          <div class="page-sub">Scores are auto-saved to Firebase as you type</div>
        </div>
        <div class="card">
          <div class="form-group"><label for="scoreAssessmentSel" class="form-label">Select Assessment *</label>
            <select id="scoreAssessmentSel" class="form-control" onchange="loadScoreSheet()" style="max-width:100%;">
              <option value="">â€” Choose an assessment â€”</option>
            </select></div>
        </div>
        <div id="scoreSheetWrap"></div>
      </div>

      <!-- â•â•â•â•â• RESULTS â•â•â•â•â• -->
      <div class="page" id="page-results">
        <div class="page-header">
          <div class="page-title">Results</div>
          <div class="page-sub">Live rankings Â· Auto-calculated from Firebase scores</div>
        </div>
        <div class="card no-print" style="display:flex;gap:10px;flex-wrap:wrap;padding:14px;">
          <select class="form-control" style="max-width:160px;" id="resGradeFilter" onchange="renderResults()">
            <option value="">All Grades</option>
            <option value="A">A</option><option value="B">B</option>
            <option value="C">C</option><option value="D">D</option>
            <option value="E">E</option><option value="F">F</option>
          </select>
          <select class="form-control" style="max-width:200px;" id="resSortBy" onchange="renderResults()">
            <option value="pos">By Position</option>
            <option value="name">By Name Aâ€“Z</option>
            <option value="asc">Score Lowâ€“High</option>
          </select>
          <button class="btn btn-sm btn-outline" onclick="renderResults()">ğŸ”„ Refresh</button>
          <button class="btn btn-sm btn-primary" onclick="showPage('reports')">ğŸ“„ Generate Report</button>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ†</span> Results Table</div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>Pos.</th><th>Name</th><th>Gender</th><th>Index</th>
              <th>CA Avg%</th><th>Exam Avg%</th><th>Total%</th><th>Grade</th><th>Remarks</th>
            </tr></thead>
            <tbody id="resultsTable"></tbody></table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• ANALYSIS â•â•â•â•â• -->
      <div class="page" id="page-analysis">
        <div class="page-header">
          <div class="page-title">Performance Analysis</div>
          <div class="page-sub">Automated insights from Firebase data</div>
        </div>
        <div class="stat-grid" id="analysisStats"></div>
        <div style="class="chart-2col">
          <div class="card"><div class="card-title"><span class="ct-icon">ğŸ“Š</span> Grade Distribution</div>
            <div class="chart-wrap"><canvas id="gradeChart" class="chart-canvas" height="200"></canvas></div></div>
          <div class="card"><div class="card-title"><span class="ct-icon">ğŸ“ˆ</span> Score Ranges</div>
            <div class="chart-wrap"><canvas id="scoreChart" class="chart-canvas" height="200"></canvas></div></div>
        </div>
        <div class="card"><div class="card-title"><span class="ct-icon">âš¥</span> Gender Performance</div>
          <div class="chart-wrap"><canvas id="genderChart" class="chart-canvas" height="180"></canvas></div></div>
        <div class="card"><div class="card-title"><span class="ct-icon">ğŸ’¡</span> Summary</div>
          <div id="analysisSummary"></div></div>
      </div>

      <!-- â•â•â•â•â• REPORTS â•â•â•â•â• -->
      <div class="page" id="page-reports">
        <div class="page-header">
          <div class="page-title">Reports &amp; PDF</div>
          <div class="page-sub">Generate Â· Download Â· Print Â· Share on WhatsApp</div>
        </div>
        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('reports','single')">ğŸ“„ Single Report</button>
          <button class="tab-btn" onclick="switchTab('reports','bulk')">ğŸ–¨ï¸ Bulk PDF</button>
          <button class="tab-btn" onclick="switchTab('reports','whatsapp')">ğŸ“² WhatsApp Share</button>
        </div>

        <!-- SINGLE REPORT -->
        <div class="tab-pane active" id="reports-tab-single">
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ“„</span> Report Options</div>
            <div class="form-row">
              <div class="form-group"><label for="rptType" class="form-label">Report Type</label>
                <select id="rptType" class="form-control">
                  <option value="class">Class Summary Report</option>
                  <option value="individual">Individual Student Reports</option>
                  <option value="broadsheet">Full Broadsheet</option>
                </select></div>
              <div class="form-group"><label for="rptStudent" class="form-label">Student (for individual)</label>
                <select id="rptStudent" class="form-control">
                  <option value="">All Students</option>
                </select></div>
            </div>
            <div class="form-group"><label for="rptNotes" class="form-label">Additional Notes</label>
              <textarea id="rptNotes" class="form-control" rows="2" placeholder="Any extra comments for this reportâ€¦"></textarea></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
              <button class="btn btn-primary" onclick="downloadReport()">ğŸ“¥ Download Report</button>
              <button class="btn btn-gold" onclick="printReport()">ğŸ–¨ï¸ Print / Save as PDF</button>
            </div>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ‘ï¸</span> Preview</div>
            <div id="rptPreview" style="font-size:.85rem;color:var(--muted);">Click Download or Print to generate preview.</div>
          </div>
        </div>

        <!-- BULK PDF -->
        <div class="tab-pane" id="reports-tab-bulk">
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ–¨ï¸</span> Bulk PDF â€” All Students at Once</div>
            <p style="font-size:.87rem;color:var(--muted);margin-bottom:18px;line-height:1.7;">
              Generate <strong>one report card per student</strong> in a single printable document.
              Each student gets their own page. Open in your browser and use
              <strong>Print â†’ Save as PDF</strong> to get the full PDF file.
            </p>
            <div class="form-row">
              <div class="form-group"><label for="bulkFilter" class="form-label">Include Students</label>
                <select id="bulkFilter" class="form-control">
                  <option value="all">All Students</option>
                  <option value="passed">Passed Only (Grade Aâ€“E)</option>
                  <option value="failed">Failed Only (Grade F)</option>
                  <option value="gradeA">Grade A Only</option>
                </select></div>
              <div class="form-group"><label for="bulkStyle" class="form-label">Report Style</label>
                <select id="bulkStyle" class="form-control">
                  <option value="card">Individual Report Cards (1 per page)</option>
                  <option value="summary">Class Summary + All Students</option>
                </select></div>
            </div>
            <div class="form-group"><label for="bulkNote" class="form-label">Head Teacher / Principal's Note (optional)</label>
              <textarea id="bulkNote" class="form-control" rows="2" placeholder="e.g. Congratulations to all students on a successful termâ€¦"></textarea></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
              <button class="btn btn-primary" onclick="generateBulkPDF()">ğŸ–¨ï¸ Generate Bulk PDF</button>
              <button class="btn btn-outline" onclick="previewBulkCount()">ğŸ‘ï¸ Preview Count</button>
            </div>
            <div id="bulkCountPreview" style="margin-top:12px;font-size:.85rem;color:var(--accent2);"></div>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ“Š</span> Quick Stats Before Printing</div>
            <div id="bulkQuickStats" style="color:var(--muted);font-size:.87rem;">Generate bulk PDF to see stats.</div>
          </div>
        </div>

        <!-- WHATSAPP SHARE -->
        <div class="tab-pane" id="reports-tab-whatsapp">
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ“²</span> Share Results on WhatsApp</div>
            <p style="font-size:.87rem;color:var(--muted);margin-bottom:18px;line-height:1.7;">
              Send a student's result directly to their parent or guardian on WhatsApp.
              Select a student below â€” a formatted message will be generated automatically.
            </p>
            <div class="form-row">
              <div class="form-group"><label for="waStudent" class="form-label">Select Student *</label>
                <select id="waStudent" class="form-control" onchange="previewWhatsApp()">
                  <option value="">â€” Choose a student â€”</option>
                </select></div>
              <div class="form-group"><label for="waCountry" class="form-label">Parent Phone Number</label>
                <div style="display:flex;gap:6px;">
                  <select id="waCountry" class="form-control" style="max-width:110px;">
                    <option value="233">ğŸ‡¬ğŸ‡­ +233</option>
                    <option value="234">ğŸ‡³ğŸ‡¬ +234</option>
                    <option value="44">ğŸ‡¬ğŸ‡§ +44</option>
                    <option value="1">ğŸ‡ºğŸ‡¸ +1</option>
                  </select>
                  <input type="tel" id="waPhone" class="form-control" placeholder="024 XXX XXXX" oninput="previewWhatsApp()"/>
                </div>
              </div>
            </div>
            <div class="form-group"><label for="waExtra" class="form-label">Extra Message (optional)</label>
              <input type="text" id="waExtra" class="form-control" placeholder="e.g. Please see teacher for further discussion" oninput="previewWhatsApp()"/></div>
          </div>
          <div class="card" id="waPreviewCard" style="display:none;">
            <div class="card-title"><span class="ct-icon">ğŸ’¬</span> Message Preview</div>
            <div id="waPreview" style="background:var(--dark2);border-radius:10px;padding:16px;
              font-size:.87rem;line-height:1.8;white-space:pre-wrap;font-family:var(--mono);
              border:1px solid var(--border);color:var(--text2);"></div>
            <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;">
              <button class="btn btn-primary" style="background:#25D366;" onclick="sendWhatsApp()">
                ğŸ“² Open WhatsApp
              </button>
              <button class="btn btn-outline" onclick="copyWAMessage()">ğŸ“‹ Copy Message</button>
              <button class="btn btn-outline" onclick="shareClassResults()">ğŸ“¢ Share Class Summary</button>
            </div>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-icon">ğŸ“¢</span> Broadcast to All Parents</div>
            <p style="font-size:.85rem;color:var(--muted);margin-bottom:12px;">
              Generate a summary message you can paste into a WhatsApp group for all parents.
            </p>
            <button class="btn btn-outline" onclick="generateBroadcastMessage()">ğŸ“¢ Generate Class Broadcast</button>
            <div id="broadcastMsg" style="margin-top:12px;display:none;">
              <div id="broadcastText" style="background:var(--dark2);border-radius:10px;padding:16px;
                font-size:.85rem;line-height:1.8;white-space:pre-wrap;font-family:var(--mono);
                border:1px solid var(--border);color:var(--text2);margin-bottom:10px;"></div>
              <button class="btn btn-sm btn-outline" onclick="copyBroadcast()">ğŸ“‹ Copy Broadcast</button>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• NOTIFICATIONS â•â•â•â•â• -->
      <div class="page" id="page-notifications">
        <div class="page-header">
          <div class="page-title">Notifications</div>
          <div class="page-sub">Assessment approvals Â· System alerts Â· Activity updates</div>
        </div>
        <div class="card no-print" style="display:flex;gap:10px;padding:14px;">
          <button class="btn btn-sm btn-outline" onclick="markAllRead()">âœ… Mark All Read</button>
          <button class="btn btn-sm btn-outline" onclick="clearNotifications()">ğŸ—‘ï¸ Clear All</button>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ””</span> All Notifications</div>
          <div id="notifList"></div>
        </div>
      </div>

      <!-- â•â•â•â•â• BROADSHEET â•â•â•â•â• -->
      <div class="page" id="page-broadsheet">
        <div class="page-header">
          <div class="page-title">Broadsheet</div>
          <div class="page-sub">Full class matrix with all assessments</div>
        </div>
        <div class="card no-print" style="display:flex;gap:10px;flex-wrap:wrap;padding:14px;">
          <button class="btn btn-primary" onclick="renderBroadsheet()">ğŸ”„ Generate</button>
          <button class="btn btn-outline" onclick="exportBroadsheetCSV()">ğŸ“Š Export CSV</button>
          <button class="btn btn-outline" onclick="window.print()">ğŸ–¨ï¸ Print</button>
        </div>
        <div class="card" id="broadsheetCard">
          <div id="broadsheetContent"><div class="empty-state"><div class="empty-icon">ğŸ“‘</div><p>Click Generate to build the broadsheet.</p></div></div>
        </div>
      </div>


      <!-- â•â•â•â•â• TERM COMPARISON â•â•â•â•â• -->
      <div class="page" id="page-termcomp">
        <div class="page-header">
          <div class="page-title">Term Comparison</div>
          <div class="page-sub" id="tcPageSub">Track student improvement across terms or semesters</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“Š</span> Select Terms to Compare</div>
          <div class="form-row">
            <div class="form-group"><label for="tcBaseTerm" class="form-label" id="tcBaseLabel2">Base (Earlier)</label>
              <select id="tcBaseTerm" class="form-control">
                <option value="Term 1">Term 1</option><option value="Term 2">Term 2</option>
              </select></div>
            <div class="form-group"><label for="tcCompareTerm" class="form-label" id="tcCompLabel2">Compare (Later)</label>
              <select id="tcCompareTerm" class="form-control">
                <option value="Term 2">Term 2</option><option value="Term 3">Term 3</option>
              </select></div>
            <div class="form-group"><label for="tcYear" class="form-label">Academic Year</label>
              <input type="text" id="tcYear" class="form-control" placeholder="2024/2025"/></div>
          </div>
          <button class="btn btn-primary" onclick="runTermComparison()">ğŸ“Š Compare Now</button>
        </div>
        <div class="card" id="tcSummaryCard" style="display:none;">
          <div class="card-title"><span class="ct-icon">ğŸ“ˆ</span> Improvement Summary</div>
          <div id="tcSummary"></div>
        </div>
        <div class="card" id="tcTableCard" style="display:none;">
          <div class="card-title"><span class="ct-icon">ğŸ“‹</span> Student-by-Student Comparison</div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>#</th><th>Student</th><th id="tcBaseLabel">Term 1 %</th><th id="tcCompLabel">Term 2 %</th>
              <th>Change</th><th>Trend</th><th>Grade Change</th>
            </tr></thead>
            <tbody id="tcTable"></tbody></table>
          </div>
          <div style="margin-top:12px;display:flex;gap:10px;">
            <button class="btn btn-outline btn-sm" onclick="exportTermCompCSV()">ğŸ“Š Export CSV</button>
            <button class="btn btn-outline btn-sm" onclick="window.print()">ğŸ–¨ï¸ Print</button>
          </div>
        </div>
        <div class="card" id="tcChartCard" style="display:none;">
          <div class="card-title"><span class="ct-icon">ğŸ“‰</span> Top Improvers Chart</div>
          <div class="chart-wrap"><canvas id="tcChart" class="chart-canvas" height="220"></canvas></div>
        </div>
      </div>

      <!-- â•â•â•â•â• STUDENT PROMOTION â•â•â•â•â• -->
      <div class="page" id="page-promotion">
        <div class="page-header">
          <div class="page-title">Student Promotion</div>
          <div class="page-sub">Mark who moves up Â· repeats Â· graduates</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“</span> Promotion Status</div>
          <p style="font-size:.85rem;color:var(--muted);margin-bottom:14px;">Review results and set each student's end-of-year status. Saved to Firebase.</p>
          <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
            <button class="btn btn-sm btn-outline" onclick="autoSetPromotion()">âš¡ Auto-Set from Grades</button>
            <button class="btn btn-sm btn-primary" onclick="saveAllPromotion()">â˜ï¸ Save All</button>
            <button class="btn btn-sm btn-outline" onclick="exportPromotionCSV()">ğŸ“Š Export CSV</button>
          </div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>#</th><th>Student Name</th><th>Overall %</th><th>Grade</th>
              <th>Status</th><th>Next Class</th><th>Notes</th>
            </tr></thead>
            <tbody id="promotionTable"></tbody></table>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“Š</span> Promotion Summary</div>
          <div id="promotionSummary" style="color:var(--muted);font-size:.87rem;">Set statuses above to see summary.</div>
        </div>
      </div>

      <!-- â•â•â•â•â• LEAGUE TABLE â•â•â•â•â• -->
      <div class="page" id="page-league">
        <div class="page-header">
          <div class="page-title">School League Table</div>
          <div class="page-sub">Rankings across all classes Â· Admin and Head Teacher view</div>
        </div>
        <div class="card no-print" style="display:flex;gap:10px;flex-wrap:wrap;padding:14px;">
          <button class="btn btn-primary" onclick="buildLeagueTable()">ğŸ† Generate Rankings</button>
          <button class="btn btn-outline" onclick="exportLeagueCSV()">ğŸ“Š Export CSV</button>
          <button class="btn btn-outline" onclick="window.print()">ğŸ–¨ï¸ Print</button>
          <select id="leagueFilter" class="form-control" style="max-width:160px;" onchange="buildLeagueTable()">
            <option value="all">All Classes</option>
            <option value="Form 1">Form 1 Only</option>
            <option value="Form 2">Form 2 Only</option>
            <option value="Form 3">Form 3 Only</option>
          </select>
        </div>
        <div class="stat-grid" id="leagueStats"></div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ†</span> Class Rankings</div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>Rank</th><th>Teacher</th><th>Class</th><th>Subject</th>
              <th>Students</th><th>Avg%</th><th>Pass%</th><th>Top Grade</th><th>Trend</th>
            </tr></thead>
            <tbody id="leagueTable"></tbody></table>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“Š</span> Average by Subject</div>
          <div class="chart-wrap"><canvas id="leagueChart" class="chart-canvas" height="220"></canvas></div>
        </div>
      </div>

      <!-- â•â•â•â•â• TIMETABLE â•â•â•â•â• -->
      <div class="page" id="page-timetable">
        <div class="page-header">
          <div class="page-title">Timetable Builder</div>
          <div class="page-sub">Create Â· Save to Firebase Â· Share on WhatsApp</div>
        </div>
        <div class="card">
          <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('timetable','builder')">ğŸ”§ Builder</button>
            <button class="tab-btn" onclick="switchTab('timetable','view')">ğŸ“… View</button>
            <button class="tab-btn" onclick="switchTab('timetable','share')">ğŸ“² Share</button>
          </div>
          <div class="tab-pane active" id="timetable-tab-builder">
            <!-- Basic info -->
            <div class="form-row" style="margin-bottom:14px;">
              <div class="form-group"><label for="ttClass" class="form-label">Class Name</label>
                <input type="text" id="ttClass" class="form-control" placeholder="e.g. Form 2 Science A"/></div>
              <div class="form-group"><label for="ttYear" class="form-label">Academic Year</label>
                <input type="text" id="ttYear" class="form-control" placeholder="2024/2025"/></div>
            </div>

            <!-- Period & Timing Configurator -->
            <div class="card" style="background:var(--dark2);margin-bottom:14px;">
              <div class="card-title" style="font-size:.9rem;margin-bottom:10px;">
                âš™ï¸ Configure Periods &amp; Times
                <button class="btn btn-sm btn-outline" style="margin-left:auto;font-size:.75rem;" onclick="addTTPeriod()">â• Add Row</button>
              </div>
              <p style="font-size:.78rem;color:var(--muted);margin-bottom:12px;">
                Edit period names, start/end times, and mark any row as a Break or Lunch.
                Changes apply to the grid immediately.
              </p>
              <div id="ttPeriodConfig" style="display:flex;flex-direction:column;gap:6px;"></div>
              <button class="btn btn-sm btn-primary" style="margin-top:10px;" onclick="applyTTPeriodConfig()">
                âœ… Apply to Timetable Grid
              </button>
            </div>

            <!-- Timetable Grid -->
            <div style="overflow-x:auto;margin-bottom:14px;">
              <table id="ttGrid" style="border-collapse:collapse;min-width:680px;width:100%;font-size:.82rem;">
                <thead id="ttHead"></thead>
                <tbody id="ttBody"></tbody>
              </table>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="saveTimetable()">â˜ï¸ Save to Firebase</button>
              <button class="btn btn-outline" onclick="clearTimetable()">ğŸ—‘ï¸ Clear All</button>
              <button class="btn btn-outline" onclick="loadMyTimetable()">â†º Reload Saved</button>
            </div>
          </div>
          <div class="tab-pane" id="timetable-tab-view">
            <div id="ttViewWrap"><div class="empty-state"><div class="empty-icon">ğŸ“…</div><p>Save a timetable first.</p></div></div>
            <button class="btn btn-outline btn-sm" style="margin-top:12px;" onclick="window.print()">ğŸ–¨ï¸ Print</button>
          </div>
          <div class="tab-pane" id="timetable-tab-share">
            <p style="font-size:.87rem;color:var(--muted);margin-bottom:14px;">Share your timetable with students or parents.</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-primary" style="background:#25D366;" onclick="shareTimetableWA()">ğŸ“² Share on WhatsApp</button>
              <button class="btn btn-outline" onclick="copyTimetableText()">ğŸ“‹ Copy as Text</button>
            </div>
            <div id="ttSharePreview" style="margin-top:14px;display:none;">
              <div id="ttShareText" style="background:var(--dark2);border:1px solid var(--border);
                border-radius:10px;padding:14px;font-family:var(--mono);font-size:.82rem;
                line-height:1.9;white-space:pre-wrap;color:var(--text2);max-height:300px;overflow-y:auto;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• ADMIN: USER MANAGEMENT â•â•â•â•â• -->
      <div class="page" id="page-users">
        <div class="page-header">
          <div class="page-title">User Management</div>
          <div class="page-sub">Approve accounts Â· Assign roles Â· Manage district teachers</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">â³</span> Pending Approvals <span class="nav-badge" id="pendingCount">0</span></div>
          <div id="pendingList"><div class="empty-state"><div class="empty-icon">âœ…</div><h3>No pending approvals</h3><p>All registered users have been reviewed.</p></div></div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ‘¥</span> All Users
            <span id="coAdminCounter" style="margin-left:auto;font-size:.78rem;color:var(--muted);font-weight:500;"></span>
          </div>
          <div class="search-bar">
            <input type="text" class="form-control" id="userSearch" placeholder="ğŸ” Search usersâ€¦" oninput="renderUserTable()"/>
            <select class="form-control" style="max-width:150px;" id="userRoleFilter" onchange="renderUserTable()">
              <option value="">All Roles</option>
              <option value="teacher">Teacher</option>
              <option value="headteacher">Head Teacher</option>
              <option value="coadmin">Co-Admin</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>Name</th><th>School</th><th>Role</th><th>District</th><th>Status</th><th>Joined</th><th>Actions</th>
            </tr></thead>
            <tbody id="usersTable"></tbody></table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â• ADMIN: SCHOOL OVERVIEW â•â•â•â•â• -->
      <div class="page" id="page-school-overview">
        <div class="page-header">
          <div class="page-title">School-Wide Overview</div>
          <div class="page-sub">Aggregate statistics across all teachers &amp; classes</div>
        </div>
        <div class="stat-grid" id="overviewStats"></div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“š</span> Classes &amp; Subjects Overview</div>
          <div class="table-wrap">
            <table><thead><tr>
              <th>Teacher</th><th>School</th><th>Class</th><th>Subject</th><th>Students</th><th>Assessments</th><th>Avg%</th><th>Status</th>
            </tr></thead>
            <tbody id="overviewTable"></tbody></table>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“Š</span> District Grade Distribution</div>
          <div class="chart-wrap"><canvas id="districtChart" class="chart-canvas" height="220"></canvas></div>
        </div>
      </div>

      <!-- â•â•â•â•â• ASSESSMENT APPROVALS â•â•â•â•â• -->
      <div class="page" id="page-approvals">
        <div class="page-header">
          <div class="page-title">Assessment Approvals</div>
          <div class="page-sub">Review and approve/lock teacher assessments</div>
        </div>
        <div class="card">
          <div id="approvalsList"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><h3>No assessments to review</h3></div></div>
        </div>
      </div>


      <!-- â•â•â•â•â• MESSAGING â•â•â•â•â• -->
      <div class="page" id="page-messaging">
        <div class="page-header">
          <div class="page-title">Staff Messaging</div>
          <div class="page-sub">Direct messages between teachers Â· Synced via Firebase</div>
        </div>
        <!-- Responsive: stack on mobile, side-by-side on desktop -->
        <div id="msgLayout">
          <!-- On desktop: row layout -->
          <div>
            <!-- Contacts panel -->
            <div id="msgContactsPanel">
              <div style="padding:10px;border-bottom:1px solid var(--border);">
                <input type="text" id="msgSearch" class="form-control" placeholder="ğŸ” Search staffâ€¦" oninput="filterMsgContacts()" style="font-size:.82rem;"/>
              </div>
              <div id="msgContactList"></div>
            </div>
            <!-- Chat panel -->
            <div id="msgChatPanel">
              <div id="msgChatHeader">
                <span style="flex:1;color:var(--muted);font-weight:500;font-size:.85rem;">Select a staff member to start messaging</span>
              </div>
              <div id="msgChatBody"></div>
              <div class="msg-input-bar">
                <input type="text" id="msgInput" class="form-control" placeholder="Type a messageâ€¦"
                  onkeydown="if(event.key==='Enter')sendMessage()" style="flex:1;font-size:.87rem;min-width:0;"/>
                <button class="btn btn-primary btn-sm" onclick="sendMessage()" style="flex-shrink:0;">Send â¤</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- â•â•â•â•â• NOTICE BOARD â•â•â•â•â• -->
      <div class="page" id="page-notices">
        <div class="page-header">
          <div class="page-title">Staff Notice Board</div>
          <div class="page-sub">Post announcements Â· Share files Â· Tag staff</div>
        </div>
        <div class="card" id="noticePostCard">
          <div class="card-title"><span class="ct-icon">ğŸ“‹</span> Post a Notice</div>
          <div class="form-group"><label for="noticeTitle" class="form-label">Title *</label>
            <input type="text" id="noticeTitle" class="form-control" placeholder="e.g. Staff Meeting â€” Friday 3PM"/></div>
          <div class="form-group"><label for="noticeBody" class="form-label">Message *</label>
            <textarea id="noticeBody" class="form-control" rows="3" placeholder="Type your notice hereâ€¦"></textarea></div>
          <div class="form-row">
            <div class="form-group"><label for="noticeCategory" class="form-label">Category</label>
              <select id="noticeCategory" class="form-control">
                <option value="general">ğŸ“¢ General</option>
                <option value="urgent">ğŸš¨ Urgent</option>
                <option value="meeting">ğŸ“… Meeting</option>
                <option value="academic">ğŸ“š Academic</option>
                <option value="exam">ğŸ“ Exams</option>
                <option value="welfare">â¤ï¸ Staff Welfare</option>
              </select></div>
            <div class="form-group"><label for="noticeAudience" class="form-label">Visible To</label>
              <select id="noticeAudience" class="form-control">
                <option value="all">All Staff</option>
                <option value="teacher">Teachers Only</option>
                <option value="admin">Admin &amp; Head Teachers Only</option>
              </select></div>
          </div>
          <div style="display:flex;gap:10px;margin-top:6px;">
            <button class="btn btn-primary" onclick="postNotice()">ğŸ“‹ Post Notice</button>
            <button class="btn btn-outline" onclick="clearNoticeForm()">âœ• Clear</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“Œ</span> All Notices
            <select id="noticeFilter" class="form-control" style="max-width:160px;margin-left:auto;font-size:.8rem;" onchange="renderNoticeBoard()">
              <option value="all">All Categories</option>
              <option value="urgent">ğŸš¨ Urgent</option>
              <option value="meeting">ğŸ“… Meetings</option>
              <option value="academic">ğŸ“š Academic</option>
              <option value="exam">ğŸ“ Exams</option>
            </select>
          </div>
          <div id="noticeBoardList"></div>
        </div>
      </div>

      <!-- â•â•â•â•â• STUDENT PHOTOS â•â•â•â•â• -->
      <div class="page" id="page-photos">
        <div class="page-header">
          <div class="page-title">Student Photos</div>
          <div class="page-sub">Saved to your device folder Â· Firebase stores names only Â· Zero cost</div>
        </div>

        <!-- Step 1: Folder selection -->
        <div class="card" id="photoFolderCard">
          <div class="card-title"><span class="ct-icon">ğŸ“</span> Device Photo Folder</div>
          <div id="photoFolderStatus">
            <div style="background:rgba(0,168,107,.08);border:1px solid rgba(0,168,107,.25);border-radius:10px;padding:14px;margin-bottom:14px;font-size:.87rem;line-height:1.7;">
              <strong>How it works:</strong><br/>
              ğŸ“ You choose a folder on your phone or computer once.<br/>
              ğŸ“¸ Photos are saved as image files directly into that folder.<br/>
              â˜ï¸ Firebase only stores the student names â€” photos never leave your device.<br/>
              ğŸ”„ On a new device, just select the same synced folder (e.g. Google Drive / OneDrive folder).
            </div>
            <div id="photoFolderName" style="font-size:.85rem;color:var(--muted);margin-bottom:12px;">No folder selected yet.</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="selectPhotoFolder()">ğŸ“ Choose Device Folder</button>
              <button class="btn btn-outline" id="photoFolderChangeBtn" onclick="selectPhotoFolder()" style="display:none;">ğŸ”„ Change Folder</button>
            </div>
            <div id="photoFSAPIWarn" style="display:none;margin-top:12px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:10px;font-size:.82rem;color:var(--warning);">
              âš ï¸ Your browser does not support direct device folder access (File System Access API).<br/>
              Photos will be saved as downloads to your Downloads folder instead. Each photo is named by student ID so you can organise them manually.
            </div>
          </div>
        </div>

        <!-- Photo grid (shown after folder selected or fallback) -->
        <div class="card" id="photoGridCard" style="display:none;">
          <div class="card-title">
            <span class="ct-icon">ğŸ“¸</span> Student Photos
            <div style="margin-left:auto;display:flex;gap:8px;">
              <button class="btn btn-sm btn-outline" onclick="exportAllPhotos()">ğŸ“¥ Export All</button>
            </div>
          </div>
          <div class="search-bar">
            <input type="text" class="form-control" id="photoSearch" placeholder="ğŸ” Search studentâ€¦" oninput="renderPhotoGrid()"/>
          </div>
          <div id="photoGrid" style="margin-top:14px;"></div>
        </div>
      </div>

      <!-- â•â•â•â•â• GRADING SCALE â•â•â•â•â• -->
      <div class="page" id="page-grading">
        <div class="page-header">
          <div class="page-title">Grading Scale</div>
          <div class="page-sub">Customize Ghana NaCCA grading boundaries Â· Saved to Firebase</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">âš–ï¸</span> Grade Boundaries</div>
          <div id="gradingRows"></div>
          <div style="display:flex;gap:10px;margin-top:14px;">
            <button class="btn btn-primary" onclick="saveGrading()">â˜ï¸ Save to Firebase</button>
            <button class="btn btn-outline" onclick="resetGrading()">â†º Reset Defaults</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ’¬</span> Remark Bank</div>
          <div id="commentRows"></div>
          <button class="btn btn-primary" style="margin-top:12px;" onclick="saveComments()">â˜ï¸ Save Remarks</button>
        </div>
      </div>

      <!-- â•â•â•â•â• BACKUP â•â•â•â•â• -->
      <div class="page" id="page-backup">
        <div class="page-header">
          <div class="page-title">Backup &amp; Export</div>
          <div class="page-sub">Download local copies of your Firebase data</div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ“¤</span> Export Data</div>
          <p style="font-size:.85rem;color:var(--muted);margin-bottom:14px;">Your data lives in Firebase. Export a local backup any time.</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="exportJSON()">ğŸ“¥ Download JSON Backup</button>
            <button class="btn btn-outline" onclick="exportCSV()">ğŸ“Š Export Results CSV</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="ct-icon">ğŸ—‘ï¸</span> Danger Zone</div>
          <p style="font-size:.85rem;color:var(--muted);margin-bottom:12px;">âš ï¸ Deletes data from Firebase permanently.</p>
          <button class="btn btn-danger btn-sm" onclick="clearMyData()">ğŸ—‘ï¸ Delete My Data</button>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /app-body -->
</div><!-- /app -->

<!-- EDIT STUDENT MODAL -->
<div class="modal-overlay" id="editStuModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('editStuModal')">âœ•</button>
    <div class="modal-title">âœï¸ Edit Student</div>
    <input type="hidden" id="editStuId"/>
    <div class="form-group"><label for="editStuName" class="form-label">Full Name</label>
      <input type="text" id="editStuName" class="form-control"/></div>
    <div class="form-row">
      <div class="form-group"><label for="editStuGender" class="form-label">Gender</label>
        <select id="editStuGender" class="form-control"><option>Male</option><option>Female</option></select></div>
      <div class="form-group">
        <label for="editStuIndex" class="form-label" style="display:flex;align-items:center;gap:8px;">
          Index Number
          <button class="btn btn-sm btn-outline" style="margin-left:auto;font-size:.72rem;padding:3px 8px;"
            onclick="autoFillEditIndex()">&#128258; Auto-fill</button>
        </label>
        <input type="text" id="editStuIndex" class="form-control" placeholder="e.g. GES/2024/001"/>
        <div style="font-size:.75rem;color:var(--muted);margin-top:4px;">
          Leave blank to keep existing. Click Auto-fill to generate next available index.
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('editStuModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditStudent()">Save Changes</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-title">âš ï¸ Confirm Action</div>
    <p id="confirmMsg" style="color:var(--muted);font-size:.9rem;margin-bottom:20px;line-height:1.6;"></p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('confirmModal')">Cancel</button>
      <button class="btn btn-danger" id="confirmOkBtn">Yes, Proceed</button>
    </div>
  </div>
</div>

<!-- CHANGE ROLE MODAL -->
<div class="modal-overlay" id="roleModal">
  <div class="modal" style="max-width:400px;">
    <button class="modal-close" onclick="closeModal('roleModal')">âœ•</button>
    <div class="modal-title">ğŸ”§ Change User Role</div>
    <div id="roleModalInfo" style="background:var(--dark2);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:.84rem;color:var(--muted);"></div>
    <input type="hidden" id="roleModalUserId"/>
    <div class="form-group"><label for="roleModalSelect" class="form-label">Assign Role</label>
      <select id="roleModalSelect" class="form-control">
        <option value="teacher">Teacher</option>
        <option value="headteacher">Head Teacher</option>
        <option value="coadmin">Co-Admin</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div id="roleModalWarning" style="display:none;padding:10px 14px;border-radius:8px;font-size:.82rem;margin-bottom:10px;background:rgba(168,85,247,.08);color:#C084FC;border:1px solid rgba(168,85,247,.2);">
      âš ï¸ Co-Admins have full management access but <strong>cannot</strong> assign or change other admins' roles, and cannot create new Co-Admins.
    </div>
    <div id="roleModalLimit" style="display:none;padding:10px 14px;border-radius:8px;font-size:.82rem;margin-bottom:10px;background:rgba(239,68,68,.08);color:#FCA5A5;border:1px solid rgba(239,68,68,.2);">
      â›” Co-Admin limit reached (5 maximum). Remove an existing Co-Admin first.
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('roleModal')">Cancel</button>
      <button class="btn btn-primary" id="roleModalSaveBtn" onclick="saveUserRole()">Save Role</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GES NaCCA Assessment Manager Â· v3.0 Firebase Edition
//  Samuel Kwame Dordzie Â· bigsammy86g@gmail.com
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ STATE â”€â”€
let CURRENT_USER = null;    // Firebase user object
let USER_DOC = null;        // Firestore user profile
let STUDENTS = [];
let ASSESSMENTS = [];
let SCORES = {};            // {assessmentId: {studentId: score}}
let PROFILE = {};
let ALL_USERS = [];         // For admin view
let GRADING = defaultGrading();
let COMMENTS = defaultComments();
let CHARTS = {};
let DARK_MODE = false;
let UNSUBSCRIBERS = [];     // Firestore listeners

function defaultGrading() {
  return [
    { grade:'A', label:'Excellent',  min:80, max:100, color:'#4ADE80' },
    { grade:'B', label:'Very Good',  min:70, max:79,  color:'#60A5FA' },
    { grade:'C', label:'Good',       min:60, max:69,  color:'#FBBF24' },
    { grade:'D', label:'Credit',     min:50, max:59,  color:'#A78BFA' },
    { grade:'E', label:'Pass',       min:40, max:49,  color:'#FB923C' },
    { grade:'F', label:'Fail',       min:0,  max:39,  color:'#F87171' },
  ];
}
function defaultComments() {
  return {
    A: 'Excellent performance. Keep up the outstanding work!',
    B: 'Very good performance. Continue to strive for excellence.',
    C: 'Good performance. Some areas still need improvement.',
    D: 'Satisfactory performance. More effort and focus needed.',
    E: 'Barely passed. Significant improvement is urgently needed.',
    F: 'Failed. Needs immediate attention, support, and remediation.',
  };
}

// â”€â”€ UTILS â”€â”€
function ls(k, v) { if(v===undefined) return JSON.parse(localStorage.getItem(k)||'null'); localStorage.setItem(k,JSON.stringify(v)); }
function eid(id) { return document.getElementById(id); }
function toast(msg, type='success') {
  const d = document.createElement('div');
  d.className = `toast ${type}`;
  d.innerHTML = `<span>${{success:'âœ…',error:'âŒ',info:'â„¹ï¸',warning:'âš ï¸'}[type]||'â€¢'}</span><span>${msg}</span>`;
  eid('toastWrap').appendChild(d);
  setTimeout(() => d.remove(), 4000);
}
function confirm2(msg, cb) {
  eid('confirmMsg').textContent = msg;
  eid('confirmOkBtn').onclick = () => { closeModal('confirmModal'); cb(); };
  openModal('confirmModal');
}
function openModal(id) { eid(id).classList.add('open'); }
function closeModal(id) { eid(id).classList.remove('open'); }
function setLoading(btnId, loading, originalText) {
  const btn = eid(btnId);
  if (!btn) return;
  btn.disabled = loading;
  btn.innerHTML = loading ? `<span class="spinner"></span> Please waitâ€¦` : originalText;
}
function getGrade(pct) {
  for (const g of GRADING) {
    if (pct >= g.min && pct <= g.max) return g;
  }
  return GRADING[GRADING.length - 1];
}

// â”€â”€ FIREBASE CONFIG â”€â”€
function saveFirebaseConfig() {
  const cfg = {
    apiKey: eid('cfg-apiKey').value.trim(),
    authDomain: eid('cfg-authDomain').value.trim(),
    projectId: eid('cfg-projectId').value.trim(),
    storageBucket: eid('cfg-storageBucket').value.trim(),
    messagingSenderId: eid('cfg-messagingSenderId').value.trim(),
    appId: eid('cfg-appId').value.trim(),
  };
  if (!cfg.apiKey || !cfg.authDomain || !cfg.projectId || !cfg.appId) {
    return toast('API Key, Auth Domain, Project ID and App ID are required.', 'error');
  }
  ls('ges_firebase_config', cfg);
  toast('Firebase config saved! Reloading appâ€¦', 'success');
  setTimeout(() => location.reload(), 1500);
}

// â”€â”€ AUTH TABS â”€â”€
function showAuthTab(tab) {
  ['login','register','reset'].forEach(t => {
    eid(`atab-${t}`).style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.auth-tab').forEach((b, i) => {
    b.classList.toggle('active', ['login','register','reset'].indexOf(tab) === i);
  });
}

// â”€â”€ AUTH ACTIONS â”€â”€
async function doLogin() {
  const { auth, signInWithEmailAndPassword } = window.FB;
  if (!auth) return toast('Firebase not connected. Reload and try again.', 'error');
  const email = eid('loginEmail').value.trim();
  const pass = eid('loginPass').value;
  if (!email || !pass) return toast('Enter email and password.', 'error');
  setLoading('loginBtn', true, 'Sign In â†’');
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    // onAuthStateChanged handles the rest
  } catch(e) {
    toast(friendlyAuthError(e.code), 'error');
    setLoading('loginBtn', false, 'Sign In â†’');
  }
}

async function doRegister() {
  const { auth, db, createUserWithEmailAndPassword, doc, setDoc, serverTimestamp } = window.FB;
  if (!auth) return toast('Firebase not connected.', 'error');
  const name = eid('regName').value.trim();
  const school = eid('regSchool').value.trim();
  const email = eid('regEmail').value.trim();
  const pass = eid('regPass').value;
  const role = eid('regRole').value;
  const district = eid('regDistrict').value.trim();
  if (!name || !school || !email || !pass) return toast('All required fields must be filled.', 'error');
  if (pass.length < 6) return toast('Password must be at least 6 characters.', 'error');
  setLoading('regBtn', true, 'Create Account â†’');
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    // Create user document â€” status: pending (needs admin approval)
    await setDoc(doc(db, 'users', cred.user.uid), {
      uid: cred.user.uid,
      name, school, email, role, district,
      status: 'pending',  // 'pending' | 'approved' | 'suspended'
      createdAt: serverTimestamp(),
    });
    // Sign out immediately â€” they must be approved first
    await window.FB.signOut(auth);
    toast('Account created! Await admin approval before logging in.', 'success');
    showAuthTab('login');
    setLoading('regBtn', false, 'Create Account â†’');
  } catch(e) {
    toast(friendlyAuthError(e.code), 'error');
    setLoading('regBtn', false, 'Create Account â†’');
  }
}

async function doReset() {
  const { auth, sendPasswordResetEmail } = window.FB;
  const email = eid('resetEmail').value.trim();
  if (!email) return toast('Enter your email address.', 'error');
  try {
    await sendPasswordResetEmail(auth, email);
    toast('Password reset email sent! Check your inbox.', 'success');
  } catch(e) {
    toast(friendlyAuthError(e.code), 'error');
  }
}

async function doLogout() {
  confirm2('Are you sure you want to log out?', async () => {
    UNSUBSCRIBERS.forEach(u => u());
    await window.FB.signOut(window.FB.auth);
    CURRENT_USER = null; USER_DOC = null;
    STUDENTS = []; ASSESSMENTS = []; SCORES = {};
    eid('app').classList.remove('visible');
    eid('auth-screen').classList.add('visible');
  });
}

function friendlyAuthError(code) {
  const map = {
    'auth/user-not-found': 'No account found with that email.',
    'auth/wrong-password': 'Incorrect password.',
    'auth/email-already-in-use': 'An account with this email already exists.',
    'auth/weak-password': 'Password must be at least 6 characters.',
    'auth/invalid-email': 'Invalid email address.',
    'auth/too-many-requests': 'Too many failed attempts. Try again later.',
    'auth/network-request-failed': 'Network error. Check your connection.',
    'auth/invalid-credential': 'Invalid email or password.',
  };
  return map[code] || `Error: ${code}`;
}

// â”€â”€ APP INIT â”€â”€
window.initApp = async function() {
  const savedCfg = ls('ges_firebase_config');
  const isCfgd = window.FB?.IS_CONFIGURED;

  if (!isCfgd && !savedCfg) {
    // Show setup screen
    eid('setup-screen').style.display = 'flex';
    return;
  }

  if (savedCfg && !isCfgd) {
    // Config saved but page hasn't reloaded with it injected
    // (In production you'd dynamically init Firebase â€” show instruction)
    eid('setup-screen').style.display = 'none';
    eid('auth-screen').classList.add('visible');
    toast('Firebase config saved. Please embed your config in the HTML file as instructed, then reload.', 'warning');
    return;
  }

  eid('setup-screen').style.display = 'none';
  const { auth, onAuthStateChanged, db, doc, getDoc } = window.FB;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      eid('app').classList.remove('visible');
      eid('auth-screen').classList.add('visible');
      return;
    }
    // Load user document
    const uSnap = await getDoc(doc(db, 'users', user.uid));
    if (!uSnap.exists()) {
      toast('User profile not found. Please register again.', 'error');
      await window.FB.signOut(auth);
      return;
    }
    const uData = uSnap.data();
    if (uData.status === 'pending') {
      toast('Your account is awaiting admin approval. Please contact your ICT Coordinator.', 'warning');
      await window.FB.signOut(auth);
      return;
    }
    if (uData.status === 'suspended') {
      toast('Your account has been suspended. Contact your administrator.', 'error');
      await window.FB.signOut(auth);
      return;
    }
    CURRENT_USER = user;
    USER_DOC = uData;
    await startApp();
  });
};

async function startApp() {
  eid('auth-screen').classList.remove('visible');
  eid('app').classList.add('visible');
  updateTopbarUI();
  buildSidebar();
  await Promise.all([
    loadProfile(),
    loadGrading(),
    subscribeStudents(),
    subscribeAssessments(),
  ]);
  if (isAdminLike()) {
    subscribeAllUsers();        // Full user list for admin & co-admin
    subscribeSchoolOverview();
  } else if (isHeadTeacher()) {
    subscribeAllUsers();        // Head teachers also need full list for approvals
  } else {
    subscribeApprovedUsers();   // Regular teachers only need approved colleagues
  }
  subscribeNotifications();
  subscribeMessages();
  subscribeNotices();
  restorePhotoFolder();
  // Restore language preference
  const savedLang = ls('ges_lang');
  if (savedLang && savedLang !== LANG) { LANG = savedLang; applyLanguage(); }
  const langBtn = eid('langToggle');
  if (langBtn) langBtn.textContent = LANG === 'tw' ? 'ğŸŒ Twi' : 'ğŸŒ EN';
  renderDashboard();
  updateClassOptions();
  updateTermOptions();
  loadProfileUI();
  // Restore dark mode preference
  if (ls('ges_dark')) setDark(true);
}

function isAdmin()     { return USER_DOC?.role === 'admin'; }
function isCoAdmin()   { return USER_DOC?.role === 'coadmin'; }
function isAdminLike() { return isAdmin() || isCoAdmin(); }          // Has admin-level access
function isHeadTeacher() { return USER_DOC?.role === 'headteacher' || isAdminLike(); }
function myUid() { return CURRENT_USER?.uid; }

// â”€â”€ TOPBAR / SIDEBAR â”€â”€
function updateTopbarUI() {
  const u = USER_DOC;
  if (!u) return;
  const initials = (u.name||'T').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
  eid('topAvatar').textContent = initials;
  eid('sideAvatar').textContent = initials;
  eid('sideUserName').textContent = u.name || 'Teacher';
  eid('sideUserSchool').textContent = u.school || 'â€”';
  const roleLabel = { teacher:'Teacher', headteacher:'Head Teacher', admin:'Admin', coadmin:'Co-Admin' }[u.role] || u.role;
  const roleClass = { teacher:'role-teacher', headteacher:'role-headteacher', admin:'role-admin', coadmin:'role-coadmin' }[u.role] || 'role-teacher';
  const chip = eid('roleChip');
  chip.textContent = roleLabel;
  chip.className = `role-chip no-print ${roleClass}`;
  // Show role chip on desktop only (hidden on mobile via display:none style, removed here)
  chip.style.display = '';
}

function buildSidebar() {
  const nav = eid('sidebarNav');
  const items = [
    { group:'Main', items:[
      { page:'dashboard', icon:'ğŸ“Š', label:'Dashboard' },
      { page:'profile', icon:'ğŸ«', label:'School Profile' },
      { page:'notifications', icon:'ğŸ””', label:'Notifications', badge:'notifCount' },
    ]},
    { group:'Students', items:[
      { page:'students', icon:'ğŸ‘©ğŸ¾â€ğŸ“', label:'Students' },
      { page:'promotion', icon:'ğŸ“', label:'Promotion' },
    ]},
    { group:'Assessments', items:[
      { page:'assessments', icon:'ğŸ“', label:'Assessments' },
      { page:'scores', icon:'âœï¸', label:'Enter Scores' },
      { page:'results', icon:'ğŸ†', label:'Results' },
      { page:'analysis', icon:'ğŸ“ˆ', label:'Analysis' },
      { page:'termcomp', icon:'ğŸ“Š', label:'Term Comparison' },
    ]},
    { group:'Reports', items:[
      { page:'reports', icon:'ğŸ“„', label:'PDF Reports' },
      { page:'broadsheet', icon:'ğŸ“‘', label:'Broadsheet' },
      { page:'timetable', icon:'ğŸ“…', label:'Timetable' },
    ]},
  ];

  if (isHeadTeacher() || isAdmin()) {
    items.push({ group:'Admin', items:[
      { page:'school-overview', icon:'ğŸ›ï¸', label:'School Overview' },
      { page:'league', icon:'ğŸ†', label:'League Table' },
      { page:'approvals', icon:'âœ…', label:'Approvals' },
    ]});
  }
  if (isAdminLike()) {
    items[items.length-1].items.push(
      { page:'users', icon:'ğŸ‘¥', label:'Users', badge:'pendingCount' }
    );
  }

  items.push({ group:'System', items:[
    { page:'grading', icon:'âš–ï¸', label:'Grading Scale' },
    { page:'backup', icon:'ğŸ’¾', label:'Backup / Export' },
  ]});
  items.push({ group:'Communication', items:[
    { page:'messaging', icon:'ğŸ’¬', label:'Staff Messaging', badge:'unreadMsgCount' },
    { page:'notices', icon:'ğŸ“‹', label:'Notice Board' },
  ]});
  items.push({ group:'Students', items:[
    { page:'photos', icon:'ğŸ“¸', label:'Student Photos' },
  ]});

  nav.innerHTML = items.map(g => `
    <div class="nav-group">
      <div class="nav-label">${g.group}</div>
      ${g.items.map(i => `
        <button class="nav-item ${i.page==='dashboard'?'active':''}" onclick="showPage('${i.page}')">
          <span class="nav-icon">${i.icon}</span>
          ${i.label}
          ${i.badge ? `<span class="nav-badge" id="${i.badge}">0</span>` : ''}
        </button>`).join('')}
    </div>`).join('');
}

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const target = eid('page-' + page);
  if (target) target.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') === `showPage('${page}')`) n.classList.add('active');
  });
  // Sync mobile bottom nav
  document.querySelectorAll('.mob-nav-item[data-page]').forEach(b => {
    b.classList.toggle('active', b.dataset.page === page);
  });
  closeSidebar();
  const refresh = {
    dashboard: renderDashboard,
    results: renderResults,
    analysis: renderAnalysis,
    broadsheet: renderBroadsheet,
    scores: renderAssessmentDropdowns,
    reports: () => { renderAssessmentDropdowns(); updateRptStudentSel(); updateWAStudentSel(); previewBulkCount(); },
    grading: () => { renderGradingRows(); renderCommentRows(); },
    notifications: renderNotifications,
    termcomp: initTermComparison,
    promotion: renderPromotionTable,
    league: buildLeagueTable,
    timetable: loadMyTimetable,
    messaging: () => {
      if (!ALL_USERS.length) {
        const el = eid('msgContactList');
        if (el) el.innerHTML = '<div style="padding:16px;text-align:center;font-size:.82rem;color:var(--muted);">Loading staffâ€¦</div>';
        setTimeout(renderMsgContacts, 2000);
      } else {
        renderMsgContacts();
      }
    },
    notices: renderNoticeBoard,
    photos: renderPhotoGrid,
    approvals: renderApprovals,
    users: () => { renderUserTable(); updatePendingCount(); },
  };
  if (refresh[page]) refresh[page]();
}

function closeMobNav(btn) {
  // Called by bottom nav items â€” deactivate "More" highlight
  document.querySelectorAll('.mob-nav-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function toggleSidebar() { eid('sidebar').classList.toggle('open'); eid('overlayBg').classList.toggle('show'); }
function closeSidebar() { eid('sidebar').classList.remove('open'); eid('overlayBg').classList.remove('show'); }

function switchTab(group, tab) {
  document.querySelectorAll(`#page-${group} .tab-btn`).forEach(b => {
    b.classList.toggle('active', b.getAttribute('onclick').includes(`'${tab}'`));
  });
  document.querySelectorAll(`#page-${group} .tab-pane`).forEach(p => {
    p.classList.toggle('active', p.id === `${group}-tab-${tab}`);
  });
}

// â”€â”€ DARK MODE â”€â”€
function setDark(on) {
  DARK_MODE = on;
  document.body.classList.toggle('light-mode', !on);
  eid('darkIcon').textContent = on ? 'â˜€ï¸' : 'ğŸŒ™';
  ls('ges_dark', on);
}
function toggleDark() { setDark(!DARK_MODE); }

// â”€â”€ PROFILE â”€â”€
async function loadProfile() {
  const { db, doc, getDoc } = window.FB;
  const snap = await getDoc(doc(db, 'profiles', myUid()));
  if (snap.exists()) PROFILE = snap.data();
  updateTopbarSchool();
}

function updateTopbarSchool() {
  const p = PROFILE;
  eid('tb-school').textContent = p.school || USER_DOC?.school || 'Set up School Profile';
  eid('tb-meta').textContent = [p.class, p.subject, p.term, p.year].filter(Boolean).join(' Â· ') || 'NaCCA Framework';
}

// â”€â”€ SHS PROGRAMMES (your school's 7 departments) â”€â”€
const SHS_PROGRAMMES = [
  'General Arts',
  'General Science',
  'Business',
  'Visual Arts',
  'Home Economics',
  'Agriculture',
  'Technical',
];
const SHS_FORMS    = ['Form 1', 'Form 2', 'Form 3'];
const SHS_STREAMS  = ['A', 'B', 'C', 'D', 'E'];  // extend if needed

function buildSHSClassList() {
  const list = [];
  SHS_FORMS.forEach(form => {
    SHS_PROGRAMMES.forEach(prog => {
      SHS_STREAMS.slice(0,3).forEach(stream => {
        list.push(`${form} ${prog} ${stream}`);
      });
    });
  });
  return list;
}

const BASIC_CLASSES = [
  'KG 1','KG 2',
  'Class 1','Class 2','Class 3','Class 4','Class 5','Class 6',
  'JHS 1A','JHS 1B','JHS 1C',
  'JHS 2A','JHS 2B','JHS 2C',
  'JHS 3A','JHS 3B','JHS 3C',
];

function updateTermOptions() {
  const level = eid('pLevel')?.value || 'Basic';
  const isSHS = level === 'SHS';

  // Update the profile form term label and options
  const label = eid('pTermLabel');
  const sel   = eid('pTerm');
  if (label) label.textContent = isSHS ? 'Semester *' : 'Term *';
  if (sel) {
    const current = sel.value;
    sel.innerHTML = isSHS
      ? '<option value="Semester 1">Semester 1</option><option value="Semester 2">Semester 2</option>'
      : '<option value="Term 1">Term 1</option><option value="Term 2">Term 2</option><option value="Term 3">Term 3</option>';
    // Restore saved value if still valid
    if (Array.from(sel.options).find(o => o.value === current)) sel.value = current;
  }

  // Update Term Comparison dropdowns and labels
  const tcBase = eid('tcBaseTerm');
  const tcComp = eid('tcCompareTerm');
  const tcBaseLabel = eid('tcBaseLabel2');
  const tcCompLabel = eid('tcCompLabel2');
  const tcSub = eid('tcPageSub');

  if (isSHS) {
    if (tcBase) tcBase.innerHTML = '<option value="Semester 1">Semester 1</option>';
    if (tcComp) tcComp.innerHTML = '<option value="Semester 2">Semester 2</option>';
    if (tcBaseLabel) tcBaseLabel.textContent = 'Base Semester (Earlier)';
    if (tcCompLabel) tcCompLabel.textContent = 'Compare Semester (Later)';
    if (tcSub) tcSub.textContent = 'Track student improvement across Semester 1 \u00b7 Semester 2';
  } else {
    if (tcBase) tcBase.innerHTML = '<option value="Term 1">Term 1</option><option value="Term 2">Term 2</option>';
    if (tcComp) tcComp.innerHTML = '<option value="Term 2">Term 2</option><option value="Term 3">Term 3</option>';
    if (tcBaseLabel) tcBaseLabel.textContent = 'Base Term (Earlier)';
    if (tcCompLabel) tcCompLabel.textContent = 'Compare Term (Later)';
    if (tcSub) tcSub.textContent = 'Track student improvement across Term 1 \u00b7 Term 2 \u00b7 Term 3';
  }
}

function updateClassOptions() {
  const level = eid('pLevel')?.value || 'Basic';
  const sel = eid('pClass');
  if (!sel) return;

  const isSHS = level === 'SHS';
  const classes = isSHS ? buildSHSClassList() : BASIC_CLASSES;

  // Group SHS by Form for cleaner <optgroup> display
  if (isSHS) {
    let html = '';
    SHS_FORMS.forEach(form => {
      html += `<optgroup label="â”€â”€ ${form} â”€â”€">`;
      SHS_PROGRAMMES.forEach(prog => {
        SHS_STREAMS.slice(0,3).forEach(stream => {
          const val = `${form} ${prog} ${stream}`;
          html += `<option value="${val}">${val}</option>`;
        });
      });
      html += '</optgroup>';
    });
    html += `<optgroup label="â”€â”€ Custom â”€â”€"><option value="__custom__">âœï¸ Type a custom classâ€¦</option></optgroup>`;
    sel.innerHTML = html;
  } else {
    sel.innerHTML = BASIC_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('') +
      `<option value="__custom__">âœï¸ Type a custom classâ€¦</option>`;
  }

  // Restore saved class
  const saved = PROFILE.class;
  if (saved) {
    // Check if it's in the list
    const found = Array.from(sel.options).find(o => o.value === saved);
    if (found) {
      sel.value = saved;
    } else {
      // It's a custom value â€” select custom option and show input
      sel.value = '__custom__';
      const wrap = eid('customClassWrap');
      const inp = eid('pClassCustom');
      if (wrap) wrap.style.display = 'block';
      if (inp) inp.value = saved;
    }
  }
}

function handleClassSelect() {
  const sel = eid('pClass');
  const wrap = eid('customClassWrap');
  const inp = eid('pClassCustom');
  if (!sel || !wrap) return;
  if (sel.value === '__custom__') {
    wrap.style.display = 'block';
    if (inp) inp.focus();
  } else {
    wrap.style.display = 'none';
    if (inp) inp.value = '';
  }
}

function syncCustomClass() {
  // Keep the custom input value accessible when saving profile
  // getSelectedClass() reads from here
}

function getSelectedClass() {
  const sel = eid('pClass');
  if (!sel) return '';
  if (sel.value === '__custom__') {
    return eid('pClassCustom')?.value.trim() || '';
  }
  return sel.value;
}

function loadProfileUI() {
  const p = PROFILE;
  const setVal = (id, val) => { const el = eid(id); if (el && val !== undefined) el.value = val; };
  setVal('pSchool', p.school || USER_DOC?.school || '');
  setVal('pRegion', p.region);
  setVal('pDistrict', p.district || USER_DOC?.district || '');
  setVal('pYear', p.year || '2024/2025');
  setVal('pTerm', p.term);
  setVal('pLevel', p.level);
  updateClassOptions();
  updateTermOptions();
  setVal('pSubject', p.subject);
  setVal('pStrand', p.strand);
  setVal('pSubStrand', p.substrand);
  setVal('pCAW', p.caWeight !== undefined ? p.caWeight : 30);
  setVal('pExamW', p.examWeight !== undefined ? p.examWeight : 70);
}

async function saveProfile() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const prof = {
    school: eid('pSchool').value.trim(),
    region: eid('pRegion').value,
    district: eid('pDistrict').value.trim(),
    year: eid('pYear').value.trim(),
    term: eid('pTerm').value,
    level: eid('pLevel').value,
    class: getSelectedClass(),
    subject: eid('pSubject').value.trim(),
    strand: eid('pStrand').value.trim(),
    substrand: eid('pSubStrand').value.trim(),
    caWeight: parseInt(eid('pCAW').value) || 30,
    examWeight: parseInt(eid('pExamW').value) || 70,
    teacher: USER_DOC?.name || '',
    uid: myUid(),
    updatedAt: serverTimestamp(),
  };
  await setDoc(doc(db, 'profiles', myUid()), prof);
  PROFILE = prof;
  updateTopbarSchool();
  toast('School profile saved to Firebase! â˜ï¸', 'success');
}

// â”€â”€ STUDENTS â”€â”€ (real-time Firebase)
function subscribeStudents() {
  const { db, collection, query, where, orderBy, onSnapshot } = window.FB;
  const q = query(collection(db, 'students'), where('uid', '==', myUid()), orderBy('name'));
  const unsub = onSnapshot(q, snap => {
    STUDENTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderStudentTable();
    updateRptStudentSel();
    eid('studentCountBadge').textContent = STUDENTS.length;
  });
  UNSUBSCRIBERS.push(unsub);
}

// â”€â”€ INDEX NUMBER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildIndexNumber(n) {
  // Build an index string from current format settings + sequential number n
  const prefix  = (eid('idxPrefix')?.value || 'GES').trim();
  const year    = (eid('idxYear')?.value || '').trim();
  const digits  = parseInt(eid('idxDigits')?.value || '3');
  const numStr  = String(n).padStart(digits, '0');
  return [prefix, year, numStr].filter(Boolean).join('/');
}

function nextAutoIndex() {
  // Find the highest existing sequential number and add 1
  const start = parseInt(eid('idxStart')?.value || '1');
  const digits = parseInt(eid('idxDigits')?.value || '3');
  const prefix = (eid('idxPrefix')?.value || 'GES').trim();
  const year   = (eid('idxYear')?.value || '').trim();

  let max = start - 1;
  STUDENTS.forEach(s => {
    if (!s.index) return;
    // Try to extract trailing number from stored index
    const m = s.index.match(/(\d+)$/);
    if (m) {
      const n = parseInt(m[1]);
      if (n > max) max = n;
    }
  });
  return buildIndexNumber(max + 1);
}

function updateIndexPreview() {
  const next = nextAutoIndex();
  const el = eid('idxFormatPreview');
  const prev = eid('sIndexPreview');
  if (el) el.textContent = next;
  if (prev) prev.textContent = next;
}

function toggleIndexMode() {
  const isAuto = eid('sIndexAuto')?.checked;
  const autoWrap   = eid('sIndexAutoWrap');
  const formatWrap = eid('sIndexFormatWrap');
  const manualInp  = eid('sIndex');
  const thumb      = eid('sIndexToggleThumb');
  const track      = eid('sIndexToggleTrack');

  if (isAuto) {
    if (autoWrap)   autoWrap.style.display   = 'block';
    if (formatWrap) formatWrap.style.display  = 'block';
    if (manualInp)  manualInp.style.display   = 'none';
    if (thumb)      thumb.style.transform     = 'translateX(16px)';
    if (track)      track.style.background    = 'var(--accent)';
    updateIndexPreview();
  } else {
    if (autoWrap)   autoWrap.style.display   = 'none';
    if (formatWrap) formatWrap.style.display  = 'none';
    if (manualInp)  manualInp.style.display   = 'block';
    if (thumb)      thumb.style.transform     = 'translateX(0)';
    if (track)      track.style.background    = 'var(--border2)';
  }
}

function autoFillEditIndex() {
  // For the edit modal â€” fill with next available auto index
  const next = nextAutoIndex();
  const el = eid('editStuIndex');
  if (el) { el.value = next; el.focus(); }
  toast('Auto-filled: ' + next + '. Edit if needed.', 'info');
}

async function addStudent() {
  const { db, collection, doc, setDoc, serverTimestamp } = window.FB;
  const name   = eid('sName').value.trim();
  const gender = eid('sGender').value;
  if (!name) return toast('Student name is required.', 'error');
  if (STUDENTS.find(s => s.name.toLowerCase() === name.toLowerCase()))
    return toast('A student with this name already exists.', 'error');

  // Determine index number
  const isAuto = eid('sIndexAuto')?.checked !== false; // default auto
  let index = '';
  if (isAuto) {
    index = nextAutoIndex();
    // Advance the start counter for next student
    const startEl = eid('idxStart');
    if (startEl) {
      const current = parseInt(startEl.value || '1');
      startEl.value = current + 1;
    }
  } else {
    index = eid('sIndex')?.value.trim() || '';
    // Warn if duplicate index
    if (index && STUDENTS.find(s => s.index === index))
      return toast('This index number is already assigned to another student.', 'error');
  }

  const id = myUid() + '_' + Date.now();
  await setDoc(doc(db, 'students', id), {
    uid: myUid(), name, gender, index, id,
    createdAt: serverTimestamp(),
  });
  eid('sName').value = '';
  if (eid('sIndex')) eid('sIndex').value = '';
  updateIndexPreview();
  toast(name + ' added! Index: ' + (index || 'none'), 'success');
}

async function bulkAddStudents() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const raw = eid('bulkText').value.trim();
  if (!raw) return toast('Paste student list first.', 'error');
  const lines = raw.split('\n').filter(l => l.trim());
  let added = 0, skipped = 0;
  const isAuto = eid('sIndexAuto')?.checked !== false;

  for (const line of lines) {
    const parts = line.split(',').map(p => p.trim());
    const name = parts[0];
    const gender = parts[1] || 'Male';
    let index = parts[2] || '';

    if (!name || STUDENTS.find(s => s.name.toLowerCase() === name.toLowerCase())) {
      skipped++; continue;
    }
    // If no index provided in bulk and auto-mode is ON, generate one
    if (!index && isAuto) {
      index = nextAutoIndex();
      const startEl = eid('idxStart');
      if (startEl) startEl.value = parseInt(startEl.value || '1') + 1;
    }
    const id = myUid() + '_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
    const validGender = ['Male','Female'].includes(gender) ? gender : 'Male';
    await setDoc(doc(db, 'students', id), {
      uid: myUid(), name, gender: validGender, index, id, createdAt: serverTimestamp(),
    });
    added++;
  }
  eid('bulkText').value = '';
  updateIndexPreview();
  toast('Added ' + added + ' students. Skipped ' + skipped + '.', 'success');
}

function sortStudentsAlpha() {
  STUDENTS.sort((a,b) => a.name.localeCompare(b.name));
  renderStudentTable();
}

function renderStudentTable() {
  const q = (eid('stuSearch')?.value || '').toLowerCase();
  const gf = eid('stuGenderFilter')?.value || '';
  const filtered = STUDENTS.filter(s => s.name.toLowerCase().includes(q) && (!gf || s.gender === gf));
  const tbody = eid('studentTable');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">ğŸ‘©ğŸ¾â€ğŸ“</div><h3>No students found</h3></div></td></tr>`;
    return;
  }
  tbody.innerHTML = filtered.map((s, i) => `
    <tr>
      <td>${i+1}</td>
      <td><strong>${s.name}</strong></td>
      <td><span class="badge ${s.gender === 'Female' ? 'badge-gold' : 'badge-blue'}">${s.gender}</span></td>
      <td class="mono" style="font-size:.82rem;">${s.index || 'â€”'}</td>
      <td class="no-print">
        <button class="btn-icon" onclick="openEditStudent('${s.id}')" title="Edit">âœï¸</button>
        <button class="btn-icon" onclick="deleteStudent('${s.id}','${s.name}')" title="Delete">ğŸ—‘ï¸</button>
      </td>
    </tr>`).join('');
}

function openEditStudent(id) {
  const s = STUDENTS.find(x => x.id === id);
  if (!s) return;
  eid('editStuId').value = id;
  eid('editStuName').value = s.name;
  eid('editStuGender').value = s.gender;
  eid('editStuIndex').value = s.index || '';
  openModal('editStuModal');
}

async function saveEditStudent() {
  const { db, doc, updateDoc } = window.FB;
  const id = eid('editStuId').value;
  const name = eid('editStuName').value.trim();
  if (!name) return toast('Name is required.', 'error');
  await updateDoc(doc(db, 'students', id), {
    name, gender: eid('editStuGender').value, index: eid('editStuIndex').value.trim(),
  });
  closeModal('editStuModal');
  toast('Student updated!', 'success');
}

async function deleteStudent(id, name) {
  const { db, doc, deleteDoc } = window.FB;
  confirm2(`Delete ${name}? All their scores will also be removed.`, async () => {
    await deleteDoc(doc(db, 'students', id));
    toast('Student deleted.', 'info');
  });
}

// â”€â”€ ASSESSMENTS â”€â”€ (real-time Firebase)
function subscribeAssessments() {
  const { db, collection, query, where, orderBy, onSnapshot } = window.FB;
  const q = query(collection(db, 'assessments'), where('uid', '==', myUid()), orderBy('createdAt'));
  const unsub = onSnapshot(q, snap => {
    ASSESSMENTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderAssessmentTable();
    renderAssessmentDropdowns();
  });
  UNSUBSCRIBERS.push(unsub);
}

async function addAssessment() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const name = eid('aName').value.trim();
  const total = parseInt(eid('aTotal').value);
  if (!name || !total) return toast('Name and total marks are required.', 'error');
  const id = `${myUid()}_asm_${Date.now()}`;
  await setDoc(doc(db, 'assessments', id), {
    uid: myUid(), id, name,
    category: eid('aCategory').value,
    type: eid('aType').value,
    total, date: eid('aDate').value,
    locked: false, approved: false,
    createdAt: serverTimestamp(),
  });
  eid('aName').value = ''; eid('aTotal').value = '';
  toast(`Assessment "${name}" created!`, 'success');
}

function renderAssessmentTable() {
  const tbody = eid('assessmentTable');
  if (!ASSESSMENTS.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ“</div><h3>No assessments yet</h3></div></td></tr>`;
    return;
  }
  tbody.innerHTML = ASSESSMENTS.map((a, i) => `
    <tr>
      <td>${i+1}</td>
      <td><strong>${a.name}</strong></td>
      <td>${a.category}</td>
      <td><span class="badge ${a.type==='Exam'?'badge-red':'badge-blue'}">${a.type}</span></td>
      <td class="mono">${a.total}</td>
      <td>${a.date || 'â€”'}</td>
      <td>
        ${a.locked ? '<span class="locked-tag">ğŸ”’ Locked</span>' : '<span class="badge badge-green">Open</span>'}
        ${a.approved ? ' <span class="badge badge-green">âœ… Approved</span>' : ''}
      </td>
      <td class="no-print">
        <button class="btn-icon" onclick="toggleAssessmentLock('${a.id}',${a.locked})" title="${a.locked?'Unlock':'Lock'}" ${a.approved?'disabled title="Approved - contact admin"':''}>
          ${a.locked ? 'ğŸ”“' : 'ğŸ”’'}
        </button>
        <button class="btn-icon" onclick="submitForApproval('${a.id}')" title="Submit for Admin Approval" ${a.approved||a.locked?'disabled':''}>ğŸ“¤</button>
        <button class="btn-icon" onclick="deleteAssessment('${a.id}','${a.name}')" title="Delete" ${a.locked?'disabled':''}>ğŸ—‘ï¸</button>
      </td>
    </tr>`).join('');
}

async function toggleAssessmentLock(id, currentLocked) {
  const { db, doc, updateDoc } = window.FB;
  const a = ASSESSMENTS.find(x => x.id === id);
  if (a?.approved) return toast('Approved assessments cannot be locked/unlocked by teachers.', 'error');
  confirm2(`${currentLocked ? 'Unlock' : 'Lock'} this assessment?`, async () => {
    await updateDoc(doc(db, 'assessments', id), { locked: !currentLocked });
    toast(`Assessment ${!currentLocked ? 'locked' : 'unlocked'}.`, 'info');
  });
}

async function submitForApproval(id) {
  const { db, doc, updateDoc } = window.FB;
  confirm2('Submit this assessment to the Head Teacher / Admin for approval? You cannot edit scores after submission.', async () => {
    await updateDoc(doc(db, 'assessments', id), { pendingApproval: true, locked: true });
    toast('Submitted for approval!', 'success');
  });
}

async function deleteAssessment(id, name) {
  const { db, doc, deleteDoc } = window.FB;
  const a = ASSESSMENTS.find(x => x.id === id);
  if (a?.locked) return toast('Unlock assessment first.', 'error');
  confirm2(`Delete "${name}" and all its scores?`, async () => {
    await deleteDoc(doc(db, 'assessments', id));
    toast('Deleted.', 'info');
  });
}

function renderAssessmentDropdowns() {
  const sel = eid('scoreAssessmentSel');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Choose an assessment â€”</option>' +
    ASSESSMENTS.map(a => `<option value="${a.id}">${a.name} (/${a.total}) ${a.locked?'ğŸ”’':''}</option>`).join('');
  if (cur) sel.value = cur;
}

// â”€â”€ SCORES â”€â”€ (real-time Firebase per assessment)
let SCORE_UNSUB = null;
async function loadScoreSheet() {
  const aid = eid('scoreAssessmentSel').value;
  const wrap = eid('scoreSheetWrap');
  if (!aid) { wrap.innerHTML = ''; return; }
  const assessment = ASSESSMENTS.find(a => a.id === aid);
  if (!assessment) return;
  if (assessment.locked) {
    wrap.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ”’</div><h3>Assessment Locked</h3><p>Unlock it to enter scores.</p></div></div>`;
    return;
  }
  if (!STUDENTS.length) {
    wrap.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ‘©ğŸ¾â€ğŸ“</div><h3>No students in class</h3><p>Add students first.</p></div></div>`;
    return;
  }

  // Load existing scores from Firebase
  const { db, doc, getDoc } = window.FB;
  const scSnap = await getDoc(doc(db, 'scores', aid));
  if (scSnap.exists()) SCORES[aid] = scSnap.data();
  else SCORES[aid] = {};

  wrap.innerHTML = `
    <div class="card">
      <div class="card-title">
        <span class="ct-icon">âœï¸</span> ${assessment.name}
        <span style="font-weight:400;font-size:.85rem;color:var(--muted);margin-left:8px;">Total: ${assessment.total} marks</span>
        <span class="badge badge-blue" style="margin-left:auto;">${STUDENTS.length} students</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th>Student Name</th><th>Gender</th><th>Score (/${assessment.total})</th><th>%</th></tr></thead>
          <tbody>
            ${STUDENTS.map((s, i) => {
              const sc = SCORES[aid]?.[s.id] !== undefined ? SCORES[aid][s.id] : '';
              const pct = sc !== '' ? ((sc/assessment.total)*100).toFixed(1) : 'â€”';
              return `<tr>
                <td>${i+1}</td>
                <td><strong>${s.name}</strong></td>
                <td><span class="badge ${s.gender==='Female'?'badge-gold':'badge-blue'}">${s.gender[0]}</span></td>
                <td><input type="number" class="score-input" id="sc_${s.id}"
                  value="${sc}" min="0" max="${assessment.total}"
                  oninput="liveScorePct('${s.id}','${aid}',${assessment.total})"/></td>
                <td id="pct_${s.id}">${pct}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
      <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="saveScores('${aid}',${assessment.total})">â˜ï¸ Save Scores to Firebase</button>
        <button class="btn btn-sm btn-outline" onclick="autoFillDemo('${aid}',${assessment.total})">ğŸ² Demo Fill</button>
      </div>
    </div>`;
}

function liveScorePct(sid, aid, total) {
  const val = parseFloat(eid(`sc_${sid}`)?.value) || 0;
  const pctEl = eid(`pct_${sid}`);
  if (pctEl) pctEl.textContent = ((val/total)*100).toFixed(1);
}

async function saveScores(aid, total) {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const scData = { uid: myUid(), assessmentId: aid, updatedAt: serverTimestamp() };
  STUDENTS.forEach(s => {
    const el = eid(`sc_${s.id}`);
    if (!el) return;
    const val = el.value.trim();
    if (val === '') return;
    let sc = Math.max(0, Math.min(parseFloat(val), total));
    if (!isNaN(sc)) scData[s.id] = sc;
  });
  await setDoc(doc(db, 'scores', aid), scData);
  SCORES[aid] = scData;
  toast('Scores saved to Firebase! â˜ï¸', 'success');
}

function autoFillDemo(aid, total) {
  STUDENTS.forEach(s => {
    const sc = Math.floor(Math.random() * total * 0.65 + total * 0.35);
    const el = eid(`sc_${s.id}`);
    if (el) { el.value = sc; liveScorePct(s.id, aid, total); }
  });
  toast('Demo scores filled for testing.', 'info');
}

// â”€â”€ TOTALS â”€â”€
function getStudentTotal(student) {
  let caTotal = 0, caMax = 0, examTotal = 0, examMax = 0;
  ASSESSMENTS.forEach(a => {
    const sc = SCORES[a.id]?.[student.id];
    if (sc !== undefined && !isNaN(sc)) {
      if (a.type === 'Exam') { examTotal += sc; examMax += a.total; }
      else { caTotal += sc; caMax += a.total; }
    }
  });
  const p = PROFILE;
  const caW = (p.caWeight || 30) / 100;
  const exW = (p.examWeight || 70) / 100;
  const caPct = caMax > 0 ? (caTotal/caMax)*100 : 0;
  const exPct = examMax > 0 ? (examTotal/examMax)*100 : 0;
  let overall = null;
  if (caMax > 0 && examMax > 0) overall = caPct*caW + exPct*exW;
  else if (caMax > 0) overall = caPct;
  else if (examMax > 0) overall = exPct;
  return { caTotal, caMax, examTotal, examMax, caPct, exPct, overall };
}

async function loadAllScores() {
  const { db, doc, getDoc } = window.FB;
  await Promise.all(ASSESSMENTS.map(async a => {
    if (!SCORES[a.id]) {
      const snap = await getDoc(doc(db, 'scores', a.id));
      SCORES[a.id] = snap.exists() ? snap.data() : {};
    }
  }));
}

// â”€â”€ RESULTS â”€â”€
async function renderResults() {
  await loadAllScores();
  const tbody = eid('resultsTable');
  if (!STUDENTS.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ“Š</div><h3>No students yet</h3></div></td></tr>`;
    return;
  }
  let rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  }).filter(r => r.t.overall !== null);
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">âœï¸</div><h3>Enter scores to see results</h3></div></td></tr>`;
    return;
  }
  rows.sort((a,b) => b.t.overall - a.t.overall);
  let pos = 1;
  rows.forEach((r, i) => {
    if (i > 0 && r.t.overall < rows[i-1].t.overall) pos = i+1;
    r.position = pos;
  });
  const gf = eid('resGradeFilter')?.value || '';
  const sortBy = eid('resSortBy')?.value || 'pos';
  if (gf) rows = rows.filter(r => r.grade?.grade === gf);
  if (sortBy === 'name') rows.sort((a,b) => a.s.name.localeCompare(b.s.name));
  else if (sortBy === 'asc') rows.sort((a,b) => a.t.overall - b.t.overall);
  tbody.innerHTML = rows.map(r => {
    const g = r.grade;
    return `<tr>
      <td class="mono"><strong>#${r.position}</strong></td>
      <td>${r.s.name}</td>
      <td><span class="badge ${r.s.gender==='Female'?'badge-gold':'badge-blue'}">${r.s.gender[0]}</span></td>
      <td class="mono" style="font-size:.8rem;">${r.s.index || 'â€”'}</td>
      <td class="mono">${r.t.caMax>0 ? r.t.caPct.toFixed(1)+'%' : 'â€”'}</td>
      <td class="mono">${r.t.examMax>0 ? r.t.exPct.toFixed(1)+'%' : 'â€”'}</td>
      <td class="mono"><strong>${r.t.overall.toFixed(1)}%</strong></td>
      <td>${g ? `<span class="grade-pill g${g.grade}">${g.grade}</span>` : 'â€”'}</td>
      <td style="font-size:.78rem;color:var(--muted);">${g ? COMMENTS[g.grade].split('.')[0] : 'â€”'}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ ANALYSIS â”€â”€
async function renderAnalysis() {
  await loadAllScores();
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  }).filter(r => r.t.overall !== null);

  const statsEl = eid('analysisStats');
  if (!rows.length) { statsEl.innerHTML = '<p class="text-muted">Enter scores to see analysis.</p>'; return; }

  const scores = rows.map(r => r.t.overall);
  const avg = scores.reduce((a,b) => a+b, 0) / scores.length;
  const highest = Math.max(...scores);
  const lowest = Math.min(...scores);
  const passed = rows.filter(r => r.grade?.grade !== 'F').length;

  statsEl.innerHTML = `
    <div class="stat-card green"><div class="stat-value">${rows.length}</div><div class="stat-label">Scored Students</div></div>
    <div class="stat-card gold"><div class="stat-value">${avg.toFixed(1)}%</div><div class="stat-label">Class Average</div></div>
    <div class="stat-card blue"><div class="stat-value">${highest.toFixed(1)}%</div><div class="stat-label">Highest Score</div></div>
    <div class="stat-card red"><div class="stat-value">${lowest.toFixed(1)}%</div><div class="stat-label">Lowest Score</div></div>
    <div class="stat-card green"><div class="stat-value">${((passed/rows.length)*100).toFixed(0)}%</div><div class="stat-label">Pass Rate</div></div>
    <div class="stat-card red"><div class="stat-value">${(((rows.length-passed)/rows.length)*100).toFixed(0)}%</div><div class="stat-label">Fail Rate</div></div>
  `;

  const gradeCounts = { A:0, B:0, C:0, D:0, E:0, F:0 };
  rows.forEach(r => { if(r.grade) gradeCounts[r.grade.grade]++; });
  const gradeColors = GRADING.map(g => g.color);

  setTimeout(() => {
    drawBar('gradeChart', Object.keys(gradeCounts), Object.values(gradeCounts), gradeColors);
    const buckets = [0,0,0,0,0];
    rows.forEach(r => {
      const o = r.t.overall;
      if(o<40) buckets[0]++; else if(o<60) buckets[1]++; else if(o<80) buckets[2]++;
      else if(o<90) buckets[3]++; else buckets[4]++;
    });
    drawBar('scoreChart', ['0â€“39','40â€“59','60â€“79','80â€“89','90â€“100'], buckets, ['#F87171','#FB923C','#FBBF24','#60A5FA','#4ADE80']);
    const males = rows.filter(r => r.s.gender === 'Male');
    const females = rows.filter(r => r.s.gender === 'Female');
    const mAvg = males.length ? males.reduce((a,b) => a+b.t.overall,0)/males.length : 0;
    const fAvg = females.length ? females.reduce((a,b) => a+b.t.overall,0)/females.length : 0;
    drawBar('genderChart', [`Male (${males.length})`, `Female (${females.length})`], [mAvg.toFixed(1), fAvg.toFixed(1)], ['#60A5FA','#F9A8D4']);
  }, 80);

  const top3 = [...rows].sort((a,b) => b.t.overall-a.t.overall).slice(0,3);
  eid('analysisSummary').innerHTML = `
    <div class="analysis-summary-grid">
      <div>
        <h4 style="margin-bottom:12px;font-size:.9rem;">ğŸ† Top Performers</h4>
        ${top3.map((r,i) => `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <span style="font-size:1.4rem;">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]}</span>
          <div><div style="font-weight:700;">${r.s.name}</div>
          <div style="font-size:.78rem;color:var(--muted);">${r.t.overall.toFixed(1)}% Â· ${r.grade?.label}</div></div>
        </div>`).join('')}
      </div>
      <div>
        <h4 style="margin-bottom:12px;font-size:.9rem;">ğŸ“Š Class Stats</h4>
        <div style="font-size:.85rem;line-height:2.2;">
          <div>Total Scored: <strong>${rows.length}</strong></div>
          <div>Male: <strong>${rows.filter(r=>r.s.gender==='Male').length}</strong> Â· Female: <strong>${rows.filter(r=>r.s.gender==='Female').length}</strong></div>
          <div>Grade A: <strong>${gradeCounts.A}</strong> Â· Grade F: <strong>${gradeCounts.F}</strong></div>
          <div>Pass: <strong style="color:var(--accent2);">${passed}</strong> Â· Fail: <strong style="color:var(--danger);">${rows.length-passed}</strong></div>
        </div>
      </div>
    </div>`;
}

// â”€â”€ BROADSHEET â”€â”€
async function renderBroadsheet() {
  await loadAllScores();
  const el = eid('broadsheetContent');
  if (!STUDENTS.length || !ASSESSMENTS.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‘</div><p>Add students and assessments first.</p></div>';
    return;
  }
  const p = PROFILE;
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  });
  rows.sort((a,b) => (b.t.overall||0) - (a.t.overall||0));
  let pos = 1;
  rows.forEach((r,i) => {
    if (i>0 && (r.t.overall||0) < (rows[i-1].t.overall||0)) pos = i+1;
    r.position = pos;
  });
  el.innerHTML = `
    <div style="text-align:center;margin-bottom:20px;">
      <h2 style="font-size:1.2rem;">${p.school || 'School'}</h2>
      <p>${p.class||''} Â· ${p.subject||''} Â· ${p.term||''} ${p.year||''}</p>
      <p class="text-muted" style="font-size:.82rem;">Teacher: ${USER_DOC?.name||''} Â· Generated: ${new Date().toLocaleDateString()}</p>
    </div>
    <div class="table-wrap">
      <table style="font-size:.8rem;">
        <thead><tr>
          <th>Pos</th><th>Name</th><th>G</th>
          ${ASSESSMENTS.map(a => `<th title="${a.name}">${a.name.substring(0,7)}â€¦<br><small>/${a.total}</small></th>`).join('')}
          <th>CA%</th><th>Exam%</th><th>Total%</th><th>Grade</th><th>Remarks</th>
        </tr></thead>
        <tbody>
          ${rows.map(r => `<tr>
            <td class="mono">${r.t.overall!==null ? '#'+r.position : 'â€”'}</td>
            <td><strong>${r.s.name}</strong></td>
            <td>${r.s.gender[0]}</td>
            ${ASSESSMENTS.map(a => { const sc=SCORES[a.id]?.[r.s.id]; return `<td class="mono">${sc!==undefined?sc:'â€”'}</td>`; }).join('')}
            <td class="mono">${r.t.caMax>0 ? r.t.caPct.toFixed(1) : 'â€”'}</td>
            <td class="mono">${r.t.examMax>0 ? r.t.exPct.toFixed(1) : 'â€”'}</td>
            <td class="mono"><strong>${r.t.overall!==null ? r.t.overall.toFixed(1) : 'â€”'}</strong></td>
            <td>${r.grade ? `<span class="grade-pill g${r.grade.grade}">${r.grade.grade}</span>` : 'â€”'}</td>
            <td style="font-size:.72rem;color:var(--muted);">${r.grade ? COMMENTS[r.grade.grade].split('.')[0] : ''}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}

// â”€â”€ GRADING â”€â”€
async function loadGrading() {
  const { db, doc, getDoc } = window.FB;
  const snap = await getDoc(doc(db, 'grading', myUid()));
  if (snap.exists()) {
    const d = snap.data();
    if (d.scale) GRADING = d.scale;
    if (d.comments) COMMENTS = d.comments;
  }
}

function renderGradingRows() {
  eid('gradingRows').innerHTML = `
    <div style="overflow-x:auto;"><table style="width:100%;">
      <thead><tr><th>Grade</th><th>Label</th><th>Min%</th><th>Max%</th><th>Color</th></tr></thead>
      <tbody>
        ${GRADING.map((g,i) => `<tr>
          <td><span class="grade-pill g${g.grade}">${g.grade}</span></td>
          <td><input class="form-control" id="glbl_${i}" value="${g.label}" style="max-width:140px;"/></td>
          <td><input type="number" class="form-control" id="gmin_${i}" value="${g.min}" style="max-width:80px;"/></td>
          <td><input type="number" class="form-control" id="gmax_${i}" value="${g.max}" style="max-width:80px;"/></td>
          <td><input type="color" id="gcol_${i}" value="${g.color}" style="width:40px;height:32px;border:none;border-radius:6px;cursor:pointer;"/></td>
        </tr>`).join('')}
      </tbody>
    </table></div>`;
}

function renderCommentRows() {
  eid('commentRows').innerHTML = GRADING.map(g => `
    <div class="form-group">
      <label for="cmt_${g.grade}" class="form-label"><span class="grade-pill g${g.grade}" style="margin-right:6px;">${g.grade}</span> ${g.label}</label>
      <textarea class="form-control" id="cmt_${g.grade}" rows="2">${COMMENTS[g.grade]||''}</textarea>
    </div>`).join('');
}

async function saveGrading() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  GRADING = GRADING.map((g,i) => ({
    ...g,
    label: eid(`glbl_${i}`)?.value || g.label,
    min: parseInt(eid(`gmin_${i}`)?.value) || g.min,
    max: parseInt(eid(`gmax_${i}`)?.value) || g.max,
    color: eid(`gcol_${i}`)?.value || g.color,
  }));
  await setDoc(doc(db, 'grading', myUid()), { uid: myUid(), scale: GRADING, comments: COMMENTS, updatedAt: serverTimestamp() });
  toast('Grading scale saved to Firebase! â˜ï¸', 'success');
}

async function saveComments() {
  GRADING.forEach(g => { const el = eid(`cmt_${g.grade}`); if(el) COMMENTS[g.grade] = el.value; });
  await saveGrading();
}

function resetGrading() {
  confirm2('Reset grading to Ghana NaCCA defaults?', async () => {
    GRADING = defaultGrading(); COMMENTS = defaultComments();
    renderGradingRows(); renderCommentRows();
    await saveGrading();
    toast('Grading reset to defaults.', 'success');
  });
}

// â”€â”€ ADMIN: USERS â”€â”€
function subscribeAllUsers() {
  const { db, collection, onSnapshot } = window.FB;
  const unsub = onSnapshot(collection(db, 'users'), snap => {
    ALL_USERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    updatePendingCount();
    if (eid('page-users').classList.contains('active')) renderUserTable();
    if (eid('page-approvals').classList.contains('active')) renderApprovals();
    // Also refresh messaging contacts whenever user list updates (for all roles)
    if (eid('page-messaging').classList.contains('active')) renderMsgContacts();
  });
  UNSUBSCRIBERS.push(unsub);
}

function subscribeApprovedUsers() {
  // For regular teachers â€” load approved colleagues for messaging/notices
  const { db, collection, query, where, onSnapshot } = window.FB;
  const q = query(collection(db, 'users'), where('status', '==', 'approved'));
  const unsub = onSnapshot(q, snap => {
    ALL_USERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (eid('page-messaging').classList.contains('active')) renderMsgContacts();
  });
  UNSUBSCRIBERS.push(unsub);
}

function updatePendingCount() {
  const count = ALL_USERS.filter(u => u.status === 'pending').length;
  ['pendingCount'].forEach(id => { const el = eid(id); if(el) el.textContent = count; });
  // Co-admin slot counter
  const MAX_COADMINS = 5;
  const coAdminCount = ALL_USERS.filter(u => u.role === 'coadmin').length;
  const counter = eid('coAdminCounter');
  if (counter) {
    counter.textContent = `Co-Admins: ${coAdminCount} / ${MAX_COADMINS}`;
    counter.style.color = coAdminCount >= MAX_COADMINS ? 'var(--danger)' : 'var(--muted)';
  }
  renderPendingList();
}

function renderPendingList() {
  const el = eid('pendingList');
  if (!el) return;
  const pending = ALL_USERS.filter(u => u.status === 'pending');
  if (!pending.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ…</div><h3>No pending approvals</h3></div>';
    return;
  }
  el.innerHTML = pending.map(u => `
    <div class="approval-item">
      <div class="avatar" style="width:40px;height:40px;font-size:.9rem;">${(u.name||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase()}</div>
      <div class="approval-info">
        <div class="approval-name">${u.name}</div>
        <div class="approval-meta">ğŸ“§ ${u.email} Â· ğŸ« ${u.school} Â· ğŸ‘¤ ${u.role} Â· ğŸ“ ${u.district||'â€”'}</div>
      </div>
      <div class="approval-actions">
        <button class="btn btn-sm btn-primary" onclick="approveUser('${u.id}')">âœ… Approve</button>
        <button class="btn btn-sm btn-danger" onclick="rejectUser('${u.id}','${u.name}')">âŒ Reject</button>
      </div>
    </div>`).join('');
}

function renderUserTable() {
  const tbody = eid('usersTable');
  if (!tbody) return;
  const q = (eid('userSearch')?.value || '').toLowerCase();
  const rf = eid('userRoleFilter')?.value || '';
  const filtered = ALL_USERS.filter(u => {
    const matches = u.name?.toLowerCase().includes(q) || u.school?.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q);
    return matches && (!rf || u.role === rf);
  });
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><h3>No users found</h3></div></td></tr>`;
    return;
  }

  // Co-admin limit info
  const coAdminCount = ALL_USERS.filter(u => u.role === 'coadmin').length;
  const MAX_COADMINS = 5;

  tbody.innerHTML = filtered.map(u => {
    const statusClass = { approved:'badge-green', pending:'badge-gold', suspended:'badge-red' }[u.status] || 'badge-gray';
    const roleLabel = { teacher:'Teacher', headteacher:'Head Teacher', admin:'Admin', coadmin:'Co-Admin' }[u.role] || u.role;
    const badgeClass = u.role==='admin'?'badge-gold': u.role==='coadmin'?'badge-purple': u.role==='headteacher'?'badge-blue':'badge-green';
    const isThisAdmin = u.role === 'admin';
    const isThisCoAdmin = u.role === 'coadmin';
    const amAdmin = isAdmin();
    const amCoAdmin = isCoAdmin();

    // Co-admin cannot touch admin accounts at all; can manage everyone else
    const canManage = amAdmin || (amCoAdmin && !isThisAdmin && !isThisCoAdmin);
    const canChangeRole = amAdmin; // Only full admin can assign/change roles

    const safeName = (u.name||'').replace(/'/g, "&#39;");
    let actions = '';
    if (canManage && u.status==='pending')   actions += '<button class="btn btn-sm btn-primary" onclick="approveUser(\'' + u.id + '\')">Approve</button> ';
    if (canManage && u.status==='approved')  actions += '<button class="btn btn-sm btn-danger" onclick="suspendUser(\'' + u.id + '\',\'' + safeName + '\')">Suspend</button> ';
    if (canManage && u.status==='suspended') actions += '<button class="btn btn-sm btn-outline" onclick="approveUser(\'' + u.id + '\')">Reinstate</button> ';
    if (canChangeRole) actions += '<button class="btn btn-sm btn-outline" onclick="openRoleModal(\'' + u.id + '\',\'' + u.role + '\',\'' + safeName + '\')">Role</button>';
    if (!actions) actions = '<span style="font-size:.75rem;color:var(--muted);">â€”</span>';
    return '<tr>'
      + '<td><strong>' + (u.name||'') + '</strong><br><span style="font-size:.75rem;color:var(--muted);">' + (u.email||'') + '</span></td>'
      + '<td>' + (u.school||'â€”') + '</td>'
      + '<td><span class="role-chip role-' + (u.role||'teacher') + '" style="font-size:.72rem;">' + roleLabel + '</span></td>'
      + '<td>' + (u.district||'â€”') + '</td>'
      + '<td><span class="badge ' + statusClass + '">' + (u.status||'â€”') + '</span></td>'
      + '<td style="font-size:.78rem;color:var(--muted);">' + (u.createdAt?.toDate?.().toLocaleDateString()||'â€”') + '</td>'
      + '<td style="white-space:nowrap;">' + actions + '</td>'
      + '</tr>';
  }).join('');
}

async function approveUser(uid) {
  const { db, doc, updateDoc } = window.FB;
  await updateDoc(doc(db, 'users', uid), { status: 'approved' });
  toast('User approved!', 'success');
}

async function rejectUser(uid, name) {
  const { db, doc, deleteDoc } = window.FB;
  confirm2(`Permanently delete ${name}'s account? They will need to register again.`, async () => {
    await deleteDoc(doc(db, 'users', uid));
    toast('Account rejected and removed.', 'info');
  });
}

async function suspendUser(uid, name) {
  const { db, doc, updateDoc } = window.FB;
  confirm2(`Suspend ${name}'s account?`, async () => {
    await updateDoc(doc(db, 'users', uid), { status: 'suspended' });
    toast('User suspended.', 'warning');
  });
}

function openRoleModal(uid, currentRole, userName) {
  const MAX_COADMINS = 5;
  const coAdminCount = ALL_USERS.filter(u => u.role === 'coadmin').length;

  eid('roleModalUserId').value = uid;
  eid('roleModalSelect').value = currentRole;

  // Info line
  eid('roleModalInfo').innerHTML = `Changing role for: <strong>${userName || uid}</strong><br>Current role: <strong>${{ teacher:'Teacher', headteacher:'Head Teacher', admin:'Admin', coadmin:'Co-Admin' }[currentRole] || currentRole}</strong>`;

  // Show/hide warnings on select change
  const sel = eid('roleModalSelect');
  const updateWarnings = () => {
    const newRole = sel.value;
    const atLimit = coAdminCount >= MAX_COADMINS && currentRole !== 'coadmin' && newRole === 'coadmin';
    eid('roleModalWarning').style.display = newRole === 'coadmin' ? 'block' : 'none';
    eid('roleModalLimit').style.display   = atLimit ? 'block' : 'none';
    eid('roleModalSaveBtn').disabled      = atLimit;
  };
  sel.onchange = updateWarnings;
  updateWarnings();

  openModal('roleModal');
}

async function saveUserRole() {
  const MAX_COADMINS = 5;
  const { db, doc, updateDoc } = window.FB;
  const uid    = eid('roleModalUserId').value;
  const role   = eid('roleModalSelect').value;

  // Double-check co-admin limit server-side
  if (role === 'coadmin') {
    const currentUser = ALL_USERS.find(u => u.id === uid);
    const coAdminCount = ALL_USERS.filter(u => u.role === 'coadmin').length;
    const alreadyCoAdmin = currentUser?.role === 'coadmin';
    if (!alreadyCoAdmin && coAdminCount >= MAX_COADMINS) {
      toast(`Co-Admin limit reached (max ${MAX_COADMINS}). Remove one first.`, 'error');
      return;
    }
  }

  await updateDoc(doc(db, 'users', uid), { role });
  closeModal('roleModal');
  toast('Role updated!', 'success');
}

// â”€â”€ ADMIN: APPROVALS â”€â”€
async function renderApprovals() {
  const el = eid('approvalsList');
  if (!el) return;
  const pending = ALL_USERS.length ? [] : [];  // from subscribed data
  // Get all assessments pending approval across all teachers
  const { db, collection, query, where, getDocs } = window.FB;
  const q = query(collection(db, 'assessments'), where('pendingApproval', '==', true));
  const snap = await getDocs(q);
  const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  if (!items.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><h3>No assessments pending review</h3></div>';
    return;
  }
  el.innerHTML = items.map(a => {
    const teacher = ALL_USERS.find(u => u.uid === a.uid);
    return `<div class="approval-item">
      <div style="flex:1;">
        <div class="approval-name">ğŸ“ ${a.name}</div>
        <div class="approval-meta">
          Teacher: ${teacher?.name||'Unknown'} Â· School: ${teacher?.school||'â€”'} Â· 
          Category: ${a.category} Â· Total: ${a.total} Â· Type: ${a.type}
        </div>
      </div>
      <div class="approval-actions">
        <button class="btn btn-sm btn-primary" onclick="approveAssessment('${a.id}')">âœ… Approve</button>
        <button class="btn btn-sm btn-outline" onclick="returnAssessment('${a.id}')">â†©ï¸ Return</button>
      </div>
    </div>`;
  }).join('');
}

async function approveAssessment(id) {
  const { db, doc, updateDoc } = window.FB;
  await updateDoc(doc(db, 'assessments', id), { pendingApproval: false, approved: true, locked: true });
  toast('Assessment approved and locked!', 'success');
  renderApprovals();
}

async function returnAssessment(id) {
  const { db, doc, updateDoc } = window.FB;
  await updateDoc(doc(db, 'assessments', id), { pendingApproval: false, locked: false });
  toast('Assessment returned to teacher for revision.', 'info');
  renderApprovals();
}

// â”€â”€ ADMIN: SCHOOL OVERVIEW â”€â”€
function subscribeSchoolOverview() {
  // Real-time subscription to all profiles
  const { db, collection, onSnapshot } = window.FB;
  const unsub = onSnapshot(collection(db, 'profiles'), snap => {
    window._ALL_PROFILES = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (eid('page-school-overview').classList.contains('active')) renderSchoolOverview();
  });
  UNSUBSCRIBERS.push(unsub);
}

async function renderSchoolOverview() {
  const profiles = window._ALL_PROFILES || [];
  const overviewEl = eid('overviewTable');
  const statsEl = eid('overviewStats');
  if (!overviewEl) return;

  const schools = [...new Set(profiles.map(p => p.school).filter(Boolean))];
  const teachers = ALL_USERS.filter(u => u.status === 'approved');

  statsEl.innerHTML = `
    <div class="stat-card green"><div class="stat-value">${teachers.length}</div><div class="stat-label">Active Teachers</div></div>
    <div class="stat-card gold"><div class="stat-value">${schools.length}</div><div class="stat-label">Schools Connected</div></div>
    <div class="stat-card blue"><div class="stat-value">${ALL_USERS.filter(u=>u.status==='pending').length}</div><div class="stat-label">Pending Approvals</div></div>
    <div class="stat-card red"><div class="stat-value">${profiles.length}</div><div class="stat-label">Active Classes</div></div>
  `;

  overviewEl.innerHTML = profiles.map(p => {
    const teacher = ALL_USERS.find(u => u.uid === p.uid);
    return `<tr>
      <td><strong>${teacher?.name||'â€”'}</strong></td>
      <td>${p.school||'â€”'}</td>
      <td>${p.class||'â€”'}</td>
      <td>${p.subject||'â€”'}</td>
      <td>â€”</td><td>â€”</td><td>â€”</td>
      <td><span class="badge badge-green">Active</span></td>
    </tr>`;
  }).join('') || `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ›ï¸</div><p>No class profiles yet</p></div></td></tr>`;
}

// â”€â”€ REPORTS â”€â”€
function updateRptStudentSel() {
  const sel = eid('rptStudent');
  if (!sel) return;
  sel.innerHTML = '<option value="">All Students</option>' +
    STUDENTS.map((s,i) => `<option value="${i}">${s.name}</option>`).join('');
}

async function downloadReport() {
  await loadAllScores();
  const type = eid('rptType').value;
  const notes = eid('rptNotes').value;
  const html = buildReportHTML(type, notes);
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const p = PROFILE;
  a.href = url;
  a.download = `GES_Report_${(p.class||'Class').replace(/\s/g,'_')}_${(p.subject||'Subject').replace(/\s/g,'_')}.html`;
  a.click();
  URL.revokeObjectURL(url);
  eid('rptPreview').innerHTML = html.replace(/<!DOCTYPE html>[\s\S]*?<body>/,'').replace(/<\/body>[\s\S]*/,'');
  toast('Report downloaded! Open in browser then print as PDF.', 'success');
}

async function printReport() {
  await loadAllScores();
  const html = buildReportHTML(eid('rptType').value, eid('rptNotes').value);
  const win = window.open('', '_blank');
  win.document.write(html); win.document.close();
  setTimeout(() => win.print(), 600);
}

function buildReportHTML(type, notes) {
  const p = PROFILE;
  const now = new Date().toLocaleDateString('en-GH', {year:'numeric',month:'long',day:'numeric'});
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  });
  rows.sort((a,b) => (b.t.overall||0)-(a.t.overall||0));
  let pos = 1;
  rows.forEach((r,i) => {
    if(i>0&&(r.t.overall||0)<(rows[i-1].t.overall||0)) pos=i+1;
    r.position=pos;
  });

  const tableRows = rows.filter(r=>r.t.overall!==null).map((r,i) => `
    <tr style="background:${i%2===0?'#F8FFFC':'#fff'};">
      <td style="padding:5px 8px;">#${r.position}</td>
      <td style="padding:5px 8px;"><strong>${r.s.name}</strong></td>
      <td style="padding:5px 8px;text-align:center;">${r.s.gender[0]}</td>
      <td style="padding:5px 8px;text-align:center;">${r.s.index||'â€”'}</td>
      <td style="padding:5px 8px;text-align:center;">${r.t.caMax>0?r.t.caPct.toFixed(1):'â€”'}</td>
      <td style="padding:5px 8px;text-align:center;">${r.t.examMax>0?r.t.exPct.toFixed(1):'â€”'}</td>
      <td style="padding:5px 8px;text-align:center;font-weight:700;">${r.t.overall.toFixed(1)}%</td>
      <td style="padding:5px 8px;text-align:center;font-weight:800;color:${r.grade?.color||'#000'};">${r.grade?.grade||'â€”'}</td>
      <td style="padding:5px 8px;font-size:11px;color:#666;">${r.grade?COMMENTS[r.grade.grade].split('.')[0]:''}</td>
    </tr>`).join('');

  const avg = rows.filter(r=>r.t.overall!==null).length ? rows.filter(r=>r.t.overall!==null).reduce((a,b)=>a+b.t.overall,0)/rows.filter(r=>r.t.overall!==null).length : 0;

  return `<!DOCTYPE html><html><head><meta charset="UTF-8"/>
  <title>Assessment Report Â· ${p.school||'GES'}</title>
  <style>
    body{font-family:'Segoe UI',Arial,sans-serif;margin:15mm;color:#000;font-size:13px;}
    .header{text-align:center;border-bottom:4px solid #006B3F;padding-bottom:14px;margin-bottom:18px;}
    h1{color:#006B3F;font-size:1.4rem;margin:4px 0;}
    .meta-row{display:flex;flex-wrap:wrap;gap:14px;background:#F0FDF4;padding:12px;border-radius:6px;margin-bottom:16px;font-size:12px;}
    .meta-item span{display:block;font-size:10px;color:#666;text-transform:uppercase;}
    .meta-item strong{color:#000;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th{background:#006B3F;color:#fff;padding:7px 8px;text-align:left;font-size:11px;}
    .summary{background:#F0FDF4;border:1px solid #86EFAC;border-radius:6px;padding:12px;margin:14px 0;font-size:12px;}
    .footer{margin-top:40px;display:flex;justify-content:space-between;border-top:1px solid #ccc;padding-top:12px;font-size:11px;}
    .sig{border-top:1px solid #000;width:180px;margin-top:28px;text-align:center;padding-top:4px;}
    .dev{font-size:9px;color:#999;text-align:center;margin-top:20px;}
    @media print{body{margin:8mm;}}
  </style></head><body>
  <div class="header">
    <div style="font-size:2rem;margin-bottom:6px;">ğŸ‡¬ğŸ‡­</div>
    <h1>${p.school||'Ghana Education Service'}</h1>
    <p style="color:#555;margin:4px 0;">${p.class||''} Â· ${p.subject||''} Â· ${p.term||''} ${p.year||''}</p>
    ${p.strand?`<p style="color:#888;font-size:11px;">Strand: ${p.strand}${p.substrand?' â€º '+p.substrand:''}</p>`:''}
  </div>
  <div class="meta-row">
    <div class="meta-item"><span>Region</span><strong>${p.region||'â€”'}</strong></div>
    <div class="meta-item"><span>District</span><strong>${p.district||'â€”'}</strong></div>
    <div class="meta-item"><span>Academic Year</span><strong>${p.year||'â€”'}</strong></div>
    <div class="meta-item"><span>Term</span><strong>${p.term||'â€”'}</strong></div>
    <div class="meta-item"><span>Class</span><strong>${p.class||'â€”'}</strong></div>
    <div class="meta-item"><span>Subject</span><strong>${p.subject||'â€”'}</strong></div>
    <div class="meta-item"><span>Teacher</span><strong>${USER_DOC?.name||'â€”'}</strong></div>
    <div class="meta-item"><span>CA : Exam Weight</span><strong>${p.caWeight||30}% : ${p.examWeight||70}%</strong></div>
    <div class="meta-item"><span>Date Generated</span><strong>${now}</strong></div>
  </div>
  <table>
    <thead><tr>
      <th>Pos.</th><th>Student Name</th><th>G</th><th>Index</th>
      <th>CA Avg%</th><th>Exam Avg%</th><th>Total%</th><th>Grade</th><th>Remarks</th>
    </tr></thead>
    <tbody>${tableRows}</tbody>
  </table>
  <div class="summary">
    <strong>Class Average: ${avg.toFixed(1)}%</strong> &nbsp;|&nbsp;
    Passed: ${rows.filter(r=>r.grade?.grade!=='F'&&r.t.overall!==null).length} &nbsp;|&nbsp;
    Failed: ${rows.filter(r=>r.grade?.grade==='F').length} &nbsp;|&nbsp;
    Total Scored: ${rows.filter(r=>r.t.overall!==null).length} &nbsp;|&nbsp;
    Total Students: ${STUDENTS.length}
  </div>
  ${notes ? `<div style="background:#FFFBEB;border:1px solid #FCD34D;border-radius:6px;padding:12px;font-size:12px;"><strong>Notes:</strong> ${notes}</div>` : ''}
  <div class="footer">
    <div><div class="sig">Class Teacher's Signature</div></div>
    <div><div class="sig">Head Teacher's Signature</div></div>
    <div><div class="sig">GES District Officer</div></div>
  </div>
  <div class="dev">Generated by GES NaCCA Assessment Manager v3.0 Â· Firebase Edition Â· Developed by Samuel Kwame Dordzie Â· bigsammy86g@gmail.com</div>
  </body></html>`;
}

// â”€â”€ EXPORT â”€â”€
async function exportJSON() {
  await loadAllScores();
  const data = {
    exportedAt: new Date().toISOString(),
    exportedBy: USER_DOC?.name,
    profile: PROFILE,
    students: STUDENTS,
    assessments: ASSESSMENTS,
    scores: SCORES,
    grading: GRADING,
    comments: COMMENTS,
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `GES_Backup_${(PROFILE.school||'School').replace(/\s/g,'_')}_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Backup downloaded!', 'success');
}

async function exportCSV() {
  await loadAllScores();
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return [s.name, s.gender, s.index||'', t.caPct.toFixed(1), t.exPct.toFixed(1),
      t.overall!==null?t.overall.toFixed(1):'', grade?.grade||'', grade?.label||''].join(',');
  });
  const blob = new Blob([['Name,Gender,Index,CA%,Exam%,Total%,Grade,Label', ...rows].join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'Results.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('CSV exported!', 'success');
}

function exportBroadsheetCSV() { exportCSV(); }

async function clearMyData() {
  confirm2('Delete ALL your students, assessments, scores and profile from Firebase? This cannot be undone!', async () => {
    confirm2('FINAL WARNING: All your data will be permanently deleted from the cloud.', async () => {
      const { db, doc, deleteDoc, collection, query, where, getDocs } = window.FB;
      const uid = myUid();
      const colls = ['students','assessments','scores','profiles'];
      for (const c of colls) {
        const q = query(collection(db, c), where('uid','==',uid));
        const snap = await getDocs(q);
        for (const d of snap.docs) await deleteDoc(doc(db, c, d.id));
      }
      STUDENTS=[]; ASSESSMENTS=[]; SCORES={}; PROFILE={};
      toast('All data deleted from Firebase.', 'info');
    });
  });
}

// â”€â”€ DASHBOARD â”€â”€
async function renderDashboard() {
  await loadAllScores();
  eid('dash-greeting').textContent = `Welcome back, ${USER_DOC?.name || 'Teacher'}! ğŸ‡¬ğŸ‡­`;
  const scored = STUDENTS.filter(s => getStudentTotal(s).overall !== null).length;
  const avg = scored ? STUDENTS.filter(s => getStudentTotal(s).overall !== null)
    .reduce((a,s) => a + getStudentTotal(s).overall, 0) / scored : 0;

  eid('dashStats').innerHTML = `
    <div class="stat-card green"><div class="stat-value">${STUDENTS.length}</div><div class="stat-label">Students</div><div class="stat-sub">in your class</div></div>
    <div class="stat-card gold"><div class="stat-value">${ASSESSMENTS.length}</div><div class="stat-label">Assessments</div><div class="stat-sub">${ASSESSMENTS.filter(a=>a.locked).length} locked</div></div>
    <div class="stat-card blue"><div class="stat-value">${scored}</div><div class="stat-label">Scored</div><div class="stat-sub">students</div></div>
    <div class="stat-card ${avg>=50?'green':'red'}"><div class="stat-value">${scored?avg.toFixed(1)+'%':'â€”'}</div><div class="stat-label">Class Avg</div><div class="stat-sub">overall weighted</div></div>
  `;

  const p = PROFILE;
  eid('dashSchoolBlock').innerHTML = p.school ? `
    <div style="line-height:2.2;font-size:.88rem;">
      <div>ğŸ« <strong>${p.school}</strong></div>
      <div>ğŸ“ ${p.region||'â€”'} Â· ${p.district||'â€”'}</div>
      <div>ğŸ“š ${p.subject||'â€”'} Â· <strong>${p.class||'â€”'}</strong></div>
      <div>ğŸ“… ${p.term||'â€”'} Â· ${p.year||'â€”'}</div>
      <div>ğŸ‘¤ ${USER_DOC?.name||'â€”'} <span class="role-chip role-${USER_DOC?.role||'teacher'}" style="margin-left:6px;">${USER_DOC?.role||'â€”'}</span></div>
      ${p.strand?`<div>ğŸ”¬ ${p.strand}${p.substrand?' â€º '+p.substrand:''}</div>`:''}
    </div>` : 'Set up your <a href="#" onclick="showPage(\'profile\')">School Profile</a> to see details.';

  const quickActions = [
    { label:'â• Add Students', page:'students' },
    { label:'ğŸ“ New Assessment', page:'assessments' },
    { label:'âœï¸ Enter Scores', page:'scores' },
    { label:'ğŸ“„ Generate PDF', page:'reports', gold:true },
  ];
  if (isAdminLike() || isHeadTeacher()) quickActions.push({ label:'ğŸ‘¥ Manage Users', page:'users' });
  eid('dashQuickActions').innerHTML = quickActions.map(a =>
    `<button class="btn btn-sm ${a.gold?'btn-gold':'btn-outline'}" onclick="showPage('${a.page}')">${a.label}</button>`
  ).join('');

  // Admin panel
  if (isAdminLike() || isHeadTeacher()) {
    eid('adminDashPanel').style.display = 'block';
    const pending = ALL_USERS.filter(u => u.status === 'pending').length;
    eid('schoolOverview').innerHTML = `
      <div class="inline-flex" style="flex-wrap:wrap;gap:14px;">
        <div class="stat-card green">
          <div class="stat-value">${ALL_USERS.filter(u=>u.status==='approved').length}</div>
          <div class="stat-label">Active Teachers</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-value">${pending}</div>
          <div class="stat-label">Pending Approval</div>
          ${pending?`<div class="stat-sub"><a href="#" onclick="showPage('users')">Review now â†’</a></div>`:''}
        </div>
        <div class="stat-card blue">
          <div class="stat-value">${[...new Set(ALL_USERS.map(u=>u.school).filter(Boolean))].length}</div>
          <div class="stat-label">Schools</div>
        </div>
      </div>`;
  }

  // Chart
  const gradeCounts = { A:0, B:0, C:0, D:0, E:0, F:0 };
  STUDENTS.forEach(s => {
    const t = getStudentTotal(s);
    if (t.overall !== null) { const g = getGrade(t.overall); if(g) gradeCounts[g.grade]++; }
  });
  setTimeout(() => drawBar('dashChart', Object.keys(gradeCounts), Object.values(gradeCounts), GRADING.map(g=>g.color)), 100);
}

// â”€â”€ MINI CHART ENGINE (pure canvas) â”€â”€
function drawBar(canvasId, labels, data, colors) {
  const canvas = eid(canvasId);
  if (!canvas) return;
  if (CHARTS[canvasId]) { CHARTS[canvasId] = null; }
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.parentElement?.offsetWidth || 400;
  const H = canvas.height = 220;
  ctx.clearRect(0, 0, W, H);
  const pad = { top:24, right:16, bottom:44, left:46 };
  const dw = W - pad.left - pad.right;
  const dh = H - pad.top - pad.bottom;
  const vals = data.map(Number);
  const max = Math.max(...vals, 1);
  const isDark = !document.body.classList.contains('light-mode');
  const textColor = isDark ? '#5A7A98' : '#4A6080';
  const gridColor = isDark ? '#1E3548' : '#C8DCF0';

  // Grid lines
  ctx.strokeStyle = gridColor; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + dh * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left+dw, y); ctx.stroke();
    ctx.fillStyle = textColor; ctx.font = '11px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(((max*i/4)).toFixed(0), pad.left-6, y+4);
  }

  const gap = dw / labels.length;
  const bw = gap * 0.62;
  labels.forEach((lbl, i) => {
    const v = vals[i] || 0;
    const bh = (v/max) * dh;
    const x = pad.left + i*gap + (gap-bw)/2;
    const y = pad.top + dh - bh;
    const color = Array.isArray(colors) ? colors[i%colors.length] : colors;
    // Gradient bar
    const grad = ctx.createLinearGradient(x, y, x, y+bh);
    grad.addColorStop(0, color);
    grad.addColorStop(1, color + '88');
    ctx.fillStyle = grad;
    ctx.beginPath();
    if (ctx.roundRect) ctx.roundRect(x, y, bw, bh, [4,4,0,0]);
    else ctx.rect(x, y, bw, bh);
    ctx.fill();
    // Value label
    if (v > 0) {
      ctx.fillStyle = isDark ? '#E8F4FF' : '#0A1828';
      ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText(v, x+bw/2, y-6);
    }
    // X label
    ctx.fillStyle = textColor; ctx.font = '11px sans-serif'; ctx.textAlign = 'center';
    const shortLbl = lbl.length > 6 ? lbl.substring(0,5)+'â€¦' : lbl;
    ctx.fillText(shortLbl, x+bw/2, H-8);
  });
  CHARTS[canvasId] = true;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASE 1 FEATURES
//  1. PWA Install  2. Push Notifications  3. Bulk PDF  4. WhatsApp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ 1. PWA INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let PWA_PROMPT = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  PWA_PROMPT = e;
  const btn = eid('installBtn');
  if (btn) btn.style.display = 'flex';
});

async function installPWA() {
  if (!PWA_PROMPT) {
    toast('To install: tap your browser menu â†’ "Add to Home Screen"', 'info');
    return;
  }
  PWA_PROMPT.prompt();
  const { outcome } = await PWA_PROMPT.userChoice;
  if (outcome === 'accepted') {
    toast('App installed successfully! Check your home screen. ğŸ“±', 'success');
    eid('installBtn').style.display = 'none';
    PWA_PROMPT = null;
  }
}

window.addEventListener('appinstalled', () => {
  toast('GES Assessment Manager installed on your device! ğŸ‰', 'success');
  eid('installBtn').style.display = 'none';
});

// Register service worker for offline caching
if ('serviceWorker' in navigator) {
  const SW_CODE = `
    const CACHE = 'ges-assess-v1';
    const ASSETS = ['./', './index.html'];
    self.addEventListener('install', e => {
      e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS).catch(()=>{})));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(
        fetch(e.request).catch(() => caches.match(e.request))
      );
    });
    self.addEventListener('push', e => {
      const data = e.data ? e.data.json() : { title:'GES Assessment', body:'You have a new notification' };
      e.waitUntil(self.registration.showNotification(data.title, {
        body: data.body, icon: data.icon || '',
        badge: data.badge || '', tag: data.tag || 'ges-notif'
      }));
    });
  `;
  const swBlob = new Blob([SW_CODE], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).catch(() => {});
}

// â”€â”€ 2. PUSH NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let NOTIFICATIONS = [];

async function subscribeNotifications() {
  if (!myUid()) return;
  const { db, collection, query, where, orderBy, onSnapshot } = window.FB;
  const q = query(
    collection(db, 'notifications'),
    where('toUid', '==', myUid()),
    orderBy('createdAt', 'desc')
  );
  const unsub = onSnapshot(q, snap => {
    NOTIFICATIONS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    updateNotifBadge();
    if (eid('page-notifications').classList.contains('active')) renderNotifications();
  });
  UNSUBSCRIBERS.push(unsub);
}

function updateNotifBadge() {
  const unread = NOTIFICATIONS.filter(n => !n.read).length;
  const dot = eid('notifDot');
  const cnt = eid('notifCount');
  if (dot) dot.style.display = unread > 0 ? 'block' : 'none';
  if (cnt) cnt.textContent = unread > 0 ? unread : '0';
}

function renderNotifications() {
  const el = eid('notifList');
  if (!el) return;
  if (!NOTIFICATIONS.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ””</div><h3>No notifications yet</h3><p>You\'ll be notified when assessments are approved or rejected.</p></div>';
    return;
  }
  el.innerHTML = NOTIFICATIONS.map(n => {
    const isMsg = n.icon === 'ğŸ’¬' && n.fromUid;
    const bg = n.read ? 'transparent' : 'rgba(0,168,107,0.06)';
    const border = n.read ? '3px solid transparent' : '3px solid var(--accent)';
    const safeName = (n.fromName || '').replace(/'/g, "&#39;");
    const clickAttr = isMsg
      ? `onclick="openMsgFromNotif('${n.id}','${n.fromUid}','${safeName}')" style="cursor:pointer;" title="Open conversation"`
      : '';
    const hint = isMsg && !n.read
      ? `<span style="font-size:.72rem;color:var(--accent2);margin-top:4px;display:block;">Tap to open conversation â†’</span>`
      : '';
    return `
    <div ${clickAttr} style="display:flex;gap:12px;padding:13px;border-bottom:1px solid var(--border);
      background:${bg};border-left:${border};transition:background .18s;">
      <div style="font-size:1.4rem;flex-shrink:0;">${n.icon || 'ğŸ””'}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:${n.read ? '500' : '700'};font-size:.9rem;">${n.title || 'Notification'}</div>
        <div style="font-size:.82rem;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${n.body || ''}</div>
        <div style="font-size:.74rem;color:var(--muted);margin-top:4px;">${n.createdAt?.toDate?.().toLocaleString() || ''}</div>
        ${hint}
      </div>
      ${!n.read ? `<button class="btn-icon" onclick="event.stopPropagation();markRead('${n.id}')" title="Mark read" style="flex-shrink:0;">âœ“</button>` : ''}
    </div>`;
  }).join('');
}

async function openMsgFromNotif(notifId, fromUid, fromName) {
  markRead(notifId);
  const sender = ALL_USERS.find(u => (u.uid || u.id) === fromUid);
  const senderName = fromName || sender?.name || 'Staff';
  const senderRole = sender?.role || 'teacher';
  showPage('messaging');
  // Give the contacts list time to render, then open the chat
  setTimeout(() => openChat(fromUid, senderName, senderRole), 200);
}

async function markRead(id) {
  const { db, doc, updateDoc } = window.FB;
  await updateDoc(doc(db, 'notifications', id), { read: true });
}

async function markAllRead() {
  const { db, doc, updateDoc } = window.FB;
  const unread = NOTIFICATIONS.filter(n => !n.read);
  await Promise.all(unread.map(n => updateDoc(doc(db, 'notifications', n.id), { read: true })));
  toast('All marked as read.', 'info');
}

async function clearNotifications() {
  confirm2('Clear all notifications?', async () => {
    const { db, doc, deleteDoc } = window.FB;
    await Promise.all(NOTIFICATIONS.map(n => deleteDoc(doc(db, 'notifications', n.id))));
    toast('Notifications cleared.', 'info');
  });
}

// Send a notification to a user (used by admin/headteacher)
async function sendNotification(toUid, title, body, icon = 'ğŸ””') {
  if (!window.FB?.db) return;
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const id = `notif_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
  await setDoc(doc(db, 'notifications', id), {
    toUid, title, body, icon,
    fromUid: myUid(),
    fromName: USER_DOC?.name || 'System',
    read: false,
    createdAt: serverTimestamp(),
  });
}

// Hook into assessment approval/rejection to auto-notify
const _origApprove = window.approveAssessment;
async function approveAssessment(id) {
  const { db, doc, updateDoc } = window.FB;
  const a = (await (await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'))
    .getDoc(doc(db, 'assessments', id))).data?.() || ASSESSMENTS.find(x=>x.id===id);
  await updateDoc(doc(db, 'assessments', id), { pendingApproval: false, approved: true, locked: true });
  if (a?.uid) await sendNotification(a.uid, 'âœ… Assessment Approved',
    `Your assessment "${a?.name||id}" has been approved and locked by ${USER_DOC?.name}.`, 'âœ…');
  toast('Assessment approved and teacher notified!', 'success');
  renderApprovals();
}

async function returnAssessment(id) {
  const { db, doc, updateDoc, getDoc } = window.FB;
  const snap = await getDoc(doc(db, 'assessments', id));
  const a = snap.data();
  await updateDoc(doc(db, 'assessments', id), { pendingApproval: false, locked: false });
  if (a?.uid) await sendNotification(a.uid, 'â†©ï¸ Assessment Returned',
    `Your assessment "${a?.name||id}" was returned for revision by ${USER_DOC?.name}. Please review and resubmit.`, 'â†©ï¸');
  toast('Assessment returned and teacher notified.', 'info');
  renderApprovals();
}

// â”€â”€ 3. BULK PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function previewBulkCount() {
  await loadAllScores();
  const filter = eid('bulkFilter')?.value || 'all';
  const students = getFilteredStudentsForBulk(filter);
  const el = eid('bulkCountPreview');
  if (el) el.textContent = `ğŸ“‹ ${students.length} student report cards will be generated.`;

  // Quick stats
  const statsEl = eid('bulkQuickStats');
  if (!statsEl || !students.length) return;
  const gradeCounts = { A:0, B:0, C:0, D:0, E:0, F:0 };
  students.forEach(r => { if(r.grade) gradeCounts[r.grade.grade]++; });
  const avg = students.length ? students.reduce((a,b) => a + (b.t.overall||0), 0) / students.length : 0;
  statsEl.innerHTML = `
    <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:.85rem;">
      <div>ğŸ“Š Class Average: <strong>${avg.toFixed(1)}%</strong></div>
      <div>âœ… Passed: <strong style="color:var(--accent2);">${students.filter(r=>r.grade?.grade!=='F').length}</strong></div>
      <div>âŒ Failed: <strong style="color:var(--danger);">${students.filter(r=>r.grade?.grade==='F').length}</strong></div>
      ${Object.entries(gradeCounts).map(([g,c]) => c > 0 ?
        `<div><span class="grade-pill g${g}">${g}</span>: <strong>${c}</strong></div>` : '').join('')}
    </div>`;
}

function getFilteredStudentsForBulk(filter) {
  return STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  }).filter(r => {
    if (filter === 'all') return r.t.overall !== null;
    if (filter === 'passed') return r.grade && r.grade.grade !== 'F';
    if (filter === 'failed') return r.grade && r.grade.grade === 'F';
    if (filter === 'gradeA') return r.grade && r.grade.grade === 'A';
    return r.t.overall !== null;
  }).sort((a,b) => (b.t.overall||0) - (a.t.overall||0));
}

async function generateBulkPDF() {
  await loadAllScores();
  const filter = eid('bulkFilter')?.value || 'all';
  const style = eid('bulkStyle')?.value || 'card';
  const note = eid('bulkNote')?.value || '';
  const students = getFilteredStudentsForBulk(filter);

  if (!students.length) return toast('No students match the selected filter.', 'error');

  const p = PROFILE;
  const now = new Date().toLocaleDateString('en-GH', {year:'numeric',month:'long',day:'numeric'});
  const teacher = USER_DOC?.name || '';

  // Assign positions
  let pos = 1;
  students.forEach((r, i) => {
    if (i > 0 && (r.t.overall||0) < (students[i-1].t.overall||0)) pos = i+1;
    r.position = pos;
  });

  const avg = students.reduce((a,b) => a+(b.t.overall||0), 0) / students.length;
  const passed = students.filter(r => r.grade?.grade !== 'F').length;

  const cardHTML = students.map((r, i) => {
    const g = r.grade;
    const scBreakdown = ASSESSMENTS.map(a => {
      const sc = SCORES[a.id]?.[r.s.id];
      return `<tr>
        <td style="padding:4px 8px;border-bottom:1px solid #eee;">${a.name}</td>
        <td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:center;">${a.category}</td>
        <td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:center;">${a.type}</td>
        <td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:center;">${sc !== undefined ? sc : 'â€”'}</td>
        <td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:center;">${a.total}</td>
        <td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:center;">${sc !== undefined ? ((sc/a.total)*100).toFixed(1)+'%' : 'â€”'}</td>
      </tr>`;
    }).join('');

    return `
      <div style="page-break-after:always;padding:14mm;font-family:'Segoe UI',Arial,sans-serif;min-height:250mm;position:relative;">
        <!-- Header -->
        <div style="text-align:center;border-bottom:4px solid #006B3F;padding-bottom:12px;margin-bottom:14px;">
          <div style="font-size:2rem;">ğŸ‡¬ğŸ‡­</div>
          <h1 style="color:#006B3F;font-size:1.3rem;margin:4px 0;">${p.school || 'Ghana Education Service'}</h1>
          <p style="color:#555;font-size:12px;margin:2px 0;">${p.class||''} Â· ${p.subject||''} Â· ${p.term||''} ${p.year||''}</p>
          <p style="color:#888;font-size:10px;">Teacher: ${teacher} Â· Date: ${now}</p>
        </div>

        <!-- Student Info -->
        <div style="display:flex;justify-content:space-between;align-items:center;
          background:#F0FDF4;border-radius:8px;padding:12px 16px;margin-bottom:14px;">
          <div>
            <div style="font-size:1.1rem;font-weight:800;color:#006B3F;">${r.s.name}</div>
            <div style="font-size:11px;color:#555;">Gender: ${r.s.gender} &nbsp;|&nbsp; Index No: ${r.s.index||'N/A'} &nbsp;|&nbsp; Position: #${r.position} of ${students.length}</div>
          </div>
          <div style="text-align:center;background:#006B3F;color:#fff;border-radius:10px;
            padding:10px 18px;">
            <div style="font-size:2rem;font-weight:900;">${g?.grade || 'â€”'}</div>
            <div style="font-size:10px;">${g?.label || ''}</div>
          </div>
        </div>

        <!-- Scores Table -->
        <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px;">
          <thead><tr style="background:#006B3F;color:#fff;">
            <th style="padding:6px 8px;text-align:left;">Assessment</th>
            <th style="padding:6px 8px;">Category</th>
            <th style="padding:6px 8px;">Type</th>
            <th style="padding:6px 8px;">Score</th>
            <th style="padding:6px 8px;">Total</th>
            <th style="padding:6px 8px;">%</th>
          </tr></thead>
          <tbody>${scBreakdown}</tbody>
        </table>

        <!-- Summary -->
        <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
          ${r.t.caMax > 0 ? `<div style="flex:1;background:#F0FDF4;border:1px solid #86EFAC;border-radius:8px;padding:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.3rem;font-weight:800;color:#006B3F;">${r.t.caPct.toFixed(1)}%</div>
            <div style="font-size:10px;color:#555;">CA Average (${p.caWeight||30}%)</div>
          </div>` : ''}
          ${r.t.examMax > 0 ? `<div style="flex:1;background:#EFF6FF;border:1px solid #93C5FD;border-radius:8px;padding:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.3rem;font-weight:800;color:#1D4ED8;">${r.t.exPct.toFixed(1)}%</div>
            <div style="font-size:10px;color:#555;">Exam Average (${p.examWeight||70}%)</div>
          </div>` : ''}
          <div style="flex:1;background:#006B3F;border-radius:8px;padding:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.3rem;font-weight:800;color:#fff;">${r.t.overall?.toFixed(1)}%</div>
            <div style="font-size:10px;color:#FCD116;">Overall Weighted Score</div>
          </div>
        </div>

        <!-- Remarks -->
        <div style="background:#FFFBEB;border:1px solid #FCD34D;border-radius:8px;
          padding:10px 14px;font-size:12px;margin-bottom:12px;">
          <strong>Remarks:</strong> ${g ? COMMENTS[g.grade] : 'No score recorded.'}
        </div>

        ${note ? `<div style="background:#F0F9FF;border:1px solid #BAE6FD;border-radius:8px;
          padding:10px 14px;font-size:11px;margin-bottom:12px;">
          <strong>Principal's Note:</strong> ${note}
        </div>` : ''}

        <!-- Class context -->
        <div style="font-size:10px;color:#999;margin-bottom:16px;">
          Class Average: ${avg.toFixed(1)}% &nbsp;|&nbsp; 
          Passed: ${passed}/${students.length} &nbsp;|&nbsp;
          ${p.strand ? `Strand: ${p.strand}` : ''}
        </div>

        <!-- Signatures -->
        <div style="display:flex;justify-content:space-between;border-top:1px solid #ccc;padding-top:14px;margin-top:auto;">
          <div style="text-align:center;">
            <div style="border-top:1px solid #000;width:150px;padding-top:4px;font-size:10px;">Class Teacher</div>
          </div>
          <div style="text-align:center;">
            <div style="border-top:1px solid #000;width:150px;padding-top:4px;font-size:10px;">Head Teacher</div>
          </div>
          <div style="text-align:center;">
            <div style="border-top:1px solid #000;width:150px;padding-top:4px;font-size:10px;">Parent / Guardian</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:10px;font-size:9px;color:#bbb;">
          GES NaCCA Assessment Manager v3.0 Â· Developed by Samuel Kwame Dordzie Â· bigsammy86g@gmail.com
        </div>
      </div>`;
  }).join('');

  const fullHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"/>
    <title>Bulk Report Â· ${p.school||'GES'} Â· ${students.length} Students</title>
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; padding: 0; background: #fff; }
      @media print {
        @page { size: A4; margin: 0; }
        body { margin: 0; }
      }
    </style>
  </head><body>${cardHTML}</body></html>`;

  const blob = new Blob([fullHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const win = window.open(url, '_blank');
  setTimeout(() => { if(win) win.print(); }, 800);
  toast(`Bulk PDF opened â€” ${students.length} report cards ready to print! ğŸ–¨ï¸`, 'success');
}

// â”€â”€ 4. WHATSAPP SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateWAStudentSel() {
  const sel = eid('waStudent');
  if (!sel) return;
  sel.innerHTML = '<option value="">â€” Choose a student â€”</option>' +
    STUDENTS.map((s,i) => `<option value="${i}">${s.name}</option>`).join('');
}

function previewWhatsApp() {
  const idx = eid('waStudent')?.value;
  const card = eid('waPreviewCard');
  if (idx === '' || idx === null || idx === undefined) {
    if (card) card.style.display = 'none';
    return;
  }
  const s = STUDENTS[parseInt(idx)];
  if (!s) return;
  const t = getStudentTotal(s);
  const grade = t.overall !== null ? getGrade(t.overall) : null;
  const p = PROFILE;
  const extra = eid('waExtra')?.value || '';

  const gradeEmoji = { A:'ğŸ¥‡', B:'ğŸ¥ˆ', C:'ğŸ¥‰', D:'ğŸ“˜', E:'ğŸ“™', F:'ğŸ“•' };
  const msg = [
    `ğŸ‡¬ğŸ‡­ *GES ASSESSMENT REPORT*`,
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
    `ğŸ« *${p.school || 'School'}*`,
    `ğŸ“š ${p.class||''} Â· ${p.subject||''}`,
    `ğŸ“… ${p.term||''} ${p.year||''}`,
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
    `ğŸ‘¤ *Student:* ${s.name}`,
    `ğŸªª Index No: ${s.index || 'N/A'}`,
    ``,
    t.caMax > 0 ? `ğŸ“Š *CA Average:* ${t.caPct.toFixed(1)}%` : null,
    t.examMax > 0 ? `ğŸ“ *Exam Average:* ${t.exPct.toFixed(1)}%` : null,
    t.overall !== null ? `ğŸ¯ *Overall Score:* ${t.overall.toFixed(1)}%` : null,
    grade ? `${gradeEmoji[grade.grade] || 'ğŸ“Œ'} *Grade:* ${grade.grade} â€” ${grade.label}` : null,
    ``,
    grade ? `ğŸ’¬ *Remarks:* ${COMMENTS[grade.grade]}` : null,
    ``,
    extra ? `ğŸ“Œ ${extra}` : null,
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
    `_Report generated by GES Assessment Manager_`,
    `_Teacher: ${USER_DOC?.name || ''}_`,
  ].filter(l => l !== null).join('\n');

  const el = eid('waPreview');
  if (el) el.textContent = msg;
  if (card) card.style.display = 'block';
  window._WA_MSG = msg;
}

function sendWhatsApp() {
  const msg = window._WA_MSG || '';
  if (!msg) return toast('Select a student first.', 'error');
  const rawPhone = (eid('waPhone')?.value || '').replace(/\s+/g,'').replace(/^0/, '');
  const country = eid('waCountry')?.value || '233';
  const phone = rawPhone ? `${country}${rawPhone}` : '';
  const encoded = encodeURIComponent(msg);
  const url = phone
    ? `https://wa.me/${phone}?text=${encoded}`
    : `https://wa.me/?text=${encoded}`;
  window.open(url, '_blank');
  toast('Opening WhatsAppâ€¦', 'success');
}

function copyWAMessage() {
  const msg = window._WA_MSG || '';
  if (!msg) return toast('Generate a message first.', 'error');
  navigator.clipboard.writeText(msg).then(() => toast('Message copied to clipboard!', 'success'))
    .catch(() => toast('Could not copy. Please select and copy manually.', 'error'));
}

async function shareClassResults() {
  await loadAllScores();
  const p = PROFILE;
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  }).filter(r => r.t.overall !== null).sort((a,b) => b.t.overall-a.t.overall);

  if (!rows.length) return toast('No scores entered yet.', 'error');
  const avg = rows.reduce((a,b) => a+b.t.overall, 0) / rows.length;
  const passed = rows.filter(r => r.grade?.grade !== 'F').length;
  const top3 = rows.slice(0,3);

  const msg = [
    `ğŸ‡¬ğŸ‡­ *CLASS RESULTS SUMMARY*`,
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
    `ğŸ« *${p.school || 'School'}*`,
    `ğŸ“š ${p.class||''} Â· ${p.subject||''}`,
    `ğŸ“… ${p.term||''} ${p.year||''}`,
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
    `ğŸ‘¥ Total Students: *${rows.length}*`,
    `ğŸ“Š Class Average: *${avg.toFixed(1)}%*`,
    `âœ… Passed: *${passed}* | âŒ Failed: *${rows.length - passed}*`,
    `ğŸ“ˆ Pass Rate: *${((passed/rows.length)*100).toFixed(0)}%*`,
    ``,
    `ğŸ† *TOP PERFORMERS*`,
    ...top3.map((r,i) => `${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]} ${r.s.name} â€” ${r.t.overall.toFixed(1)}% (${r.grade?.grade})`),
    ``,
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
    `_GES Assessment Manager Â· ${USER_DOC?.name||''}_`,
  ].join('\n');

  window._WA_MSG = msg;
  const el = eid('waPreview');
  if (el) el.textContent = msg;
  eid('waPreviewCard').style.display = 'block';
  toast('Class summary ready â€” click Open WhatsApp to share!', 'success');
}

async function generateBroadcastMessage() {
  await loadAllScores();
  const p = PROFILE;
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  }).filter(r => r.t.overall !== null).sort((a,b) => b.t.overall-a.t.overall);

  if (!rows.length) return toast('No scores entered yet.', 'error');
  const avg = rows.reduce((a,b) => a+b.t.overall, 0) / rows.length;
  const passed = rows.filter(r => r.grade?.grade !== 'F').length;

  const msg = [
    `ğŸ‡¬ğŸ‡­ *DEAR PARENTS & GUARDIANS*`,
    ``,
    `Please find below the ${p.term||'term'} ${p.year||''} results summary for *${p.class||'your ward\'s class'}* â€” ${p.subject||''}:`,
    ``,
    `ğŸ“Š *Class Average:* ${avg.toFixed(1)}%`,
    `âœ… *Students Passed:* ${passed} out of ${rows.length}`,
    `ğŸ“ˆ *Pass Rate:* ${((passed/rows.length)*100).toFixed(0)}%`,
    ``,
    `To view your ward's individual result, please contact the class teacher.`,
    ``,
    `Thank you for your continued support.`,
    ``,
    `â€” *${USER_DOC?.name || 'Class Teacher'}*`,
    `${p.school || ''}`,
    `_GES NaCCA Assessment Manager_`,
  ].join('\n');

  eid('broadcastText').textContent = msg;
  eid('broadcastMsg').style.display = 'block';
  window._BROADCAST_MSG = msg;
  toast('Broadcast message ready!', 'success');
}

function copyBroadcast() {
  const msg = window._BROADCAST_MSG || '';
  navigator.clipboard.writeText(msg)
    .then(() => toast('Broadcast copied to clipboard!', 'success'))
    .catch(() => toast('Select and copy the text manually.', 'error'));
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASE 2 FEATURES
//  1. Term Comparison  2. Student Promotion  3. League Table  4. Timetable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ 1. TERM COMPARISON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let TC_DATA = {}; // stored snapshots keyed by "uid_term_year"

function initTermComparison() {
  const p = PROFILE;
  if (eid('tcYear')) eid('tcYear').value = p.year || '2024/2025';
}

async function runTermComparison() {
  const { db, doc, getDoc } = window.FB;
  const baseTerm  = eid('tcBaseTerm').value;
  const compTerm  = eid('tcCompareTerm').value;
  const year      = eid('tcYear').value.trim() || PROFILE.year || '';

  if (baseTerm === compTerm) return toast('Please select two different terms.', 'error');

  // Load snapshots from Firebase (teachers save term snapshots when they finalise)
  const baseKey = `${myUid()}_${baseTerm.replace(' ','')}_${year.replace('/','_')}`;
  const compKey = `${myUid()}_${compTerm.replace(' ','')}_${year.replace('/','_')}`;

  const [baseSnap, compSnap] = await Promise.all([
    getDoc(doc(db, 'termSnapshots', baseKey)),
    getDoc(doc(db, 'termSnapshots', compKey)),
  ]);

  // If no snapshot for compare term, use current scores
  await loadAllScores();
  const currentScores = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    return { id: s.id, name: s.name, gender: s.gender, overall: t.overall };
  });

  const baseData  = baseSnap.exists()  ? baseSnap.data().students  : currentScores;
  const compData  = compSnap.exists()  ? compSnap.data().students  : currentScores;

  // Save current as snapshot for baseTerm (if not already saved)
  if (!baseSnap.exists()) {
    const { setDoc, serverTimestamp } = window.FB;
    await setDoc(doc(db, 'termSnapshots', baseKey), {
      uid: myUid(), term: baseTerm, year, students: currentScores,
      createdAt: serverTimestamp(),
    });
    toast(`Snapshot saved for ${baseTerm}. For accurate comparison, save Term snapshots at end of each term.`, 'info');
  }

  // Build comparison rows
  const rows = STUDENTS.map(s => {
    const base = baseData.find(x => x.id === s.id || x.name === s.name);
    const comp = compData.find(x => x.id === s.id || x.name === s.name);
    const baseScore = base?.overall ?? null;
    const compScore = comp?.overall ?? null;
    const change = (baseScore !== null && compScore !== null) ? compScore - baseScore : null;
    const baseGrade = baseScore !== null ? getGrade(baseScore) : null;
    const compGrade = compScore !== null ? getGrade(compScore) : null;
    return { s, baseScore, compScore, change, baseGrade, compGrade };
  }).filter(r => r.baseScore !== null || r.compScore !== null);

  if (!rows.length) {
    return toast('No score data found for comparison. Enter scores for both terms first.', 'error');
  }

  // Update column headers
  if (eid('tcBaseLabel')) eid('tcBaseLabel').textContent = `${baseTerm} %`;
  if (eid('tcCompLabel')) eid('tcCompLabel').textContent = `${compTerm} %`;

  // Summary stats
  const improved  = rows.filter(r => r.change !== null && r.change > 0).length;
  const declined  = rows.filter(r => r.change !== null && r.change < 0).length;
  const same      = rows.filter(r => r.change !== null && r.change === 0).length;
  const avgChange = rows.filter(r => r.change !== null).reduce((a,b) => a + b.change, 0) / rows.filter(r=>r.change!==null).length;

  eid('tcSummary').innerHTML = `
    <div class="stat-grid">
      <div class="stat-card green"><div class="stat-value">${improved}</div><div class="stat-label">Improved â¬†ï¸</div></div>
      <div class="stat-card red"><div class="stat-value">${declined}</div><div class="stat-label">Declined â¬‡ï¸</div></div>
      <div class="stat-card blue"><div class="stat-value">${same}</div><div class="stat-label">No Change â¡ï¸</div></div>
      <div class="stat-card ${avgChange >= 0 ? 'green' : 'red'}">
        <div class="stat-value">${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(1)}%</div>
        <div class="stat-label">Average Change</div>
      </div>
    </div>`;

  eid('tcSummaryCard').style.display = 'block';
  eid('tcTableCard').style.display = 'block';
  eid('tcChartCard').style.display = 'block';

  // Table
  rows.sort((a,b) => (b.change||0) - (a.change||0));
  eid('tcTable').innerHTML = rows.map((r,i) => {
    const chg = r.change;
    const arrow = chg === null ? 'â€”' : chg > 0 ? `<span style="color:var(--accent2);">â–² +${chg.toFixed(1)}</span>`
      : chg < 0 ? `<span style="color:var(--danger);">â–¼ ${chg.toFixed(1)}</span>`
      : `<span style="color:var(--muted);">â†’ 0.0</span>`;
    const trend = chg === null ? 'â€”' : chg > 5 ? 'ğŸš€ Big Jump' : chg > 0 ? 'ğŸ“ˆ Improving'
      : chg < -5 ? 'ğŸ”´ Dropped' : chg < 0 ? 'ğŸ“‰ Slight Drop' : 'â¡ï¸ Stable';
    const gradeChange = (r.baseGrade && r.compGrade)
      ? `<span class="grade-pill g${r.baseGrade.grade}">${r.baseGrade.grade}</span> â†’ <span class="grade-pill g${r.compGrade.grade}">${r.compGrade.grade}</span>`
      : 'â€”';
    return `<tr>
      <td>${i+1}</td>
      <td><strong>${r.s.name}</strong></td>
      <td class="mono">${r.baseScore !== null ? r.baseScore.toFixed(1) : 'â€”'}</td>
      <td class="mono">${r.compScore !== null ? r.compScore.toFixed(1) : 'â€”'}</td>
      <td class="mono">${arrow}</td>
      <td style="font-size:.8rem;">${trend}</td>
      <td>${gradeChange}</td>
    </tr>`;
  }).join('');

  // Chart â€” top 10 improvers
  const top10 = rows.filter(r => r.change !== null).slice(0,10);
  setTimeout(() => drawBar('tcChart',
    top10.map(r => r.s.name.split(' ')[0]),
    top10.map(r => r.change.toFixed(1)),
    top10.map(r => r.change >= 0 ? '#00D084' : '#F87171')
  ), 80);

  window._TC_ROWS = rows;
  window._TC_BASE = baseTerm;
  window._TC_COMP = compTerm;
  toast('Term comparison complete!', 'success');
}

// Save current scores as a term snapshot
async function saveTermSnapshot() {
  await loadAllScores();
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const p = PROFILE;
  const year = p.year || '';
  const term = p.term || 'Term 1';
  const key  = `${myUid()}_${term.replace(' ','')}_${year.replace('/','_')}`;
  const students = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    return { id: s.id, name: s.name, gender: s.gender, overall: t.overall };
  });
  await setDoc(doc(db, 'termSnapshots', key), {
    uid: myUid(), term, year, students, createdAt: serverTimestamp(),
  });
  toast(`Snapshot saved for ${term} ${year}!`, 'success');
}

function exportTermCompCSV() {
  const rows = window._TC_ROWS || [];
  if (!rows.length) return toast('Run comparison first.', 'error');
  const base = window._TC_BASE || 'Term 1';
  const comp = window._TC_COMP || 'Term 2';
  const lines = [
    `Name,Gender,${base} %,${comp} %,Change,Grade ${base},Grade ${comp}`,
    ...rows.map(r => [
      r.s.name, r.s.gender,
      r.baseScore?.toFixed(1)||'', r.compScore?.toFixed(1)||'',
      r.change?.toFixed(1)||'', r.baseGrade?.grade||'', r.compGrade?.grade||''
    ].join(','))
  ];
  const blob = new Blob([lines.join('\n')], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='TermComparison.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('CSV exported!', 'success');
}

// â”€â”€ 2. STUDENT PROMOTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROMOTION_STATUSES = ['Promoted', 'Repeated', 'Graduated', 'Transferred', 'Withdrawn'];
let PROMOTION_DATA = {};

async function renderPromotionTable() {
  await loadAllScores();
  // Load saved promotion data from Firebase
  const { db, doc, getDoc } = window.FB;
  const snap = await getDoc(doc(db, 'promotions', myUid()));
  PROMOTION_DATA = snap.exists() ? snap.data().records || {} : {};

  const p = PROFILE;
  const nextClassMap = {
    'Form 1': 'Form 2', 'Form 2': 'Form 3', 'Form 3': 'Graduated',
    'JHS 1': 'JHS 2', 'JHS 2': 'JHS 3', 'JHS 3': 'SHS 1',
    'Class 5': 'Class 6', 'Class 6': 'JHS 1',
  };
  // Auto-detect next class from current class name
  const currentForm = (p.class || '').split(' ').slice(0,2).join(' ');
  const autoNext = Object.entries(nextClassMap).find(([k]) => (p.class||'').includes(k));
  const defaultNext = autoNext ? autoNext[1] : '';

  const tbody = eid('promotionTable');
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return { s, t, grade };
  }).sort((a,b) => (b.t.overall||0) - (a.t.overall||0));

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸ“</div><h3>No students yet</h3></div></td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map((r, i) => {
    const saved = PROMOTION_DATA[r.s.id] || {};
    const status = saved.status || (r.grade?.grade === 'F' ? 'Repeated' : 'Promoted');
    const nextCls = saved.nextClass || (status === 'Promoted' ? defaultNext : p.class || '');
    return `<tr>
      <td>${i+1}</td>
      <td><strong>${r.s.name}</strong><br><span style="font-size:.75rem;color:var(--muted);">${r.s.gender}</span></td>
      <td class="mono">${r.t.overall !== null ? r.t.overall.toFixed(1)+'%' : 'â€”'}</td>
      <td>${r.grade ? `<span class="grade-pill g${r.grade.grade}">${r.grade.grade}</span>` : 'â€”'}</td>
      <td>
        <select class="form-control" id="prom_status_${r.s.id}" style="min-width:130px;font-size:.82rem;" onchange="updatePromotionRow('${r.s.id}')">
          ${PROMOTION_STATUSES.map(st => `<option value="${st}" ${status===st?'selected':''}>${st}</option>`).join('')}
        </select>
      </td>
      <td><input type="text" class="form-control" id="prom_next_${r.s.id}" value="${nextCls}" placeholder="Next class" style="min-width:140px;font-size:.82rem;"/></td>
      <td><input type="text" class="form-control" id="prom_note_${r.s.id}" value="${saved.note||''}" placeholder="Optional note" style="min-width:160px;font-size:.82rem;"/></td>
    </tr>`;
  }).join('');

  renderPromotionSummary(rows);
}

function updatePromotionRow(sid) {
  // Dynamically update next class field hint when status changes
  const status = eid(`prom_status_${sid}`)?.value;
  if (status === 'Graduated') {
    const el = eid(`prom_next_${sid}`);
    if (el) el.value = 'Graduated';
  }
}

function renderPromotionSummary(rows) {
  const counts = {};
  PROMOTION_STATUSES.forEach(s => counts[s] = 0);
  rows.forEach(r => {
    const status = eid(`prom_status_${r.s.id}`)?.value || 'Promoted';
    counts[status] = (counts[status]||0) + 1;
  });
  const icons = { Promoted:'â¬†ï¸', Repeated:'ğŸ”„', Graduated:'ğŸ“', Transferred:'ğŸšŒ', Withdrawn:'âŒ' };
  eid('promotionSummary').innerHTML = `
    <div class="stat-grid">
      ${Object.entries(counts).map(([s,c]) => `
        <div class="stat-card ${s==='Promoted'?'green':s==='Repeated'?'red':s==='Graduated'?'gold':'blue'}">
          <div class="stat-value">${c}</div>
          <div class="stat-label">${icons[s]||''} ${s}</div>
        </div>`).join('')}
    </div>`;
}

function autoSetPromotion() {
  STUDENTS.forEach(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    const sel = eid(`prom_status_${s.id}`);
    if (sel) sel.value = grade?.grade === 'F' ? 'Repeated' : 'Promoted';
  });
  toast('Auto-set based on grades. Review and adjust if needed.', 'info');
}

async function saveAllPromotion() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const records = {};
  STUDENTS.forEach(s => {
    records[s.id] = {
      status: eid(`prom_status_${s.id}`)?.value || 'Promoted',
      nextClass: eid(`prom_next_${s.id}`)?.value || '',
      note: eid(`prom_note_${s.id}`)?.value || '',
      name: s.name,
    };
  });
  await setDoc(doc(db, 'promotions', myUid()), {
    uid: myUid(), records,
    class: PROFILE.class || '', year: PROFILE.year || '',
    updatedAt: serverTimestamp(),
  });
  PROMOTION_DATA = records;
  toast('Promotion records saved to Firebase! â˜ï¸', 'success');
  // Also save a term snapshot automatically
  await saveTermSnapshot();
}

function exportPromotionCSV() {
  const rows = STUDENTS.map(s => {
    const t = getStudentTotal(s);
    const grade = t.overall !== null ? getGrade(t.overall) : null;
    return [
      s.name, s.gender, s.index||'',
      t.overall !== null ? t.overall.toFixed(1) : '',
      grade?.grade||'',
      eid(`prom_status_${s.id}`)?.value||'',
      eid(`prom_next_${s.id}`)?.value||'',
      eid(`prom_note_${s.id}`)?.value||'',
    ].join(',');
  });
  const blob = new Blob([['Name,Gender,Index,Overall%,Grade,Status,NextClass,Notes',...rows].join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='Promotion.csv'; a.click(); URL.revokeObjectURL(url);
  toast('Promotion CSV exported!', 'success');
}

// â”€â”€ 3. LEAGUE TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let LEAGUE_DATA = [];

async function buildLeagueTable() {
  if (!isHeadTeacher() && !isAdmin()) {
    return toast('League Table is only available to Head Teachers and Admins.', 'error');
  }
  const { db, collection, getDocs } = window.FB;
  const filter = eid('leagueFilter')?.value || 'all';

  // Load all profiles and scores from Firebase
  const [profilesSnap, scoresSnap, studentsSnap, assessSnap] = await Promise.all([
    getDocs(collection(db, 'profiles')),
    getDocs(collection(db, 'scores')),
    getDocs(collection(db, 'students')),
    getDocs(collection(db, 'assessments')),
  ]);

  const allProfiles   = profilesSnap.docs.map(d => ({ id:d.id, ...d.data() }));
  const allScores     = scoresSnap.docs.map(d => ({ id:d.id, ...d.data() }));
  const allStudents   = studentsSnap.docs.map(d => ({ id:d.id, ...d.data() }));
  const allAssess     = assessSnap.docs.map(d => ({ id:d.id, ...d.data() }));

  const leagueRows = allProfiles.map(prof => {
    const teacher = ALL_USERS.find(u => u.uid === prof.uid);
    const myStudents = allStudents.filter(s => s.uid === prof.uid);
    const myAssess   = allAssess.filter(a => a.uid === prof.uid);

    // Calculate each student's overall score
    const studentScores = myStudents.map(s => {
      let caTotal=0, caMax=0, examTotal=0, examMax=0;
      myAssess.forEach(a => {
        const sc = allScores.find(sc => sc.id === a.id)?.[s.id];
        if (sc !== undefined && !isNaN(sc)) {
          if (a.type === 'Exam') { examTotal+=sc; examMax+=a.total; }
          else { caTotal+=sc; caMax+=a.total; }
        }
      });
      const caW  = (prof.caWeight||30)/100;
      const exW  = (prof.examWeight||70)/100;
      const caPct  = caMax>0 ? (caTotal/caMax)*100 : 0;
      const exPct  = examMax>0 ? (examTotal/examMax)*100 : 0;
      let overall = null;
      if (caMax>0&&examMax>0) overall=caPct*caW+exPct*exW;
      else if (caMax>0) overall=caPct;
      else if (examMax>0) overall=exPct;
      return overall;
    }).filter(v => v !== null);

    if (!studentScores.length) return null;
    const avg = studentScores.reduce((a,b)=>a+b,0)/studentScores.length;
    const passed = studentScores.filter(s => {
      const g = getGrade(s); return g && g.grade !== 'F';
    }).length;
    const topGrade = getGrade(Math.max(...studentScores));

    return {
      teacher: teacher?.name || 'Unknown',
      school: prof.school || 'â€”',
      class: prof.class || 'â€”',
      subject: prof.subject || 'â€”',
      students: studentScores.length,
      avg, passed,
      passRate: (passed/studentScores.length)*100,
      topGrade: topGrade?.grade || 'â€”',
    };
  }).filter(Boolean);

  // Apply filter
  const filtered = filter === 'all' ? leagueRows
    : leagueRows.filter(r => r.class.startsWith(filter));

  // Sort by average descending
  filtered.sort((a,b) => b.avg - a.avg);
  LEAGUE_DATA = filtered;

  // Stats
  const statsEl = eid('leagueStats');
  if (statsEl && filtered.length) {
    const schoolAvg = filtered.reduce((a,b)=>a+b.avg,0)/filtered.length;
    const best = filtered[0];
    statsEl.innerHTML = `
      <div class="stat-card green"><div class="stat-value">${filtered.length}</div><div class="stat-label">Classes Ranked</div></div>
      <div class="stat-card gold"><div class="stat-value">${schoolAvg.toFixed(1)}%</div><div class="stat-label">School Average</div></div>
      <div class="stat-card blue"><div class="stat-value">${best.avg.toFixed(1)}%</div><div class="stat-label">Top Class Avg</div></div>
      <div class="stat-card green"><div class="stat-value">${(filtered.reduce((a,b)=>a+b.passRate,0)/filtered.length).toFixed(0)}%</div><div class="stat-label">School Pass Rate</div></div>
    `;
  }

  // Medal emojis
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const tbody = eid('leagueTable');
  tbody.innerHTML = filtered.map((r,i) => {
    const bar = `<div class="progress-bar" style="width:clamp(80px,15vw,140px);display:inline-block;">
      <div class="progress-fill" style="width:${r.avg}%;background:${i===0?'#FCD116':i===1?'#C0C0C0':i===2?'#CD7F32':'var(--accent)'};"></div>
    </div> <span style="font-size:.78rem;">${r.avg.toFixed(1)}%</span>`;
    return `<tr>
      <td><strong>${medals[i]||'#'+(i+1)}</strong></td>
      <td>${r.teacher}</td>
      <td><strong>${r.class}</strong></td>
      <td>${r.subject}</td>
      <td class="mono">${r.students}</td>
      <td class="mono"><strong>${r.avg.toFixed(1)}%</strong></td>
      <td class="mono">${r.passRate.toFixed(0)}%</td>
      <td><span class="grade-pill g${r.topGrade}">${r.topGrade}</span></td>
      <td>${bar}</td>
    </tr>`;
  }).join('') || `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ†</div><p>No class data yet.</p></div></td></tr>`;

  // Subject chart
  const subjectMap = {};
  filtered.forEach(r => {
    if (!subjectMap[r.subject]) subjectMap[r.subject] = [];
    subjectMap[r.subject].push(r.avg);
  });
  const subjects = Object.keys(subjectMap);
  const subjectAvgs = subjects.map(s => (subjectMap[s].reduce((a,b)=>a+b,0)/subjectMap[s].length).toFixed(1));
  const subColors = ['#4ADE80','#60A5FA','#FBBF24','#F472B6','#A78BFA','#FB923C','#34D399'];
  setTimeout(() => drawBar('leagueChart', subjects, subjectAvgs, subColors), 80);

  toast(`League table built â€” ${filtered.length} classes ranked!`, 'success');
}

function exportLeagueCSV() {
  if (!LEAGUE_DATA.length) return toast('Generate league table first.', 'error');
  const lines = [
    'Rank,Teacher,Class,Subject,Students,Avg%,Pass%,Top Grade',
    ...LEAGUE_DATA.map((r,i) => [i+1,r.teacher,r.class,r.subject,r.students,r.avg.toFixed(1),r.passRate.toFixed(0),r.topGrade].join(','))
  ];
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='LeagueTable.csv'; a.click(); URL.revokeObjectURL(url);
  toast('League CSV exported!', 'success');
}

// â”€â”€ 4. TIMETABLE BUILDER (Fully Configurable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TT_DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday'];

// Each period: { name, start, end, isBreak }
// Schools can fully customise â€” saved to Firebase per teacher
let TT_PERIODS_CONFIG = [
  { name:'Period 1',  start:'7:30',  end:'8:10',  isBreak:false },
  { name:'Period 2',  start:'8:10',  end:'8:50',  isBreak:false },
  { name:'Period 3',  start:'8:50',  end:'9:30',  isBreak:false },
  { name:'Break',     start:'9:30',  end:'9:50',  isBreak:true  },
  { name:'Period 4',  start:'9:50',  end:'10:30', isBreak:false },
  { name:'Period 5',  start:'10:30', end:'11:10', isBreak:false },
  { name:'Period 6',  start:'11:10', end:'11:50', isBreak:false },
  { name:'Lunch',     start:'11:50', end:'12:30', isBreak:true  },
  { name:'Period 7',  start:'12:30', end:'1:10',  isBreak:false },
  { name:'Period 8',  start:'1:10',  end:'1:50',  isBreak:false },
];

let TT_DATA = {}; // {day_period: {subject, teacher}}

function renderTTPeriodConfig() {
  const el = eid('ttPeriodConfig');
  if (!el) return;
  el.innerHTML = TT_PERIODS_CONFIG.map((p, i) => `
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:7px 10px;
      background:${p.isBreak ? 'rgba(252,209,22,.06)' : 'var(--dark3)'};
      border-radius:8px;border:1px solid var(--border);margin-bottom:2px;">
      <span style="font-size:.78rem;color:var(--muted);width:18px;">${i+1}</span>
      <input type="text" value="${p.name}"
        style="width:90px;padding:5px 8px;background:var(--dark2);border:1px solid var(--border2);
        border-radius:6px;color:var(--text);font-size:.8rem;"
        oninput="TT_PERIODS_CONFIG[${i}].name=this.value"/>
      <input type="time" value="${toTimeInput(p.start)}"
        style="padding:5px 7px;background:var(--dark2);border:1px solid var(--border2);
        border-radius:6px;color:var(--text);font-size:.8rem;"
        oninput="TT_PERIODS_CONFIG[${i}].start=fromTimeInput(this.value)"/>
      <span style="color:var(--muted);font-size:.8rem;">to</span>
      <input type="time" value="${toTimeInput(p.end)}"
        style="padding:5px 7px;background:var(--dark2);border:1px solid var(--border2);
        border-radius:6px;color:var(--text);font-size:.8rem;"
        oninput="TT_PERIODS_CONFIG[${i}].end=fromTimeInput(this.value)"/>
      <label style="display:flex;align-items:center;gap:5px;font-size:.8rem;color:var(--muted);cursor:pointer;white-space:nowrap;">
        <input type="checkbox" ${p.isBreak ? 'checked' : ''}
          onchange="TT_PERIODS_CONFIG[${i}].isBreak=this.checked;renderTTPeriodConfig()"/>
        Break/Lunch
      </label>
      <button class="btn-icon" onclick="removeTTPeriod(${i})" style="margin-left:auto;font-size:.85rem;" title="Remove row">ğŸ—‘ï¸</button>
    </div>`).join('');
}

function toTimeInput(t) {
  if (!t) return '07:00';
  const parts = t.replace(/[^\d:]/g,'').split(':');
  const h = (parts[0]||'7').padStart(2,'0');
  const m = (parts[1]||'00').padStart(2,'0');
  return h + ':' + m;
}

function fromTimeInput(val) {
  if (!val) return '';
  const [h,m] = val.split(':');
  return parseInt(h) + ':' + m;
}

function addTTPeriod() {
  const last = TT_PERIODS_CONFIG[TT_PERIODS_CONFIG.length - 1];
  TT_PERIODS_CONFIG.push({
    name: 'Period ' + (TT_PERIODS_CONFIG.filter(p=>!p.isBreak).length + 1),
    start: last ? last.end : '14:00',
    end: '14:40',
    isBreak: false,
  });
  renderTTPeriodConfig();
  toast('New period added. Edit the name and times, then click Apply.', 'info');
}

function removeTTPeriod(idx) {
  if (TT_PERIODS_CONFIG.length <= 1) return toast('Need at least one period.', 'error');
  confirm2('Remove this period row?', () => {
    TT_PERIODS_CONFIG.splice(idx, 1);
    renderTTPeriodConfig();
  });
}

function applyTTPeriodConfig() {
  buildTTGrid();
  toast('Timetable grid updated with your period settings!', 'success');
}

function buildTTGrid() {
  const thead = eid('ttHead');
  const tbody = eid('ttBody');
  if (!thead || !tbody) return;
  renderTTPeriodConfig();

  thead.innerHTML = '<tr><th style="background:var(--dark3);padding:8px 10px;min-width:110px;white-space:nowrap;">Period / Time</th>'
    + TT_DAYS.map(d => '<th style="background:var(--gh-green);color:#fff;padding:8px 12px;min-width:130px;text-align:center;">' + d + '</th>').join('')
    + '</tr>';

  tbody.innerHTML = TT_PERIODS_CONFIG.map((p, pi) => {
    const timeLabel = p.start + '\u2013' + p.end;
    if (p.isBreak) {
      return '<tr style="background:rgba(252,209,22,.06);">'
        + '<td style="padding:6px 10px;font-size:.8rem;color:var(--gh-gold);font-weight:700;border-bottom:1px solid var(--border);white-space:nowrap;">'
        + p.name + '<br><span style="font-size:.72rem;color:var(--muted);">' + timeLabel + '</span></td>'
        + TT_DAYS.map(d => '<td style="padding:6px;text-align:center;color:var(--muted);font-size:.78rem;border-bottom:1px solid var(--border);border-left:1px solid var(--border);">\u2014 ' + p.name + ' \u2014</td>').join('')
        + '</tr>';
    }
    return '<tr>'
      + '<td style="padding:6px 10px;font-size:.8rem;font-weight:600;border-bottom:1px solid var(--border);white-space:nowrap;">'
      + p.name + '<br><span style="font-size:.72rem;color:var(--muted);">' + timeLabel + '</span></td>'
      + TT_DAYS.map(d => {
          const key = d + '_' + pi;
          const saved = TT_DATA[key] || {};
          return '<td style="padding:4px;border-bottom:1px solid var(--border);border-left:1px solid var(--border);">'
            + '<input type="text" placeholder="Subject" value="' + (saved.subject||'') + '"'
            + ' style="width:100%;padding:4px 6px;background:var(--dark2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:.78rem;margin-bottom:2px;"'
            + ' oninput="TT_DATA[\'' + key + '\']={...(TT_DATA[\'' + key + '\']||{}),subject:this.value}"/>'
            + '<input type="text" placeholder="Teacher" value="' + (saved.teacher||'') + '"'
            + ' style="width:100%;padding:4px 6px;background:var(--dark3);border:1px solid var(--border);border-radius:4px;color:var(--muted);font-size:.72rem;"'
            + ' oninput="TT_DATA[\'' + key + '\']={...(TT_DATA[\'' + key + '\']||{}),teacher:this.value}"/>'
            + '</td>';
        }).join('')
      + '</tr>';
  }).join('');
}

async function loadMyTimetable() {
  const { db, doc, getDoc } = window.FB;
  const snap = await getDoc(doc(db, 'timetables', myUid()));
  if (snap.exists()) {
    const d = snap.data();
    TT_DATA = d.grid || {};
    if (d.periods && d.periods.length) TT_PERIODS_CONFIG = d.periods;
    if (eid('ttClass')) eid('ttClass').value = d.className || PROFILE.class || '';
    if (eid('ttYear'))  eid('ttYear').value  = d.year || PROFILE.year || '';
  } else {
    TT_DATA = {};
    if (eid('ttClass')) eid('ttClass').value = PROFILE.class || '';
    if (eid('ttYear'))  eid('ttYear').value  = PROFILE.year || '';
  }
  buildTTGrid();
  renderTTView();
}

async function saveTimetable() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  // Read all current input values from the grid
  TT_PERIODS_CONFIG.forEach((p, pi) => {
    if (p.isBreak) return;
    TT_DAYS.forEach((d, di) => {
      const key = d + '_' + pi;
      const rows = document.querySelectorAll('#ttBody tr');
      const row = rows[pi];
      if (!row) return;
      const cells = row.querySelectorAll('td');
      const cell = cells[di + 1];
      if (!cell) return;
      const inputs = cell.querySelectorAll('input');
      if (inputs.length >= 2) {
        TT_DATA[key] = { subject: inputs[0].value.trim(), teacher: inputs[1].value.trim() };
      }
    });
  });
  await setDoc(doc(db, 'timetables', myUid()), {
    uid: myUid(),
    className: eid('ttClass') ? eid('ttClass').value : '',
    year: eid('ttYear') ? eid('ttYear').value : '',
    grid: TT_DATA,
    periods: TT_PERIODS_CONFIG,
    updatedAt: serverTimestamp(),
  });
  renderTTView();
  toast('Timetable saved to Firebase! \u2601\ufe0f', 'success');
}

function clearTimetable() {
  confirm2('Clear all timetable entries?', () => {
    TT_DATA = {};
    buildTTGrid();
    toast('Timetable cleared.', 'info');
  });
}

function renderTTView() {
  const el = eid('ttViewWrap');
  if (!el) return;
  const className = (eid('ttClass') ? eid('ttClass').value : '') || PROFILE.class || '';
  const year = (eid('ttYear') ? eid('ttYear').value : '') || PROFILE.year || '';

  let html = '<div style="text-align:center;margin-bottom:14px;">'
    + '<div style="font-size:1.4rem;margin-bottom:4px;">\ud83c\uddec\ud83c\udded</div>'
    + '<h3 style="color:var(--accent2);">' + className + ' \u2014 Weekly Timetable</h3>'
    + '<p style="font-size:.82rem;color:var(--muted);">Academic Year: ' + year + ' \u00b7 Teacher: ' + (USER_DOC ? USER_DOC.name || '' : '') + '</p>'
    + '</div>'
    + '<div style="overflow-x:auto;"><table style="border-collapse:collapse;width:100%;min-width:600px;font-size:.82rem;">'
    + '<thead><tr>'
    + '<th style="background:var(--gh-green);color:#fff;padding:8px 10px;">Period / Time</th>'
    + TT_DAYS.map(d => '<th style="background:var(--gh-green);color:#fff;padding:8px 12px;text-align:center;">' + d + '</th>').join('')
    + '</tr></thead><tbody>';

  TT_PERIODS_CONFIG.forEach((p, pi) => {
    const timeLabel = p.start + '\u2013' + p.end;
    if (p.isBreak) {
      html += '<tr style="background:rgba(252,209,22,.08);">'
        + '<td style="padding:6px 10px;font-size:.78rem;color:var(--gh-gold);font-weight:700;border:1px solid var(--border);">'
        + p.name + '<br><small>' + timeLabel + '</small></td>'
        + TT_DAYS.map(() => '<td style="text-align:center;color:var(--muted);border:1px solid var(--border);font-size:.75rem;">\u2014 ' + p.name + ' \u2014</td>').join('')
        + '</tr>';
    } else {
      html += '<tr><td style="padding:6px 10px;font-weight:600;border:1px solid var(--border);white-space:nowrap;font-size:.78rem;">'
        + p.name + '<br><small style="color:var(--muted);">' + timeLabel + '</small></td>'
        + TT_DAYS.map(d => {
            const cell = TT_DATA[d + '_' + pi] || {};
            return '<td style="padding:6px 8px;border:1px solid var(--border);text-align:center;vertical-align:top;">'
              + (cell.subject ? '<div style="font-weight:700;font-size:.82rem;">' + cell.subject + '</div>' : '<span style="color:var(--muted);font-size:.75rem;">\u2014</span>')
              + (cell.teacher ? '<div style="font-size:.72rem;color:var(--muted);">' + cell.teacher + '</div>' : '')
              + '</td>';
          }).join('')
        + '</tr>';
    }
  });

  html += '</tbody></table></div>';
  el.innerHTML = html;
}

function buildTimetableText() {
  const className = (eid('ttClass') ? eid('ttClass').value : '') || PROFILE.class || '';
  const year = (eid('ttYear') ? eid('ttYear').value : '') || PROFILE.year || '';
  const lines = [
    '\ud83c\uddec\ud83c\udded *TIMETABLE \u2014 ' + className + '*',
    '\ud83d\udcc5 Academic Year: ' + year,
    '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501',
    '',
  ];
  TT_DAYS.forEach(d => {
    lines.push('*' + d.toUpperCase() + '*');
    TT_PERIODS_CONFIG.forEach((p, pi) => {
      const timeLabel = p.start + '\u2013' + p.end;
      if (p.isBreak) {
        lines.push('  \ud83d\udd36 ' + p.name + ' (' + timeLabel + ')');
      } else {
        const cell = TT_DATA[d + '_' + pi] || {};
        if (cell.subject) {
          lines.push('  ' + p.name + ' (' + timeLabel + '): *' + cell.subject + '*' + (cell.teacher ? ' \u2014 ' + cell.teacher : ''));
        }
      }
    });
    lines.push('');
  });
  lines.push('_Shared via GES Assessment Manager_');
  return lines.join('\n');
}


function shareTimetableWA() {
  const text = buildTimetableText();
  window._TT_TEXT = text;
  eid('ttShareText').textContent = text;
  eid('ttSharePreview').style.display = 'block';
  const encoded = encodeURIComponent(text);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
  toast('Opening WhatsApp with timetableâ€¦', 'success');
}

function copyTimetableText() {
  const text = buildTimetableText();
  eid('ttShareText').textContent = text;
  eid('ttSharePreview').style.display = 'block';
  navigator.clipboard.writeText(text)
    .then(() => toast('Timetable copied to clipboard!', 'success'))
    .catch(() => toast('Select and copy the text manually.', 'error'));
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASE 3 FEATURES
//  1. Messaging  2. Notice Board  3. Local Language  4. Student Photos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ 1. STAFF MESSAGING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ACTIVE_CHAT_UID = null;
let MSG_UNSUB = null;
let UNREAD_MSG_COUNT = 0;

function subscribeMessages() {
  // Watch all messages sent TO me â€” counts unread badge, also refreshes contacts
  if (!window.FB?.db) return;
  const { db, collection, query, where, onSnapshot } = window.FB;
  const q = query(collection(db, 'messages'), where('toUid', '==', myUid()));
  const unsub = onSnapshot(q, snap => {
    UNREAD_MSG_COUNT = snap.docs.filter(d => !d.data().read).length;
    const el = eid('unreadMsgCount');
    if (el) el.textContent = UNREAD_MSG_COUNT > 0 ? UNREAD_MSG_COUNT : '0';
    // If messaging page is open and a new message arrives from the active chat sender,
    // the openChat listener handles it â€” but refresh contact list for unread indicators
    if (eid('page-messaging').classList.contains('active')) renderMsgContacts();
  });
  UNSUBSCRIBERS.push(unsub);
}

function renderMsgContacts() {
  const el = eid('msgContactList');
  if (!el) return;

  const me = myUid();
  const q = (eid('msgSearch')?.value || '').toLowerCase();

  // Use u.uid if set, otherwise fall back to doc id â€” handles manually created admin accounts
  const contacts = ALL_USERS.filter(u => {
    const theirUid = u.uid || u.id;
    if (theirUid === me) return false;                     // exclude self
    if (u.status && u.status !== 'approved') return false; // exclude pending/suspended
    if (q && !(u.name||'').toLowerCase().includes(q)) return false;
    return true;
  });

  if (!contacts.length) {
    // If ALL_USERS is empty, data hasn't loaded yet â€” show loading not "no staff"
    const msg = ALL_USERS.length === 0
      ? 'Loading staff listâ€¦'
      : 'No other approved staff found';
    el.innerHTML = `<div style="padding:16px;text-align:center;font-size:.82rem;color:var(--muted);">${msg}</div>`;
    return;
  }

  el.innerHTML = contacts.map(u => {
    const uid = u.uid || u.id;
    const name = u.name || 'Unknown';
    const role = u.role || 'teacher';
    const initials = name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    const roleClass = { teacher:'role-teacher', headteacher:'role-headteacher', admin:'role-admin', coadmin:'role-coadmin' }[role] || 'role-teacher';
    const isActive = ACTIVE_CHAT_UID === uid;
    const bg = isActive ? 'var(--dark3)' : 'transparent';
    const safeName = name.replace(/'/g, '&#39;');
    return `<div onclick="openChat('${uid}','${safeName}','${role}')"
      style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;cursor:pointer;
      background:${bg};margin-bottom:2px;transition:background .2s;"
      onmouseenter="this.style.background='var(--dark3)'" onmouseleave="this.style.background='${bg}'">
      <div class="avatar" style="width:34px;height:34px;font-size:.78rem;flex-shrink:0;">${initials}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
        <span class="role-chip ${roleClass}" style="font-size:.68rem;padding:2px 7px;">${role}</span>
      </div>
    </div>`;
  }).join('');
}

function filterMsgContacts() { renderMsgContacts(); }

// Build a stable conversation ID from two UIDs (alphabetical so both sides get same ID)
function convoId(uid1, uid2) {
  return [uid1, uid2].sort().join('__');
}

async function openChat(uid, name, role) {
  ACTIVE_CHAT_UID = uid;
  renderMsgContacts();

  const header = eid('msgChatHeader');
  if (header) header.innerHTML = `
    <div class="avatar" style="width:30px;height:30px;font-size:.75rem;margin-right:8px;flex-shrink:0;">${name.split(' ').map(w=>w[0]).join('').substring(0,2)}</div>
    <span style="flex:1;font-weight:700;">${name}</span>
    <span class="role-chip role-${role}" style="margin-right:8px;font-size:.7rem;">${role}</span>
    <button class="btn-icon" onclick="clearChat('${uid}','${name.replace(/'/g,"&#39;")}')" title="Clear chat" style="color:var(--danger);font-size:.9rem;">ğŸ—‘ï¸</button>
  `;

  const body = eid('msgChatBody');
  if (body) body.innerHTML = '<div style="text-align:center;padding:30px;font-size:.85rem;color:var(--muted);">Loading messagesâ€¦</div>';

  if (MSG_UNSUB) { MSG_UNSUB(); MSG_UNSUB = null; }

  const { db, collection, query, where, onSnapshot, doc, updateDoc } = window.FB;
  const myId = myUid();

  // Two simple single-field queries â€” no composite index required.
  // Q1: messages I sent to them  Q2: messages they sent to me
  // We merge and sort client-side by createdAt.
  let sentMsgs = [];
  let recvMsgs = [];
  let listeners = 0;

  function renderChat() {
    if (!body) return;
    // Merge both arrays, deduplicate by id, sort by createdAt timestamp
    const allMap = {};
    [...sentMsgs, ...recvMsgs].forEach(m => allMap[m.id] = m);
    const msgs = Object.values(allMap).sort((a, b) => {
      const ta = a.createdAt?.toMillis?.() ?? a.createdAt?.seconds * 1000 ?? 0;
      const tb = b.createdAt?.toMillis?.() ?? b.createdAt?.seconds * 1000 ?? 0;
      return ta - tb;
    });

    if (!msgs.length) {
      body.innerHTML = '<div style="text-align:center;padding:30px;font-size:.85rem;color:var(--muted);">No messages yet. Say hello! ğŸ‘‹</div>';
      return;
    }

    body.innerHTML = msgs.map(m => {
      const isMe = m.fromUid === myId;
      const time = m.createdAt?.toDate?.().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || '';
      const align = isMe ? 'flex-end' : 'flex-start';
      const radius = isMe ? '14px 14px 4px 14px' : '14px 14px 14px 4px';
      const bg = isMe ? 'var(--gh-green)' : 'var(--card)';
      const color = isMe ? '#fff' : 'var(--text)';
      return `<div style="display:flex;justify-content:${align};margin-bottom:4px;">
        <div class="msg-bubble" style="padding:9px 13px;border-radius:${radius};
          background:${bg};color:${color};
          font-size:.86rem;line-height:1.5;box-shadow:0 2px 8px rgba(0,0,0,.2);
          word-break:break-word;overflow-wrap:anywhere;">
          ${m.text}
          <div style="font-size:.68rem;opacity:.6;margin-top:3px;text-align:right;">${time}${isMe ? ' âœ“' : ''}</div>
        </div>
      </div>`;
    }).join('');
    body.scrollTop = body.scrollHeight;

    // Mark unread incoming messages as read
    msgs.filter(m => m.toUid === myId && !m.read).forEach(m => {
      updateDoc(doc(db, 'messages', m.id), { read: true }).catch(() => {});
    });
  }

  // Q1 â€” all messages I sent (fromUid == me), filter to this contact client-side
  const qSent = query(collection(db, 'messages'),
    where('fromUid', '==', myId)
  );
  // Q2 â€” all messages sent to me (toUid == me), filter from this contact client-side
  const qRecv = query(collection(db, 'messages'),
    where('toUid', '==', myId)
  );

  const unsubSent = onSnapshot(qSent, snap => {
    sentMsgs = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(m => m.toUid === uid);   // only this conversation
    renderChat();
  });
  const unsubRecv = onSnapshot(qRecv, snap => {
    recvMsgs = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(m => m.fromUid === uid); // only this conversation
    renderChat();
  });

  // Store both unsubscribers so we can clean up when switching chats
  MSG_UNSUB = () => { unsubSent(); unsubRecv(); };
}

async function sendMessage() {
  if (!ACTIVE_CHAT_UID) return toast('Select a staff member first.', 'error');
  const input = eid('msgInput');
  const text = input?.value.trim();
  if (!text) return;
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const id = 'msg_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  const myId = myUid();
  await setDoc(doc(db, 'messages', id), {
    fromUid: myId,
    toUid: ACTIVE_CHAT_UID,
    text, read: false,
    fromName: USER_DOC?.name || '',
    createdAt: serverTimestamp(),
  });
  if (input) input.value = '';
  const recipient = ALL_USERS.find(u => u.uid === ACTIVE_CHAT_UID);
  await sendNotification(ACTIVE_CHAT_UID,
    'ğŸ’¬ New message from ' + (USER_DOC?.name || 'a colleague'),
    text.length > 60 ? text.substring(0,60) + '...' : text, 'ğŸ’¬');
}

async function clearChat(uid, name) {
  confirm2(
    `Clear your entire conversation with ${name}? This deletes messages on your side only â€” ${name} can still see their copy.`,
    async () => {
      const { db, collection, query, where, getDocs, deleteDoc, doc } = window.FB;
      const myId = myUid();
      toast('Clearing chatâ€¦', 'info');

      try {
        // Fetch all messages I sent to them
        const q1 = query(collection(db, 'messages'), where('fromUid', '==', myId), where('toUid', '==', uid));
        // Fetch all messages they sent to me
        const q2 = query(collection(db, 'messages'), where('fromUid', '==', uid), where('toUid', '==', myId));

        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        const allDocs = [...snap1.docs, ...snap2.docs];

        if (!allDocs.length) return toast('No messages to clear.', 'info');

        // Delete in batches of 10 (avoids rate limits)
        const chunks = [];
        for (let i = 0; i < allDocs.length; i += 10) chunks.push(allDocs.slice(i, i + 10));
        for (const chunk of chunks) {
          await Promise.all(chunk.map(d => deleteDoc(doc(db, 'messages', d.id))));
        }

        // Reset chat UI
        const body = eid('msgChatBody');
        if (body) body.innerHTML = '<div style="text-align:center;padding:30px;font-size:.85rem;color:var(--muted);">No messages yet. Say hello! ğŸ‘‹</div>';

        toast(`Chat with ${name} cleared. âœ“`, 'success');
      } catch(e) {
        toast('Could not clear chat: ' + e.message, 'error');
      }
    }
  );
}

// â”€â”€ 2. NOTICE BOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let NOTICES = [];

function subscribeNotices() {
  if (!window.FB?.db) return;
  const { db, collection, query, orderBy, onSnapshot } = window.FB;
  const q = query(collection(db, 'notices'), orderBy('createdAt', 'desc'));
  const unsub = onSnapshot(q, snap => {
    NOTICES = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (eid('page-notices').classList.contains('active')) renderNoticeBoard();
  });
  UNSUBSCRIBERS.push(unsub);
}

async function postNotice() {
  const { db, doc, setDoc, serverTimestamp } = window.FB;
  const title = eid('noticeTitle')?.value.trim();
  const body = eid('noticeBody')?.value.trim();
  if (!title || !body) return toast('Title and message are required.', 'error');
  const category = eid('noticeCategory')?.value || 'general';
  const audience = eid('noticeAudience')?.value || 'all';
  const id = 'notice_' + Date.now();
  await setDoc(doc(db, 'notices', id), {
    title, body, category, audience,
    authorUid: myUid(),
    authorName: USER_DOC?.name || '',
    authorRole: USER_DOC?.role || '',
    school: USER_DOC?.school || '',
    pinned: false,
    createdAt: serverTimestamp(),
  });
  clearNoticeForm();
  toast('Notice posted to all staff!', 'success');
  // Send notification to all approved users
  const targets = ALL_USERS.filter(u => u.status === 'approved' && u.uid !== myUid());
  await Promise.all(targets.map(u => sendNotification(u.uid,
    'ğŸ“‹ New Notice: ' + title,
    body.length > 80 ? body.substring(0,80) + '...' : body, 'ğŸ“‹')));
}

function clearNoticeForm() {
  ['noticeTitle','noticeBody'].forEach(id => { const el = eid(id); if(el) el.value = ''; });
}

function renderNoticeBoard() {
  const el = eid('noticeBoardList');
  if (!el) return;
  const filter = eid('noticeFilter')?.value || 'all';
  const myRole = USER_DOC?.role || 'teacher';

  const visible = NOTICES.filter(n => {
    if (n.audience === 'admin' && !['admin','coadmin','headteacher'].includes(myRole)) return false;
    if (filter !== 'all' && n.category !== filter) return false;
    return true;
  });

  if (!visible.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><h3>No notices posted yet</h3><p>Be the first to post an announcement.</p></div>';
    return;
  }

  const catIcon = { general:'ğŸ“¢', urgent:'ğŸš¨', meeting:'ğŸ“…', academic:'ğŸ“š', exam:'ğŸ“', welfare:'â¤ï¸' };
  const catColor = { general:'var(--accent2)', urgent:'var(--danger)', meeting:'var(--info)',
    academic:'var(--gh-gold)', exam:'#A78BFA', welfare:'#F472B6' };

  el.innerHTML = visible.map(n => {
    const time = n.createdAt?.toDate?.().toLocaleDateString('en-GH',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) || '';
    const canDelete = n.authorUid === myUid() || isAdminLike();
    return `<div style="border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;
      border-left:4px solid ${catColor[n.category]||'var(--accent2)'};
      background:var(--dark2);position:relative;">
      ${n.pinned ? '<span style="position:absolute;top:12px;right:14px;font-size:.75rem;color:var(--gh-gold);">ğŸ“Œ Pinned</span>' : ''}
      <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;">
        <span style="font-size:1.3rem;">${catIcon[n.category]||'ğŸ“¢'}</span>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:.95rem;margin-bottom:2px;">${n.title}</div>
          <div style="font-size:.75rem;color:var(--muted);">
            ${n.authorName} Â· ${n.authorRole} Â· ${time}
          </div>
        </div>
      </div>
      <div style="font-size:.87rem;line-height:1.7;color:var(--text2);white-space:pre-wrap;">${n.body}</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <span class="badge ${n.category==='urgent'?'badge-red':n.category==='meeting'?'badge-blue':'badge-green'}">${catIcon[n.category]||''} ${n.category}</span>
        <span class="badge badge-gray">${n.audience==='all'?'All Staff':n.audience==='admin'?'Admin Only':'Teachers'}</span>
        ${canDelete ? `<button class="btn-icon" style="margin-left:auto;font-size:.8rem;" onclick="deleteNotice('${n.id}')">ğŸ—‘ï¸ Delete</button>` : ''}
        ${isAdminLike() ? `<button class="btn-icon" style="font-size:.8rem;" onclick="togglePin('${n.id}',${n.pinned})">${n.pinned?'ğŸ“Œ Unpin':'ğŸ“Œ Pin'}</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function deleteNotice(id) {
  confirm2('Delete this notice?', async () => {
    const { db, doc, deleteDoc } = window.FB;
    await deleteDoc(doc(db, 'notices', id));
    toast('Notice deleted.', 'info');
  });
}

async function togglePin(id, currentPinned) {
  const { db, doc, updateDoc } = window.FB;
  await updateDoc(doc(db, 'notices', id), { pinned: !currentPinned });
  toast(currentPinned ? 'Notice unpinned.' : 'Notice pinned to top!', 'info');
}

// â”€â”€ 3. LOCAL LANGUAGE (Twi) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let LANG = 'en'; // 'en' or 'tw'

const TRANSLATIONS = {
  en: {
    dashboard: 'Dashboard', students: 'Students', assessments: 'Assessments',
    results: 'Results', analysis: 'Analysis', reports: 'PDF Reports',
    grading: 'Grading Scale', backup: 'Backup / Export', profile: 'School Profile',
    notifications: 'Notifications', messaging: 'Staff Messaging', notices: 'Notice Board',
    photos: 'Student Photos', promotion: 'Promotion', timetable: 'Timetable',
    save: 'Save', cancel: 'Cancel', delete: 'Delete', add: 'Add',
    search: 'Search', export: 'Export', print: 'Print', generate: 'Generate',
    welcome: 'Welcome back', noStudents: 'No students yet', addStudent: 'Add Student',
    male: 'Male', female: 'Female', grade: 'Grade', score: 'Score',
  },
  tw: {
    dashboard: 'HwÉ› Mmere', students: 'Nnipa Kâ†„â†„', assessments: 'NhwehwÉ›mu',
    results: 'Ntease', analysis: 'NimdeÉ› HwÉ›', reports: 'Krataa',
    grading: 'NkÉ”so NhwehwÉ›', backup: 'Fa Nkra', profile: 'Sukuu Ho NsÉ›m',
    notifications: 'AmaneÉ›', messaging: 'Nkra', notices: 'Dawuru',
    photos: 'Mfonini', promotion: 'Kâ†„ Soro', timetable: 'BerÉ› Krataa',
    save: 'Sie', cancel: 'Gyae', delete: 'Popa', add: 'Fa BÉ›ka',
    search: 'HwehwÉ›', export: 'Pue', print: 'KyerÉ›', generate: 'YÉ›',
    welcome: 'Akwaaba', noStudents: 'Nnipa nni hâ†„', addStudent: 'Fa Onipa Bâ†„',
    male: 'Æ†barima', female: 'â†ƒbaa', grade: 'NkÉ”so', score: 'NhyÉ›',
  }
};

function toggleLanguage() {
  LANG = LANG === 'en' ? 'tw' : 'en';
  const btn = eid('langToggle');
  if (btn) btn.textContent = LANG === 'tw' ? 'ğŸŒ Twi' : 'ğŸŒ EN';
  applyLanguage();
  ls('ges_lang', LANG);
  toast(LANG === 'tw' ? 'Kasa sesa â€” Twi! ğŸ‡¬ğŸ‡­' : 'Language changed to English!', 'success');
}

function applyLanguage() {
  const t = TRANSLATIONS[LANG] || TRANSLATIONS.en;
  // Update nav items with translations
  document.querySelectorAll('.nav-item').forEach(btn => {
    const onclick = btn.getAttribute('onclick') || '';
    const page = (onclick.match(/showPage\('([^']+)'\)/) || [])[1];
    if (page && t[page]) {
      const icon = btn.querySelector('.nav-icon')?.textContent || '';
      const badge = btn.querySelector('.nav-badge');
      btn.innerHTML = `<span class="nav-icon">${icon}</span> ${t[page]}`
        + (badge ? badge.outerHTML : '');
    }
  });
  // Update greeting
  const greetEl = eid('dash-greeting');
  if (greetEl) greetEl.textContent = t.welcome + ', ' + (USER_DOC?.name || '') + '! ğŸ‡¬ğŸ‡­';
}

// â”€â”€ 4. STUDENT PHOTOS â€” Device File System Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Photos saved as real files on the device using File System Access API.
// Falls back to download-based saving on iOS/unsupported browsers.
// Firebase is NOT used for photos â€” zero cost, full privacy on device.

let PHOTO_DIR_HANDLE = null;
let PHOTO_CACHE = {};
const PHOTO_FS_SUPPORTED = ('showDirectoryPicker' in window);

async function restorePhotoFolder() {
  try {
    const stored = await idbGet('ges_photo_folder');
    if (!stored) return;
    const perm = await stored.queryPermission({ mode: 'readwrite' });
    if (perm === 'granted') {
      PHOTO_DIR_HANDLE = stored;
      onFolderReady();
    } else {
      updateFolderUI('needs-permission', stored.name);
    }
  } catch(e) {}
}

function idbOpen() {
  return new Promise((res, rej) => {
    const req = indexedDB.open('GES_Photos', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('handles');
    req.onsuccess = e => res(e.target.result);
    req.onerror = e => rej(e.target.error);
  });
}
async function idbSet(key, val) {
  const db = await idbOpen();
  return new Promise((res, rej) => {
    const tx = db.transaction('handles', 'readwrite');
    tx.objectStore('handles').put(val, key);
    tx.oncomplete = res; tx.onerror = e => rej(e.target.error);
  });
}
async function idbGet(key) {
  const db = await idbOpen();
  return new Promise((res, rej) => {
    const tx = db.transaction('handles', 'readonly');
    const req = tx.objectStore('handles').get(key);
    req.onsuccess = e => res(e.target.result);
    req.onerror = e => rej(e.target.error);
  });
}

async function selectPhotoFolder() {
  if (!PHOTO_FS_SUPPORTED) {
    eid('photoFSAPIWarn').style.display = 'block';
    onFolderReady(true);
    return;
  }
  try {
    const handle = await window.showDirectoryPicker({ mode: 'readwrite', startIn: 'pictures' });
    PHOTO_DIR_HANDLE = handle;
    await idbSet('ges_photo_folder', handle);
    onFolderReady();
    toast('Folder linked: ' + handle.name + ' \u{1F4C1}', 'success');
  } catch(e) {
    if (e.name !== 'AbortError') toast('Could not open folder: ' + e.message, 'error');
  }
}

function onFolderReady(fallback) {
  const name = fallback ? 'Downloads (fallback mode)' : (PHOTO_DIR_HANDLE ? PHOTO_DIR_HANDLE.name : 'Selected');
  updateFolderUI('ready', name);
  eid('photoGridCard').style.display = 'block';
  renderPhotoGrid();
}

function updateFolderUI(state, name) {
  const nameEl = eid('photoFolderName');
  const changeBtn = eid('photoFolderChangeBtn');
  if (state === 'ready') {
    if (nameEl) nameEl.innerHTML = '<strong style="color:var(--accent2);">\u{1F4C1} ' + name + '</strong> \u2014 photos will be saved here.';
    if (changeBtn) changeBtn.style.display = 'inline-flex';
  } else if (state === 'needs-permission') {
    if (nameEl) nameEl.innerHTML = 'Previously linked: <strong>' + name + '</strong>. Click Choose Folder to reconnect.';
    if (changeBtn) changeBtn.style.display = 'inline-flex';
  }
}

function photoFileName(sid, studentName) {
  const safeName = studentName.replace(/[^a-zA-Z0-9 ]/g, '').trim().replace(/\s+/g, '_');
  return 'student_' + safeName + '_' + sid.slice(-6) + '.jpg';
}

async function readPhotoFromDevice(sid, studentName) {
  if (PHOTO_CACHE[sid]) return PHOTO_CACHE[sid];
  if (!PHOTO_DIR_HANDLE) return null;
  try {
    const fname = photoFileName(sid, studentName);
    const fileHandle = await PHOTO_DIR_HANDLE.getFileHandle(fname);
    const file = await fileHandle.getFile();
    const url = URL.createObjectURL(file);
    PHOTO_CACHE[sid] = url;
    return url;
  } catch(e) { return null; }
}

async function writePhotoToDevice(sid, studentName, file) {
  const fname = photoFileName(sid, studentName);
  if (PHOTO_DIR_HANDLE) {
    try {
      const fileHandle = await PHOTO_DIR_HANDLE.getFileHandle(fname, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(file);
      await writable.close();
      if (PHOTO_CACHE[sid]) URL.revokeObjectURL(PHOTO_CACHE[sid]);
      PHOTO_CACHE[sid] = URL.createObjectURL(file);
      return true;
    } catch(e) {
      toast('Folder save failed: ' + e.message + '. Downloading file instead.', 'error');
    }
  }
  // Fallback: trigger browser download
  const url = URL.createObjectURL(file);
  const a = document.createElement('a');
  a.href = url; a.download = fname; a.click();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
  PHOTO_CACHE[sid] = url;
  return true;
}

async function deletePhotoFromDevice(sid, studentName) {
  const fname = photoFileName(sid, studentName);
  if (PHOTO_DIR_HANDLE) {
    try { await PHOTO_DIR_HANDLE.removeEntry(fname); } catch(e) {}
  }
  if (PHOTO_CACHE[sid]) { URL.revokeObjectURL(PHOTO_CACHE[sid]); delete PHOTO_CACHE[sid]; }
}

async function renderPhotoGrid() {
  const el = eid('photoGrid');
  if (!el) return;
  const q = (eid('photoSearch') ? eid('photoSearch').value : '').toLowerCase();
  const filtered = STUDENTS.filter(s => s.name.toLowerCase().includes(q));

  if (!filtered.length) {
    el.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">\u{1F4F8}</div><h3>No students yet</h3><p>Add students first.</p></div>';
    return;
  }

  el.innerHTML = filtered.map(s => {
    const initials = s.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
    const sid = s.id;
    const sname = s.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    return `<div id="photocard_${sid}" class="photo-card" style="text-align:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;transition:border-color .2s;">
      <div id="photoimg_${sid}" style="width:86px;height:86px;border-radius:50%;overflow:hidden;margin:0 auto 10px;background:linear-gradient(135deg,var(--gh-green),var(--accent));display:flex;align-items:center;justify-content:center;">
        <span style="font-size:1.7rem;font-weight:800;color:#fff;">${initials}</span>
      </div>
      <div style="font-weight:700;font-size:.84rem;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.name}</div>
      <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">${s.gender} &middot; ${s.index || '&mdash;'}</div>
      <label style="cursor:pointer;display:block;">
        <span class="btn btn-sm btn-outline" id="photobtn_${sid}" style="font-size:.72rem;padding:4px 12px;">&#128247; Upload</span>
        <input type="file" accept="image/*" style="display:none;" data-sid="${sid}" data-name="${sname}" onchange="handlePhotoUpload(this)"/>
      </label>
      <button class="btn-icon" id="photodel_${sid}" data-sid="${sid}" data-name="${sname}" onclick="handlePhotoRemove(this)" style="display:none;margin:5px auto 0;font-size:.8rem;">&#128465;&#65039; Remove</button>
    </div>`;
  }).join('');

  // Load photos from device asynchronously
  for (const s of filtered) {
    const url = await readPhotoFromDevice(s.id, s.name);
    if (url) setPhotoCardImage(s.id, url);
  }
}

function handlePhotoUpload(input) {
  const sid = input.dataset.sid;
  const name = input.dataset.name;
  uploadStudentPhoto(sid, name, input);
}

function handlePhotoRemove(btn) {
  const sid = btn.dataset.sid;
  const name = btn.dataset.name;
  removeStudentPhoto(sid, name);
}

function setPhotoCardImage(sid, url) {
  const imgWrap = eid('photoimg_' + sid);
  const btn = eid('photobtn_' + sid);
  const delBtn = eid('photodel_' + sid);
  if (imgWrap) imgWrap.innerHTML = '<img src="' + url + '" style="width:100%;height:100%;object-fit:cover;"/>';
  if (btn) btn.textContent = '\u{1F504} Change';
  if (delBtn) delBtn.style.display = 'block';
}

function compressImage(file, maxDim, quality) {
  return new Promise(res => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        const ratio = Math.min(maxDim / w, maxDim / h);
        w = Math.round(w * ratio); h = Math.round(h * ratio);
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => res(blob), 'image/jpeg', quality);
    };
    img.src = url;
  });
}

async function uploadStudentPhoto(sid, name, input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 10000000) return toast('Photo too large. Please use under 10MB.', 'error');
  const compressed = await compressImage(file, 800, 0.82);
  const ok = await writePhotoToDevice(sid, name, compressed);
  if (ok) {
    setPhotoCardImage(sid, PHOTO_CACHE[sid]);
    toast(name + "'s photo saved to device! \u{1F4F8}", 'success');
  }
}

async function removeStudentPhoto(sid, name) {
  confirm2("Remove " + name + "'s photo from device?", async () => {
    await deletePhotoFromDevice(sid, name);
    const imgWrap = eid('photoimg_' + sid);
    const btn = eid('photobtn_' + sid);
    const delBtn = eid('photodel_' + sid);
    const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
    if (imgWrap) imgWrap.innerHTML = '<span style="font-size:1.7rem;font-weight:800;color:#fff;">' + initials + '</span>';
    if (btn) btn.textContent = '\u{1F4F7} Upload';
    if (delBtn) delBtn.style.display = 'none';
    toast('Photo removed from device.', 'info');
  });
}

async function exportAllPhotos() {
  if (!PHOTO_DIR_HANDLE) return toast('No folder selected yet.', 'error');
  toast('Photos already live in your selected folder \u{1F4C1}', 'info');
}

window.addEventListener('resize', () => {
  if (eid('page-dashboard').classList.contains('active')) renderDashboard();
  if (eid('page-analysis').classList.contains('active')) renderAnalysis();
});

// Set today's date on assessment form
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0];
  const el = eid('aDate'); if(el) el.value = today;
  // Set default year in auto-index format
  const yearEl = eid('idxYear');
  if (yearEl && !yearEl.value) yearEl.value = new Date().getFullYear();
  updateIndexPreview();
});


// â”€â”€ BOTTOM NAV: hide on scroll down, show on scroll up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  var lastY = 0;
  var nav = null;
  var ticking = false;

  function initScrollHide() {
    nav = document.getElementById('mobileBottomNav');
    var scroller = document.querySelector('.content');
    if (!scroller || !nav) return;

    scroller.addEventListener('scroll', function() {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(function() {
        var y = scroller.scrollTop;
        var diff = y - lastY;
        // Only trigger after meaningful scroll (>6px) to avoid jitter
        if (Math.abs(diff) > 6) {
          if (diff > 0 && y > 80) {
            // Scrolling DOWN â€” hide nav
            nav.classList.add('hidden');
          } else {
            // Scrolling UP or near top â€” show nav
            nav.classList.remove('hidden');
          }
          lastY = y;
        }
        ticking = false;
      });
    }, { passive: true });
  }

  // Run once app is visible
  document.addEventListener('DOMContentLoaded', function() {
    // Wait for app to render
    var observer = new MutationObserver(function(mutations, obs) {
      if (document.getElementById('mobileBottomNav')) {
        initScrollHide();
        obs.disconnect();
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    // Also try immediately in case DOM is ready
    initScrollHide();
  });
})();

</script>
<!-- â•â•â•â•â• MOBILE BOTTOM NAV â•â•â•â•â• -->
<nav id="mobileBottomNav">
  <button class="mob-nav-item active" onclick="showPage('dashboard');closeMobNav(this)" data-page="dashboard">
    <span class="mob-icon">ğŸ“Š</span>Home
  </button>
  <button class="mob-nav-item" onclick="showPage('students');closeMobNav(this)" data-page="students">
    <span class="mob-icon">ğŸ‘¨â€ğŸ“</span>Students
  </button>
  <button class="mob-nav-item" onclick="showPage('scores');closeMobNav(this)" data-page="scores">
    <span class="mob-icon">âœï¸</span>Scores
  </button>
  <button class="mob-nav-item" onclick="showPage('results');closeMobNav(this)" data-page="results">
    <span class="mob-icon">ğŸ†</span>Results
  </button>
  <button class="mob-nav-item" onclick="toggleSidebar()" id="mobMoreBtn">
    <span class="mob-icon">â˜°</span>More
    <span class="mob-nav-badge" id="mobMoreBadge" style="display:none;">!</span>
  </button>
</nav>

</body>
</html>
